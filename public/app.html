<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Tarefas Escolares</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.2); }
        .btn-primary { background-color: #CC0000; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #A00000; }
        .btn-secondary { background-color: #d1d5db; color: #1e1e1e; padding: 10px 20px; border-radius: 8px; font-weight: 600; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: #9ca3af; }
        input[type="email"], input[type="text"], input[type="url"], input[type="date"], textarea, select {
            border: 1px solid #d1d5db; padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box;
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus, select:focus { border-color: #CC0000; outline: none; }
        .info-box { background-color: #eff6ff; color: #1e40af; border-left: 4px solid #3b82f6; padding: 12px; border-radius: 8px; margin-bottom: 20px; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex justify-center items-start">

    <div id="app-container" class="w-full max-w-4xl">

        <!-- Banner de Status de Persistência -->
        <div class="info-box bg-red-100 text-red-800 border-red-500">
            <strong>PERSISTÊNCIA CRÍTICA:</strong> As ações de escrita (Criar Tarefa e Entregar Arquivo) são **temporárias** até você configurar o Apps Script. Por favor, cole o **URL do Web App** no código e finalize o *deploy*.
        </div>

        <!-- Tela de Login -->
        <div id="login-screen" class="card p-6 md:p-10 transition-opacity duration-300">
            <h1 class="text-3xl font-bold text-red-800 mb-6 text-center">Acesso ao Sistema de Tarefas</h1>
            <div id="loading-users" class="text-center text-gray-500 mb-4">Carregando lista de usuários da Planilha...</div>
            <div id="login-error" class="text-red-500 mb-4 hidden text-center"></div>

            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">E-mail</label>
            <input type="email" id="email" class="mb-4" placeholder="seu.email@escola.com.br">

            <label for="ra" class="block text-sm font-medium text-gray-700 mb-1">Registro Acadêmico (RA)</label>
            <input type="text" id="ra" class="mb-6" placeholder="Apenas o número do seu RA">

            <button onclick="handleLogin()" id="login-button" class="btn-primary w-full disabled:opacity-50" disabled>
                Entrar
            </button>
        </div>

        <!-- Dashboard (Visível após o login) -->
        <div id="dashboard" class="hidden transition-opacity duration-300">
            <header class="flex justify-between items-center mb-6 p-4 card bg-gray-50">
                <h2 id="welcome-message" class="text-xl font-semibold text-gray-800"></h2>
                <button onclick="logout()" class="text-sm text-red-500 hover:text-red-700 font-medium">Sair</button>
            </header>

            <div id="professor-view" class="hidden">
                <!-- Seção Criar Nova Tarefa -->
                <div class="mb-8 p-6 card border-t-4 border-red-500">
                    <h3 class="text-2xl font-bold mb-4 text-red-700">Criar Nova Tarefa</h3>
                    <label for="task-title" class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                    <input type="text" id="task-title" class="mb-3" placeholder="Ex: Relatório de Biologia">

                    <label for="task-description" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                    <textarea id="task-description" rows="3" class="mb-3" placeholder="Detalhes da tarefa e instruções."></textarea>

                    <label for="task-class" class="block text-sm font-medium text-gray-700 mb-1">Turma</label>
                    <select id="task-class" class="mb-3">
                        <option value="Todos">Todas as Turmas</option>
                        <!-- Turmas serão carregadas aqui -->
                    </select>

                    <label for="task-deadline" class="block text-sm font-medium text-gray-700 mb-1">Prazo de Entrega</label>
                    <input type="date" id="task-deadline" class="mb-4">

                    <button onclick="createTask()" class="btn-primary">Publicar Tarefa</button>
                    <div id="task-message" class="text-green-600 mt-2 hidden"></div>
                </div>

                <div class="p-6 card">
                    <h3 class="text-2xl font-bold mb-4 text-gray-700">Acompanhamento e Entregas</h3>
                    <div id="professor-tasks-list" class="space-y-4">
                        <!-- Lista de tarefas e entregas -->
                    </div>
                </div>
            </div>

            <div id="student-view" class="hidden">
                <div class="p-6 card">
                    <h3 class="text-2xl font-bold mb-4 text-gray-700">Minhas Tarefas Pendentes</h3>
                    <div id="student-tasks-list" class="space-y-4">
                        <!-- Lista de tarefas do aluno -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Confirmação (Substitui alert/confirm) -->
        <div id="app-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4">
            <div class="card p-6 w-full max-w-sm">
                <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-800"></h3>
                <p id="modal-body" class="mb-6 text-gray-700"></p>
                <button onclick="closeModal()" class="btn-primary w-full">Fechar</button>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIGURAÇÃO DA PLANILHA ---
        // ID da sua Planilha Google (extraído do link fornecido)
        const SPREADSHEET_ID = '1wgJgs3HcEVkB4_IF_bD83XcaRkw53j7z'; 

        // URL de Deploy do Google Apps Script (Backend de Escrita)
        // Por favor, substitua este placeholder pelo URL REAL obtido após a publicação do Apps Script.
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwwhih1WYboZUc12jj5FTvinmqqm5O9_gB8R6z7NcU1b5Dl_fiGx_bYL2ErFQsBy0MtAQ/exec'; 

        // Nomes das abas (sheets) que o código espera encontrar na Planilha
        const SHEET_NAMES = {
            USERS: 'USERS',
            TAREFAS: 'TAREFAS',
            ENTREGAS: 'ENTREGAS'
        };

        // Colunas na aba USERS (ORDEM CORRIGIDA para o seu Sheets)
        // Nova ordem que você forneceu: NomeCompleto, Email, RA, Turma
        const USER_COLUMNS = ['NomeCompleto', 'Email', 'RA', 'Turma', 'Perfil'];
        
        // Colunas nas abas de Escrita (para sincronizar com o Apps Script)
        const TASK_HEADERS = ['ID', 'ProfessorEmail', 'Título', 'Descrição', 'Turma', 'Prazo', 'DataPublicacao'];
        const SUBMISSION_HEADERS = ['ID', 'TarefaID', 'RAAluno', 'Link', 'DataEntrega', 'Status'];


        // --- VARIÁVEIS GLOBAIS DE ESTADO ---
        let currentUser = null;
        let allUsers = [];
        let allTasks = [];
        let allSubmissions = []; 
        
        let taskIdCounter = 1; 
        let submissionIdCounter = 1; 


        // --- FUNÇÕES DE UTILIDADE ---

        function getSheetReadUrl(sheetName) {
            return `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${sheetName}`;
        }

        function openModal(title, body) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = body;
            document.getElementById('app-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('app-modal').classList.add('hidden');
            // Garante que o botão de fechar volte ao normal após submissão do formulário modal
            document.querySelector('#app-modal button[onclick="closeModal()"]').classList.remove('hidden');
        }

        // --- FUNÇÕES DE LEITURA E PARSE DE DADOS (Google Sheets) ---

        /**
         * LÊ OS DADOS DA PLANILHA
         */
        async function fetchSheetData(sheetName, headers) {
            const url = getSheetReadUrl(sheetName);
            try {
                const response = await fetch(url);
                const text = await response.text();
                
                const jsonStart = text.indexOf('{');
                const jsonEnd = text.lastIndexOf('}');
                if (jsonStart === -1 || jsonEnd === -1) {
                    throw new Error("Formato de resposta inválido do Google Sheets.");
                }
                const jsonString = text.substring(jsonStart, jsonEnd + 1);
                const data = JSON.parse(jsonString);

                const rows = data.table.rows;
                const result = [];

                rows.forEach((row, index) => {
                    // Ignora a linha de cabeçalho
                    if (index === 0 && data.table.cols.length > 0 && data.table.cols[0].label) return; 

                    const item = {};
                    row.c.forEach((cell, cellIndex) => {
                        const headerName = headers[cellIndex];
                        if (headerName && cell && cell.v !== undefined) {
                            item[headerName] = cell.v;
                        } else if (headerName && cell && cell.f !== undefined) {
                            item[headerName] = cell.f; 
                        }
                    });
                    
                    if (Object.keys(item).length > 0) {
                        // Mapeamento interno para o código JS:
                        const mappedItem = {
                            Nome: item.NomeCompleto || item.Nome, // Usa NomeCompleto
                            Email: item.Email,
                            // FIX: Verifica se item.RA existe antes de chamar toString()
                            RA: item.RA ? item.RA.toString() : '', 
                            // Lógica de Perfil: Se Turma existir, é ALUNO, senão é PROFESSOR.
                            Perfil: (item.Perfil || (item.Turma ? 'ALUNO' : 'PROFESSOR')).toUpperCase(), 
                            Turma: item.Turma,
                            // FIX: Verifica se item.ID existe antes de chamar toString()
                            ID: item.ID ? item.ID.toString() : '', 
                            ProfessorEmail: item.ProfessorEmail || item.Professor,
                            Título: item.Título || item.Title,
                            Descrição: item.Descrição || item.Description,
                            Prazo: item.Prazo,
                            DataPublicacao: item.DataPublicacao || item.Data
                        };
                        result.push(mappedItem);
                    }
                });

                return result;

            } catch (error) {
                console.error(`Erro ao carregar dados da aba ${sheetName}:`, error);
                throw new Error(`Não foi possível carregar os dados. Verifique o ID, o nome da aba (${sheetName}) e o compartilhamento da planilha. Detalhe: ${error.message}`);
            }
        }

        /**
         * Chama a API do Apps Script para operações de escrita.
         */
        async function callAppsScript(action, payload) {
            if (APPS_SCRIPT_URL === 'SEU_APPS_SCRIPT_WEB_APP_URL') {
                 throw new Error("URL do Apps Script não configurada! A escrita será perdida.");
            }
            
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, payload })
            });
            const data = await response.json();
            
            if (data.status === 'error') {
                throw new Error(data.message);
            }
            return data.data;
        }


        /**
         * Carrega todos os dados necessários para a aplicação.
         */
        async function loadInitialData() {
            const loadingElement = document.getElementById('loading-users');
            const loginButton = document.getElementById('login-button');
            try {
                // Usuários
                loadingElement.textContent = "Carregando usuários...";
                allUsers = await fetchSheetData(SHEET_NAMES.USERS, USER_COLUMNS);
                
                // Tarefas
                loadingElement.textContent = "Carregando tarefas existentes...";
                allTasks = await fetchSheetData(SHEET_NAMES.TAREFAS, TASK_HEADERS);
                if (allTasks.length > 0) {
                    const maxId = allTasks.reduce((max, task) => Math.max(max, parseInt(task.ID) || 0), 0);
                    taskIdCounter = maxId + 1;
                }
                
                // Entregas
                loadingElement.textContent = "Carregando entregas existentes...";
                allSubmissions = await fetchSheetData(SHEET_NAMES.ENTREGAS, SUBMISSION_HEADERS);
                if (allSubmissions.length > 0) {
                    const maxId = allSubmissions.reduce((max, sub) => Math.max(max, parseInt(sub.ID) || 0), 0);
                    submissionIdCounter = maxId + 1;
                }

                loadingElement.textContent = "Dados carregados com sucesso. Pronto para o login.";
                loginButton.disabled = false;
                populateTaskClasses();
                checkAuthStatus(); // Verifica se há sessão após o carregamento

            } catch (error) {
                document.getElementById('login-error').textContent = `Erro Fatal: ${error.message}`;
                document.getElementById('login-error').classList.remove('hidden');
                loadingElement.textContent = "Falha ao carregar os dados. Verifique o console para mais detalhes.";
            }
        }

        // --- FUNÇÕES DE AUTENTICAÇÃO (SIMULADA) ---
        function handleLogin() {
            const email = document.getElementById('email').value.trim().toLowerCase();
            const ra = document.getElementById('ra').value.trim();
            const loginError = document.getElementById('login-error');
            loginError.classList.add('hidden');

            const user = allUsers.find(u => 
                u.Email.toLowerCase() === email && 
                u.RA.toString() === ra
            );

            if (user) {
                currentUser = {
                    ...user,
                    RA: user.RA.toString(),
                    Perfil: user.Perfil.toUpperCase(),
                    Nome: user.NomeCompleto || user.Nome 
                };
                
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                showDashboard();
            } else {
                loginError.textContent = "E-mail ou RA incorretos. Tente novamente.";
                loginError.classList.remove('hidden');
            }
        }

        function showDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            document.getElementById('welcome-message').textContent = `Olá, ${currentUser.Nome} (${currentUser.Perfil})`;

            if (currentUser.Perfil === 'PROFESSOR') {
                document.getElementById('professor-view').classList.remove('hidden');
                document.getElementById('student-view').classList.add('hidden');
                renderProfessorView();
            } else if (currentUser.Perfil === 'ALUNO') {
                document.getElementById('professor-view').classList.add('hidden');
                document.getElementById('student-view').classList.remove('hidden');
                renderStudentView();
            } else {
                openModal("Erro de Perfil", "Seu perfil de usuário é desconhecido. Entre em contato com o administrador.");
                logout();
            }
        }

        function logout() {
            currentUser = null;
            sessionStorage.removeItem('currentUser');
            document.getElementById('email').value = '';
            document.getElementById('ra').value = '';
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('professor-view').classList.add('hidden');
            document.getElementById('student-view').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }

        function checkAuthStatus() {
            const storedUser = sessionStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                currentUser.Perfil = currentUser.Perfil.toUpperCase(); 
                showDashboard();
            }
        }

        // --- FUNÇÕES DA VISÃO DO PROFESSOR ---

        function populateTaskClasses() {
            const classSelect = document.getElementById('task-class');
            classSelect.innerHTML = '<option value="Todos">Todas as Turmas</option>'; 
            
            const classes = new Set(allUsers
                .filter(u => u.Perfil === 'ALUNO' && u.Turma)
                .map(u => u.Turma)
            );
            
            classes.forEach(c => {
                const option = document.createElement('option');
                option.value = c;
                option.textContent = c;
                classSelect.appendChild(option);
            });
        }

        /**
         * Cria uma nova tarefa (Escreve via Apps Script).
         */
        async function createTask() {
            const title = document.getElementById('task-title').value.trim();
            const description = document.getElementById('task-description').value.trim();
            const taskClass = document.getElementById('task-class').value;
            const deadline = document.getElementById('task-deadline').value;
            const messageElement = document.getElementById('task-message');
            
            if (!title || !description || !deadline) {
                openModal("Campos Obrigatórios", "Por favor, preencha o Título, a Descrição e o Prazo.");
                return;
            }

            const payload = {
                ProfessorEmail: currentUser.Email,
                Título: title,
                Descrição: description,
                Turma: taskClass,
                Prazo: deadline,
                DataPublicacao: new Date().toLocaleDateString('pt-BR')
            };
            
            try {
                // Chama Apps Script para persistência
                const result = await callAppsScript('CREATE_TASK', payload);
                
                // Simulação: Adiciona à lista em memória (Para o professor ver imediatamente, mas exige refresh para persistir)
                allTasks.push({ ...payload, ID: result.newId.toString() }); 

                document.getElementById('task-title').value = '';
                document.getElementById('task-description').value = '';
                document.getElementById('task-deadline').value = '';
                
                messageElement.textContent = `Tarefa "${title}" publicada com sucesso (ID: ${result.newId}). Atualize a página para ver a persistência.`;
                messageElement.classList.remove('hidden');
                setTimeout(() => messageElement.classList.add('hidden'), 8000);

                renderProfessorView();
            } catch (error) {
                openModal("Erro de Persistência", `Falha ao salvar a tarefa. Detalhe: ${error.message}. Verifique se o Apps Script está publicado e a URL configurada.`);
            }
        }

        /**
         * Renderiza a lista de tarefas e submissões para o professor.
         */
        function renderProfessorView() {
            const container = document.getElementById('professor-tasks-list');
            container.innerHTML = '';
            
            const professorTasks = allTasks.filter(t => t.ProfessorEmail === currentUser.Email);

            if (professorTasks.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Nenhuma tarefa publicada por você até o momento.</p>';
                return;
            }

            professorTasks.forEach(task => {
                const taskSubmissions = allSubmissions.filter(s => parseInt(s.TarefaID) === parseInt(task.ID));

                const taskElement = document.createElement('div');
                taskElement.className = 'border p-4 rounded-lg bg-white mb-4';
                taskElement.innerHTML = `
                    <h4 class="text-lg font-bold text-red-600">${task.Título} (Turma: ${task.Turma})</h4>
                    <p class="text-sm text-gray-500 mb-2">Prazo: ${task.Prazo}</p>
                    <p class="mb-3">${task.Descrição}</p>
                    
                    <p class="text-md font-semibold mt-4">Entregas (${taskSubmissions.length})</p>
                    <div class="space-y-2 max-h-48 overflow-y-auto mt-2">
                        ${taskSubmissions.length === 0 
                            ? '<p class="text-sm text-gray-500">Nenhuma entrega recebida ainda.</p>'
                            : taskSubmissions.map(sub => `
                                <div class="p-2 border rounded-md bg-gray-50 flex justify-between items-center">
                                    <span class="text-sm font-medium">RA: ${sub.RAAluno}</span>
                                    <a href="${sub.Link}" target="_blank" class="text-red-500 hover:underline text-sm">Ver Arquivo</a>
                                </div>
                            `).join('')
                        }
                    </div>
                `;
                container.appendChild(taskElement);
            });
        }

        // --- FUNÇÕES DA VISÃO DO ALUNO ---

        /**
         * Renderiza a lista de tarefas disponíveis para o aluno.
         */
        function renderStudentView() {
            const container = document.getElementById('student-tasks-list');
            container.innerHTML = '';

            const studentTasks = allTasks.filter(t => 
                t.Turma === 'Todos' || t.Turma === currentUser.Turma
            ).sort((a, b) => new Date(a.Prazo) - new Date(b.Prazo));

            if (studentTasks.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Nenhuma tarefa disponível para sua turma no momento.</p>';
                return;
            }

            studentTasks.forEach(task => {
                const isSubmitted = allSubmissions.some(s => 
                    parseInt(s.TarefaID) === parseInt(task.ID) && s.RAAluno === currentUser.RA
                );
                
                const taskElement = document.createElement('div');
                taskElement.className = 'border p-4 rounded-lg bg-white flex flex-col md:flex-row justify-between items-start md:items-center';
                
                const deadlineDate = new Date(task.Prazo);
                const isLate = deadlineDate < new Date() && !isSubmitted;
                
                taskElement.innerHTML = `
                    <div class="flex-grow mb-3 md:mb-0">
                        <h4 class="text-lg font-bold text-gray-800">${task.Título}</h4>
                        <p class="text-sm text-gray-600 mb-2">${task.Descrição}</p>
                        <p class="text-xs font-medium ${isLate ? 'text-red-500' : 'text-gray-500'}">
                            Prazo: ${task.Prazo} ${isLate ? ' (ATRASADO)' : ''}
                        </p>
                    </div>
                    <div class="w-full md:w-auto flex flex-col space-y-2 md:space-y-0 md:space-x-2">
                        ${isSubmitted 
                            ? `<button class="btn-secondary w-full md:w-auto opacity-70 cursor-not-allowed" disabled>Entregue</button>`
                            : `<button onclick="showSubmissionForm(${task.ID}, '${task.Título}')" class="btn-primary w-full md:w-auto">Entregar Arquivo</button>`
                        }
                    </div>
                `;
                container.appendChild(taskElement);
            });
        }

        function showSubmissionForm(taskId, taskTitle) {
            const bodyContent = `
                <p class="mb-4">Insira o link para o seu arquivo PDF ou DOC (Ex: Google Drive, Dropbox).</p>
                <input type="url" id="submission-link" class="mb-4" placeholder="URL do Arquivo (Ex: https://drive.google.com/...)">
                <button onclick="submitTask(${taskId})" class="btn-primary w-full">Confirmar Entrega</button>
                <div id="submission-message" class="text-red-500 mt-2 hidden"></div>
            `;
            
            document.getElementById('modal-title').textContent = `Entrega: ${taskTitle}`;
            document.getElementById('modal-body').innerHTML = bodyContent;
            document.getElementById('app-modal').classList.remove('hidden');
            
            document.querySelector('#app-modal button[onclick="closeModal()"]').classList.add('hidden');
        }

        /**
         * Envia a tarefa (Escreve via Apps Script).
         */
        async function submitTask(taskId) {
            const link = document.getElementById('submission-link').value.trim();
            const messageElement = document.getElementById('submission-message');
            messageElement.classList.add('hidden');
            
            if (!link || !link.startsWith('http')) {
                messageElement.textContent = "Por favor, insira um link válido (começando com http).";
                messageElement.classList.remove('hidden');
                return;
            }

            const payload = {
                TarefaID: taskId.toString(),
                RAAluno: currentUser.RA,
                Link: link,
                DataEntrega: new Date().toLocaleDateString('pt-BR'),
                Status: 'Entregue'
            };
            
            try {
                // Chama Apps Script para persistência
                const result = await callAppsScript('SUBMIT_DELIVERY', payload);
                
                // Adiciona à lista em memória para ver imediatamente (mas requer refresh para persistir)
                allSubmissions.push({ ...payload, ID: result.newId.toString() }); 

                // Mensagem de sucesso
                document.querySelector('#app-modal button[onclick="closeModal()"]').classList.remove('hidden');
                closeModal();
                openModal("Sucesso!", `Entrega registrada! Atualize a página para confirmar a persistência na Planilha.`);

                renderStudentView(); // Atualiza o dashboard do aluno
            } catch (error) {
                document.querySelector('#app-modal button[onclick="closeModal()"]').classList.remove('hidden');
                openModal("Erro de Entrega", `Falha ao registrar entrega. Detalhe: ${error.message}`);
            }
        }

        // --- INICIALIZAÇÃO ---

        loadInitialData();
        checkAuthStatus();
    </script>
</body>
</html>
