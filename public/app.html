<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Tarefas Escolares</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .btn-primary { background-color: #3b82f6; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #d1d5db; color: #1f2937; padding: 10px 20px; border-radius: 8px; font-weight: 600; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: #9ca3af; }
        input[type="email"], input[type="text"], textarea, select {
            border: 1px solid #d1d5db; padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box;
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus, select:focus { border-color: #3b82f6; outline: none; }
        .info-box { background-color: #eff6ff; color: #1e40af; border-left: 4px solid #3b82f6; padding: 12px; border-radius: 8px; margin-bottom: 20px; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex justify-center items-start">

    <div id="app-container" class="w-full max-w-4xl">

        <!-- Banner de Status de Persistência -->
        <div class="info-box bg-red-100 text-red-800 border-red-500">
            <strong>ATENÇÃO:</strong> As ações de escrita (Criar Tarefa e Entregar Arquivo) são **temporárias** e só existem nesta sessão. Para persistência real dos dados, seria necessário usar o Google Apps Script para escrever na planilha.
        </div>

        <!-- Tela de Login -->
        <div id="login-screen" class="card p-6 md:p-10 transition-opacity duration-300">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Acesso ao Sistema</h1>
            <div id="loading-users" class="text-center text-gray-500 mb-4">Carregando lista de usuários da Planilha...</div>
            <div id="login-error" class="text-red-500 mb-4 hidden text-center"></div>

            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">E-mail</label>
            <input type="email" id="email" class="mb-4" placeholder="seu.email@escola.com.br">

            <label for="ra" class="block text-sm font-medium text-gray-700 mb-1">Registro Acadêmico (RA)</label>
            <input type="text" id="ra" class="mb-6" placeholder="Apenas o número do seu RA">

            <button onclick="handleLogin()" id="login-button" class="btn-primary w-full disabled:opacity-50" disabled>
                Entrar
            </button>
        </div>

        <!-- Dashboard (Visível após o login) -->
        <div id="dashboard" class="hidden transition-opacity duration-300">
            <header class="flex justify-between items-center mb-6 p-4 card bg-gray-50">
                <h2 id="welcome-message" class="text-xl font-semibold text-gray-800"></h2>
                <button onclick="logout()" class="text-sm text-red-500 hover:text-red-700 font-medium">Sair</button>
            </header>

            <div id="professor-view" class="hidden">
                <div class="mb-8 p-6 card">
                    <h3 class="text-2xl font-bold mb-4 text-gray-700">Criar Nova Tarefa</h3>
                    <label for="task-title" class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                    <input type="text" id="task-title" class="mb-3" placeholder="Ex: Relatório de Biologia">

                    <label for="task-description" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                    <textarea id="task-description" rows="3" class="mb-3" placeholder="Detalhes da tarefa e instruções."></textarea>

                    <label for="task-class" class="block text-sm font-medium text-gray-700 mb-1">Turma</label>
                    <select id="task-class" class="mb-3">
                        <option value="Todos">Todas as Turmas</option>
                        <!-- Turmas serão carregadas aqui -->
                    </select>

                    <label for="task-deadline" class="block text-sm font-medium text-gray-700 mb-1">Prazo de Entrega</label>
                    <input type="date" id="task-deadline" class="mb-4">

                    <button onclick="createTask()" class="btn-primary">Publicar Tarefa</button>
                    <div id="task-message" class="text-green-600 mt-2 hidden"></div>
                </div>

                <div class="p-6 card">
                    <h3 class="text-2xl font-bold mb-4 text-gray-700">Acompanhamento e Entregas</h3>
                    <div id="professor-tasks-list" class="space-y-4">
                        <!-- Lista de tarefas e entregas -->
                    </div>
                </div>
            </div>

            <div id="student-view" class="hidden">
                <div class="p-6 card">
                    <h3 class="text-2xl font-bold mb-4 text-gray-700">Minhas Tarefas Pendentes</h3>
                    <div id="student-tasks-list" class="space-y-4">
                        <!-- Lista de tarefas do aluno -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Confirmação (Substitui alert/confirm) -->
        <div id="app-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4">
            <div class="card p-6 w-full max-w-sm">
                <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-800"></h3>
                <p id="modal-body" class="mb-6 text-gray-700"></p>
                <button onclick="closeModal()" class="btn-primary w-full">Fechar</button>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIGURAÇÃO DA PLANILHA ---
        // ID da sua Planilha Google (extraído do link fornecido)
        const SPREADSHEET_ID = '1wgJgs3HcEVkB4_IF_bD83XcaRkw53j7z'; 

        // Nomes das abas (sheets) que o código espera encontrar na Planilha
        const SHEET_NAMES = {
            USERS: 'USERS',
            TAREFAS: 'TAREFAS',
            ENTREGAS: 'ENTREGAS'
        };

        // --- VARIÁVEIS GLOBAIS DE ESTADO ---
        let currentUser = null;
        let allUsers = [];
        let allTasks = [];
        let allSubmissions = []; // Simulação: armazena submissões na sessão
        
        // Colunas esperadas na aba USERS:
        const USER_COLUMNS = ['RA', 'Email', 'Nome', 'Perfil', 'Turma'];

        // Colunas esperadas na aba TAREFAS (ID, Professor, Título, Descrição, Turma, Prazo)
        let taskIdCounter = 1; // Contador para novos IDs de tarefa (apenas na sessão)

        // Colunas esperadas na aba ENTREGAS (TaskId, StudentRA, Link, DataEntrega, Status)
        let submissionIdCounter = 1; // Contador para novos IDs de submissão (apenas na sessão)

        // --- FUNÇÕES DE UTILIDADE ---

        /**
         * Constrói a URL para leitura pública de dados no formato JSON.
         * @param {string} sheetName - O nome da aba (sheet) a ser lida.
         */
        function getSheetReadUrl(sheetName) {
            return `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${sheetName}`;
        }

        /**
         * Abre o modal com uma mensagem.
         * @param {string} title - Título do modal.
         * @param {string} body - Corpo da mensagem.
         */
        function openModal(title, body) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = body;
            document.getElementById('app-modal').classList.remove('hidden');
        }

        /**
         * Fecha o modal.
         */
        function closeModal() {
            document.getElementById('app-modal').classList.add('hidden');
        }

        // --- FUNÇÕES DE LEITURA E PARSE DE DADOS (Google Sheets) ---

        /**
         * Lê e parseia os dados de uma aba específica da Planilha.
         * @param {string} sheetName - O nome da aba (sheet) a ser lida.
         * @param {string[]} headers - Array com os nomes das colunas esperadas.
         * @returns {Promise<Array>} - Promessa com os dados lidos.
         */
        async function fetchSheetData(sheetName, headers) {
            const url = getSheetReadUrl(sheetName);
            try {
                const response = await fetch(url);
                const text = await response.text();
                
                // O Sheets retorna um JSON encapsulado em uma função 'google.visualization.Query.setResponse'
                const jsonStart = text.indexOf('{');
                const jsonEnd = text.lastIndexOf('}');
                if (jsonStart === -1 || jsonEnd === -1) {
                    throw new Error("Formato de resposta inválido do Google Sheets.");
                }
                const jsonString = text.substring(jsonStart, jsonEnd + 1);
                const data = JSON.parse(jsonString);

                const rows = data.table.rows;
                const result = [];

                rows.forEach((row, index) => {
                    // Ignora a primeira linha se for o cabeçalho
                    if (index === 0 && data.table.cols.length > 0 && data.table.cols[0].label) return; 

                    const item = {};
                    row.c.forEach((cell, cellIndex) => {
                        if (headers[cellIndex] && cell && cell.v !== undefined) {
                            item[headers[cellIndex]] = cell.v;
                        } else if (headers[cellIndex] && cell && cell.f !== undefined) {
                             // Usa o valor formatado se o 'v' for undefined (útil para datas)
                            item[headers[cellIndex]] = cell.f; 
                        }
                    });
                    
                    // Adiciona um ID para tarefas e submissões lidas inicialmente
                    if (sheetName === SHEET_NAMES.TAREFAS && !item.ID) {
                        item.ID = taskIdCounter++;
                    }
                    if (sheetName === SHEET_NAMES.ENTREGAS && !item.ID) {
                        item.ID = submissionIdCounter++;
                    }
                    
                    if (Object.keys(item).length > 0) {
                        result.push(item);
                    }
                });

                return result;

            } catch (error) {
                console.error(`Erro ao carregar dados da aba ${sheetName}:`, error);
                throw new Error(`Não foi possível carregar os dados. Verifique o ID, o nome da aba (${sheetName}) e o compartilhamento da planilha. Detalhe: ${error.message}`);
            }
        }

        /**
         * Carrega todos os dados necessários para a aplicação.
         */
        async function loadInitialData() {
            const loadingElement = document.getElementById('loading-users');
            const loginButton = document.getElementById('login-button');
            try {
                loadingElement.textContent = "Carregando usuários...";
                allUsers = await fetchSheetData(SHEET_NAMES.USERS, USER_COLUMNS);
                
                // Hardcode as colunas de TAREFAS e ENTREGAS se não conseguirmos ler
                const taskHeaders = ['ID', 'ProfessorEmail', 'Título', 'Descrição', 'Turma', 'Prazo'];
                const submissionHeaders = ['ID', 'TarefaID', 'RAAluno', 'Link', 'DataEntrega', 'Status'];

                loadingElement.textContent = "Carregando tarefas existentes...";
                allTasks = await fetchSheetData(SHEET_NAMES.TAREFAS, taskHeaders);
                // Ajusta o contador de ID para novas tarefas
                if (allTasks.length > 0) {
                    const maxId = allTasks.reduce((max, task) => Math.max(max, parseInt(task.ID) || 0), 0);
                    taskIdCounter = maxId + 1;
                }
                
                loadingElement.textContent = "Carregando entregas existentes...";
                allSubmissions = await fetchSheetData(SHEET_NAMES.ENTREGAS, submissionHeaders);
                // Ajusta o contador de ID para novas submissões
                if (allSubmissions.length > 0) {
                    const maxId = allSubmissions.reduce((max, sub) => Math.max(max, parseInt(sub.ID) || 0), 0);
                    submissionIdCounter = maxId + 1;
                }

                loadingElement.textContent = "Dados carregados com sucesso. Pronto para o login.";
                loginButton.disabled = false;
                
                // Carrega as turmas no seletor de criação de tarefas
                populateTaskClasses();

            } catch (error) {
                document.getElementById('login-error').textContent = `Erro Fatal: ${error.message}`;
                document.getElementById('login-error').classList.remove('hidden');
                loadingElement.textContent = "Falha ao carregar os dados. Verifique o console para mais detalhes.";
            }
        }

        // --- FUNÇÕES DE AUTENTICAÇÃO (SIMULADA) ---

        /**
         * Lida com o processo de login usando o email e RA.
         */
        function handleLogin() {
            const email = document.getElementById('email').value.trim().toLowerCase();
            const ra = document.getElementById('ra').value.trim();
            const loginError = document.getElementById('login-error');
            loginError.classList.add('hidden');

            const user = allUsers.find(u => 
                u.Email.toLowerCase() === email && 
                u.RA.toString() === ra
            );

            if (user) {
                currentUser = {
                    ...user,
                    RA: user.RA.toString(), // Garante que RA é string
                    Perfil: user.Perfil.toUpperCase() // Garante maiúsculas para comparação
                };
                
                // Armazena dados do usuário na sessão (simulação)
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                showDashboard();
            } else {
                loginError.textContent = "E-mail ou RA incorretos. Tente novamente.";
                loginError.classList.remove('hidden');
            }
        }

        /**
         * Exibe o dashboard apropriado (Professor ou Aluno).
         */
        function showDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            document.getElementById('welcome-message').textContent = `Olá, ${currentUser.Nome} (${currentUser.Perfil})`;

            if (currentUser.Perfil === 'PROFESSOR') {
                document.getElementById('professor-view').classList.remove('hidden');
                document.getElementById('student-view').classList.add('hidden');
                renderProfessorView();
            } else if (currentUser.Perfil === 'ALUNO') {
                document.getElementById('professor-view').classList.add('hidden');
                document.getElementById('student-view').classList.remove('hidden');
                renderStudentView();
            } else {
                // Caso de perfil desconhecido
                openModal("Erro de Perfil", "Seu perfil de usuário é desconhecido. Entre em contato com o administrador.");
                logout();
            }
        }

        /**
         * Faz logout do usuário.
         */
        function logout() {
            currentUser = null;
            sessionStorage.removeItem('currentUser');
            document.getElementById('email').value = '';
            document.getElementById('ra').value = '';
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('professor-view').classList.add('hidden');
            document.getElementById('student-view').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }

        /**
         * Verifica o estado de autenticação ao carregar a página.
         */
        function checkAuthStatus() {
            const storedUser = sessionStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                // Certifica-se de que o Perfil está em maiúsculas
                currentUser.Perfil = currentUser.Perfil.toUpperCase(); 
                showDashboard();
            }
        }

        // --- FUNÇÕES DA VISÃO DO PROFESSOR ---

        /**
         * Preenche o seletor de turmas.
         */
        function populateTaskClasses() {
            const classSelect = document.getElementById('task-class');
            // Limpa as opções atuais
            classSelect.innerHTML = '<option value="Todos">Todas as Turmas</option>'; 
            
            // Pega todas as turmas únicas dos alunos
            const classes = new Set(allUsers
                .filter(u => u.Perfil === 'ALUNO' && u.Turma)
                .map(u => u.Turma)
            );
            
            classes.forEach(c => {
                const option = document.createElement('option');
                option.value = c;
                option.textContent = c;
                classSelect.appendChild(option);
            });
        }

        /**
         * Cria uma nova tarefa (simulação de escrita na aba TAREFAS).
         */
        function createTask() {
            const title = document.getElementById('task-title').value.trim();
            const description = document.getElementById('task-description').value.trim();
            const taskClass = document.getElementById('task-class').value;
            const deadline = document.getElementById('task-deadline').value;
            const messageElement = document.getElementById('task-message');
            
            if (!title || !description || !deadline) {
                openModal("Campos Obrigatórios", "Por favor, preencha o Título, a Descrição e o Prazo.");
                return;
            }

            const newTask = {
                ID: taskIdCounter++,
                ProfessorEmail: currentUser.Email,
                Título: title,
                Descrição: description,
                Turma: taskClass,
                Prazo: deadline,
                DataPublicacao: new Date().toLocaleDateString('pt-BR')
            };

            // SIMULAÇÃO: Adiciona à lista em memória (NÃO É PERSISTENTE)
            allTasks.push(newTask);
            
            // Limpa os campos
            document.getElementById('task-title').value = '';
            document.getElementById('task-description').value = '';
            document.getElementById('task-deadline').value = '';
            
            // Mensagem de sucesso temporária
            messageElement.textContent = `Tarefa "${title}" publicada com sucesso (ID: ${newTask.ID}). Lembre-se, este dado só é persistente se for adicionado à sua aba TAREFAS na Planilha.`;
            messageElement.classList.remove('hidden');
            setTimeout(() => messageElement.classList.add('hidden'), 8000);

            renderProfessorView();
        }

        /**
         * Renderiza a lista de tarefas e submissões para o professor.
         */
        function renderProfessorView() {
            const container = document.getElementById('professor-tasks-list');
            container.innerHTML = '';
            
            const professorTasks = allTasks.filter(t => t.ProfessorEmail === currentUser.Email);

            if (professorTasks.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Nenhuma tarefa publicada por você até o momento.</p>';
                return;
            }

            professorTasks.forEach(task => {
                const taskSubmissions = allSubmissions.filter(s => parseInt(s.TarefaID) === parseInt(task.ID));

                const taskElement = document.createElement('div');
                taskElement.className = 'border p-4 rounded-lg bg-white mb-4';
                taskElement.innerHTML = `
                    <h4 class="text-lg font-bold text-blue-600">${task.Título} (Turma: ${task.Turma})</h4>
                    <p class="text-sm text-gray-500 mb-2">Prazo: ${task.Prazo}</p>
                    <p class="mb-3">${task.Descrição}</p>
                    
                    <p class="text-md font-semibold mt-4">Entregas (${taskSubmissions.length})</p>
                    <div class="space-y-2 max-h-48 overflow-y-auto mt-2">
                        ${taskSubmissions.length === 0 
                            ? '<p class="text-sm text-gray-500">Nenhuma entrega recebida ainda.</p>'
                            : taskSubmissions.map(sub => `
                                <div class="p-2 border rounded-md bg-gray-50 flex justify-between items-center">
                                    <span class="text-sm font-medium">RA: ${sub.RAAluno}</span>
                                    <a href="${sub.Link}" target="_blank" class="text-blue-500 hover:underline text-sm">Ver Arquivo</a>
                                </div>
                            `).join('')
                        }
                    </div>
                `;
                container.appendChild(taskElement);
            });
        }

        // --- FUNÇÕES DA VISÃO DO ALUNO ---

        /**
         * Renderiza a lista de tarefas disponíveis para o aluno.
         */
        function renderStudentView() {
            const container = document.getElementById('student-tasks-list');
            container.innerHTML = '';

            // Filtra tarefas para a turma do aluno ou para 'Todos'
            const studentTasks = allTasks.filter(t => 
                t.Turma === 'Todos' || t.Turma === currentUser.Turma
            ).sort((a, b) => new Date(a.Prazo) - new Date(b.Prazo)); // Ordena por prazo

            if (studentTasks.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Nenhuma tarefa disponível para sua turma no momento.</p>';
                return;
            }

            studentTasks.forEach(task => {
                const isSubmitted = allSubmissions.some(s => 
                    parseInt(s.TarefaID) === parseInt(task.ID) && s.RAAluno === currentUser.RA
                );
                
                const taskElement = document.createElement('div');
                taskElement.className = 'border p-4 rounded-lg bg-white flex flex-col md:flex-row justify-between items-start md:items-center';
                
                const deadlineDate = new Date(task.Prazo);
                const isLate = deadlineDate < new Date() && !isSubmitted;
                
                taskElement.innerHTML = `
                    <div class="flex-grow mb-3 md:mb-0">
                        <h4 class="text-lg font-bold text-gray-800">${task.Título}</h4>
                        <p class="text-sm text-gray-600 mb-2">${task.Descrição}</p>
                        <p class="text-xs font-medium ${isLate ? 'text-red-500' : 'text-blue-500'}">
                            Prazo: ${task.Prazo} ${isLate ? ' (ATRASADO)' : ''}
                        </p>
                    </div>
                    <div class="w-full md:w-auto flex flex-col space-y-2 md:space-y-0 md:space-x-2">
                        ${isSubmitted 
                            ? `<button class="btn-secondary w-full md:w-auto opacity-70 cursor-not-allowed" disabled>Entregue</button>`
                            : `<button onclick="showSubmissionForm(${task.ID}, '${task.Título}')" class="btn-primary w-full md:w-auto">Entregar Arquivo</button>`
                        }
                    </div>
                `;
                container.appendChild(taskElement);
            });
        }

        /**
         * Exibe o formulário de submissão dentro de um modal.
         * @param {number} taskId - ID da tarefa.
         * @param {string} taskTitle - Título da tarefa.
         */
        function showSubmissionForm(taskId, taskTitle) {
            const bodyContent = `
                <p class="mb-4">Insira o link para o seu arquivo PDF ou DOC (Ex: Google Drive, Dropbox).</p>
                <input type="url" id="submission-link" class="mb-4" placeholder="URL do Arquivo (Ex: https://drive.google.com/...)">
                <button onclick="submitTask(${taskId})" class="btn-primary w-full">Confirmar Entrega</button>
                <div id="submission-message" class="text-red-500 mt-2 hidden"></div>
            `;
            
            document.getElementById('modal-title').textContent = `Entrega: ${taskTitle}`;
            document.getElementById('modal-body').innerHTML = bodyContent;
            document.getElementById('app-modal').classList.remove('hidden');
            
            // Remove o botão de fechar para forçar a interação com o formulário
            document.querySelector('#app-modal button[onclick="closeModal()"]').classList.add('hidden');
        }

        /**
         * Envia a tarefa (simulação de escrita na aba ENTREGAS).
         * @param {number} taskId - ID da tarefa.
         */
        function submitTask(taskId) {
            const link = document.getElementById('submission-link').value.trim();
            const messageElement = document.getElementById('submission-message');
            messageElement.classList.add('hidden');
            
            if (!link || !link.startsWith('http')) {
                messageElement.textContent = "Por favor, insira um link válido (começando com http).";
                messageElement.classList.remove('hidden');
                return;
            }

            const newSubmission = {
                ID: submissionIdCounter++,
                TarefaID: taskId.toString(),
                RAAluno: currentUser.RA,
                Link: link,
                DataEntrega: new Date().toLocaleDateString('pt-BR'),
                Status: 'Entregue'
            };

            // SIMULAÇÃO: Adiciona à lista em memória (NÃO É PERSISTENTE)
            allSubmissions.push(newSubmission);
            
            // Fecha o modal e exibe mensagem de sucesso
            document.querySelector('#app-modal button[onclick="closeModal()"]').classList.remove('hidden');
            closeModal();
            openModal("Sucesso!", `Tarefa entregue! Lembre-se, para persistir esta entrega, ela precisa ser adicionada à sua aba ENTREGAS na Planilha.`);

            // Re-renderiza a visão do aluno
            renderStudentView();
        }

        // --- INICIALIZAÇÃO ---

        // 1. Carrega os dados da Planilha e habilita o login
        loadInitialData();

        // 2. Verifica se já há um usuário logado na sessão
        checkAuthStatus();
    </script>
</body>
</html>
