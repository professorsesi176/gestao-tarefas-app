<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Gestão de Tarefas</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: 'Poppins', sans-serif; background:#f5f5f5; margin:0; padding:0; }
  header { background:#1E88E5; color:white; text-align:center; padding:15px 0; font-size:1.5em; font-weight:600; }
  footer { text-align:center; padding:15px; color:#666; font-size:0.9em; }
  .card { background:white; margin:20px auto; padding:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); width:90%; max-width:600px; }
  input, textarea, select, button { width:100%; padding:10px; margin:5px 0; border:1px solid #ccc; border-radius:6px; font-size:1em; }
  button { background:#1E88E5; color:white; border:none; cursor:pointer; font-weight:600; }
  button:hover { background:#1565C0; }
  .hidden { display:none; }
  .checkbox-group label { display:block; margin:5px 0; }
</style>
</head>
<body>
<header>Gestão de Tarefas</header>

<div class="card" id="loginCard">
  <h3>Login</h3>
  <input id="raInput" placeholder="Digite seu RA">
  <button onclick="login()">Entrar</button>
</div>

<div class="card hidden" id="profCard">
  <h3>Criar Nova Tarefa</h3>
  <label>Selecione as turmas:</label>
  <div class="checkbox-group" id="turmasBox"></div>
  <input id="tema" placeholder="Tema">
  <textarea id="parte1" placeholder="Parte 1"></textarea>
  <textarea id="parte2" placeholder="Parte 2"></textarea>
  <textarea id="parte3" placeholder="Parte 3"></textarea>
  <textarea id="parte4" placeholder="Parte 4"></textarea>
  <input type="date" id="dataAula">
  <button onclick="criarTarefa()">Salvar Tarefa</button>
</div>

<div class="card hidden" id="alunoCard">
  <h3 id="saudacao"></h3>
  <div id="tarefasContainer"></div>
</div>

<footer>Desenvolvido por Geovane Módena</footer>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzKymbA3QgIdhBw7AfUJQveK3l3gbzT-2eccOJpF1K4E-HrEc51pefiJFWCEnDWZm4V/exec";
let usuarios = [], tarefas = [], userAtual = null;

async function login() {
  const ra = document.getElementById("raInput").value.trim();
  const res = await fetch(`${API_URL}?func=getUsers`);
  const data = await res.json();
  usuarios = data.users;

  userAtual = usuarios.find(u => u.RA == ra);
  if (!userAtual) return alert("RA não encontrado!");

  document.getElementById("loginCard").classList.add("hidden");
  if (userAtual.Turma.toLowerCase() === "professor") {
    document.getElementById("profCard").classList.remove("hidden");
    carregarTurmas();
  } else {
    document.getElementById("alunoCard").classList.remove("hidden");
    document.getElementById("saudacao").innerText = `Olá, ${userAtual.NomeCompleto}!`;
    carregarTarefas();
  }
}

async function carregarTurmas() {
  const turmas = [...new Set(usuarios.map(u => u.Turma).filter(t => t.toLowerCase() !== "professor"))];
  const box = document.getElementById("turmasBox");
  box.innerHTML = turmas.map(t => `<label><input type="checkbox" value="${t}"> ${t}</label>`).join('');
}

async function criarTarefa() {
  const turmas = [...document.querySelectorAll('#turmasBox input:checked')].map(i => i.value);
  const body = {
    action: 'novaTarefa',
    turmas,
    tema: document.getElementById("tema").value,
    parte1: document.getElementById("parte1").value,
    parte2: document.getElementById("parte2").value,
    parte3: document.getElementById("parte3").value,
    parte4: document.getElementById("parte4").value,
    dataAula: document.getElementById("dataAula").value
  };
  const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(body) });
  const json = await res.json();
  alert(json.message);
}

async function carregarTarefas() {
  const res = await fetch(`${API_URL}?func=getTarefas`);
  const data = await res.json();
  tarefas = data.tarefas.filter(t => t.Turmas.includes(userAtual.Turma));

  const cont = document.getElementById("tarefasContainer");
  cont.innerHTML = "";
  tarefas.forEach(t => {
    cont.innerHTML += `
      <div style="border:1px solid #ddd;padding:10px;margin-bottom:10px;border-radius:6px;">
        <b>${t.Tema}</b><br>
        <small>${t.DataAula}</small>
        <p>Parte 1: ${t.Parte1}</p>
        <input id="link1-${t.ID}" placeholder="Link da Parte 1">
        <p>Parte 2: ${t.Parte2}</p>
        <input id="link2-${t.ID}" placeholder="Link da Parte 2">
        <p>Parte 3: ${t.Parte3}</p>
        <input id="link3-${t.ID}" placeholder="Link da Parte 3">
        <p>Parte 4: ${t.Parte4}</p>
        <input id="link4-${t.ID}" placeholder="Link da Parte 4">
        <button onclick="enviarLinks(${t.ID})">Enviar</button>
      </div>`;
  });
}

async function enviarLinks(id) {
  const body = {
    action: 'novaEntrega',
    RA: userAtual.RA,
    NomeCompleto: userAtual.NomeCompleto,
    Turma: userAtual.Turma,
    ID_Tarefa: id,
    Link1: document.getElementById(`link1-${id}`).value,
    Link2: document.getElementById(`link2-${id}`).value,
    Link3: document.getElementById(`link3-${id}`).value,
    Link4: document.getElementById(`link4-${id}`).value
  };
  const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(body) });
  const json = await res.json();
  alert("Entrega salva! Nota atual: " + json.nota);
}
</script>
</body>
</html>
