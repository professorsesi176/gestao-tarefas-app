<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Tarefas Escolar - DEBUG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.2); }
        .btn-primary { background-color: #CC0000; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; transition: background-color 0.2s; cursor: pointer; }
        .btn-primary:hover { background-color: #A00000; }
        input { border: 1px solid #d1d5db; padding: 12px; border-radius: 8px; width: 100%; margin-bottom: 8px; }
        .hidden { display: none; }
        .log-container { background: #1a1a1a; color: #00ff00; padding: 10px; border-radius: 8px; font-family: monospace; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 sm:p-8">

<div class="w-full max-w-4xl bg-white shadow-xl rounded-2xl p-6">
    <header class="mb-8 border-b pb-4">
        <h1 class="text-3xl font-extrabold text-red-700 text-center">Sistema de Tarefas - MODO DEBUG</h1>
    </header>

    <div class="space-y-6">
        <!-- TESTE DIRETO DO BACKEND -->
        <div class="card p-6">
            <h2 class="text-2xl font-bold text-red-700 mb-4">üß™ Teste de Conex√£o com Backend</h2>
            <button onclick="testarBackend()" class="btn-primary mb-4">Testar Conex√£o</button>
            <div class="log-container">
                <div id="debug-log">Clique em "Testar Conex√£o" para ver os logs...</div>
            </div>
        </div>

        <!-- LOGIN SIMPLES -->
        <div class="card p-6">
            <h2 class="text-2xl font-bold text-red-700 mb-4">üîê Login de Teste</h2>
            <form onsubmit="loginTeste(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">E-mail</label>
                    <input type="email" id="email" placeholder="seu.email@escola.com" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">RA</label>
                    <input type="text" id="ra" placeholder="Apenas n√∫meros" required>
                </div>
                <button type="submit" class="btn-primary w-full">Entrar</button>
            </form>
            <div id="login-result" class="mt-4 hidden"></div>
        </div>

        <!-- INFORMA√á√ïES T√âCNICAS -->
        <div class="card p-6">
            <h2 class="text-2xl font-bold text-red-700 mb-4">üîß Informa√ß√µes T√©cnicas</h2>
            <div class="space-y-2 text-sm">
                <p><strong>URL do Backend:</strong> <code id="backend-url"></code></p>
                <p><strong>ID da Planilha:</strong> <code>1EXQmylx6j8knDMYUty3u2x6dM5exR4GjVlJknxAAp7c</code></p>
                <p><strong>Token de Seguran√ßa:</strong> <code>SESI_EDUCATION_2024</code></p>
            </div>
        </div>
    </div>
</div>

<script>
// CONFIGURA√á√ÉO
const API_URL = "https://script.google.com/macros/s/AKfycbzKymbA3QgIdhBw7AfUJQveK3l3gbzT-2eccOJpF1K4E-HrEc51pefiJFWCEnDWZm4V/exec";
const SECRET_KEY = 'SESI_EDUCATION_2024';

// ELEMENTOS
const debugLog = document.getElementById('debug-log');
const backendUrl = document.getElementById('backend-url');
const loginResult = document.getElementById('login-result');

// MOSTRAR URL DO BACKEND
backendUrl.textContent = API_URL;

// FUN√á√ÉO PARA ADICIONAR LOGS
function addLog(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const color = type === 'error' ? '#ff4444' : type === 'success' ? '#00ff00' : '#ffffff';
    const logEntry = document.createElement('div');
    logEntry.innerHTML = `<span style="color: #888">[${timestamp}]</span> <span style="color: ${color}">${message}</span>`;
    debugLog.appendChild(logEntry);
    debugLog.scrollTop = debugLog.scrollHeight;
}

// TESTAR CONEX√ÉO COM BACKEND
async function testarBackend() {
    addLog('üöÄ INICIANDO TESTE DE CONEX√ÉO...');
    
    try {
        addLog('üì° Testando fun√ß√£o getUsers...');
        
        const url = `${API_URL}?token=${SECRET_KEY}&func=getUsers&_t=${Date.now()}`;
        addLog(`üîó URL: ${url}`);
        
        const response = await fetch(url);
        addLog(`üìä Status HTTP: ${response.status}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const text = await response.text();
        addLog(`üì® Resposta bruta: ${text.substring(0, 500)}...`);
        
        let data;
        try {
            data = JSON.parse(text);
            addLog('‚úÖ JSON parseado com sucesso');
        } catch (e) {
            addLog('‚ùå Erro ao parsear JSON: ' + e.message, 'error');
            return;
        }
        
        if (data.success) {
            addLog(`‚úÖ BACKEND FUNCIONANDO! Usu√°rios encontrados: ${data.data.length}`, 'success');
            addLog(`üìã Dados: ${JSON.stringify(data.data)}`);
        } else {
            addLog(`‚ùå Backend retornou erro: ${data.error}`, 'error');
        }
        
    } catch (error) {
        addLog(`üí• ERRO CR√çTICO: ${error.message}`, 'error');
        addLog('üîç Poss√≠veis causas:', 'error');
        addLog('- Script n√£o implementado como App Web', 'error');
        addLog('- Permiss√µes insuficientes na planilha', 'error');
        addLog('- ID da planilha incorreto no backend', 'error');
    }
}

// LOGIN DE TESTE
async function loginTeste(event) {
    event.preventDefault();
    
    const email = document.getElementById('email').value.trim();
    const ra = document.getElementById('ra').value.trim();
    
    loginResult.className = 'p-4 rounded hidden';
    loginResult.innerHTML = '';
    
    try {
        addLog(`üîê Tentando login: ${email} / ${ra}`);
        
        const url = `${API_URL}?token=${SECRET_KEY}&func=getUsers&_t=${Date.now()}`;
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Erro desconhecido');
        }
        
        const users = data.data || [];
        const usuario = users.find(user => user.Email === email && user.RA === ra);
        
        if (usuario) {
            loginResult.className = 'p-4 bg-green-100 text-green-800 rounded';
            loginResult.innerHTML = `
                <strong>‚úÖ LOGIN BEM-SUCEDIDO!</strong><br>
                Nome: ${usuario.NomeCompleto}<br>
                Perfil: ${usuario.Perfil}<br>
                Turma: ${usuario.Turma || 'N/A'}
            `;
            addLog(`‚úÖ Login bem-sucedido para: ${usuario.NomeCompleto}`, 'success');
        } else {
            loginResult.className = 'p-4 bg-red-100 text-red-800 rounded';
            loginResult.innerHTML = '<strong>‚ùå E-mail ou RA incorretos!</strong>';
            addLog('‚ùå Credenciais inv√°lidas', 'error');
        }
        
    } catch (error) {
        loginResult.className = 'p-4 bg-red-100 text-red-800 rounded';
        loginResult.innerHTML = `<strong>‚ùå Erro: ${error.message}</strong>`;
        addLog(`üí• Erro no login: ${error.message}`, 'error');
    }
}

// TESTE AUTOM√ÅTICO AO CARREGAR
addLog('üìã Sistema de debug carregado');
addLog('üëÜ Clique em "Testar Conex√£o" para verificar o backend');
</script>
</body>
</html>
