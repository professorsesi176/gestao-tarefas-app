<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Tarefas Escolar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca de Ícones Lucide (Carregamento Robusto) -->
    <script src="https://cdn.jsdelivr.net/npm/lucide-static@latest/dist/lucide.min.js"></script>
    
    <!-- FIX: Carrega a base de dados de utilizadores localmente -->
    <script src="users.js"></script> 
    
    <style>
        /* ... (estilos anteriores mantidos) ... */
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 sm:p-8">

<div id="app-container" class="w-full max-w-4xl bg-white shadow-xl rounded-2xl p-6 sm:p-10 transition-all duration-300">
    <!-- Cabeçalho centralizado e botão posicionado -->
    <header class="mb-8 border-b pb-4 relative">
        <h1 class="text-3xl font-extrabold text-red-700 text-center">
            Gestão de Tarefas
        </h1>
        <button onclick="logout()" id="logoutBtn" class="btn-secondary hidden absolute top-0 right-0">Sair</button>
    </header>

    <!-- Conteúdo da Aplicação -->
    <div id="content-area">
        <!-- Tela de Login (Estado Inicial) -->
        <!-- O renderLogin() irá injetar o HTML aqui -->
    </div>

    <footer class="mt-8 pt-4 border-t text-xs text-gray-500 text-center">
        Desenvolvido por Geovane Modena | Versão 3.0
    </footer>
</div>

<!-- Modal Customizado para Avisos -->
<div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full shadow-2xl">
        <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-600"></h3>
        <p id="modal-message" class="text-gray-700 mb-4 whitespace-pre-wrap"></p>
        <button id="modal-close-button" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition">
            OK
        </button>
    </div>
</div>

<script>
// --- CONFIGURAÇÃO ---
// URL do Backend (Apps Script) - Atualize se necessário
const API_URL = "https://script.google.com/macros/s/AKfycbzKymbA3QgIdhBw7AfUJQveK3l3gbzT-2eccOJpF1K4E-HrEc51pefiJFWCEnDWZm4V/exec";
const API_CONFIG = {
    token: 'SESI_EDUCATION_2024'
};

// --- ESTADO DA APLICAÇÃO ---
let usuarios = window.listaDeUsuarios || []; 
let usuarioLogado = null;
let tarefas = [];

// ... (código anterior, como elementos DOM, funções utilitárias, etc.) ...

// --- FUNÇÕES DE AUTENTICAÇÃO (mantidas) ---

// --- PAINEL DO ALUNO ATUALIZADO ---

async function mostrarPainelAluno() {
    contentArea.innerHTML = `
        <div id="painelAluno" class="space-y-6">
            <!-- Cabeçalho com Notificações -->
            <div class="card p-6 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-red-700">Minhas Tarefas</h3>
                <button onclick="mostrarNotificacoes()" class="relative btn-secondary">
                    <i data-lucide="bell" class="mr-2"></i> Notificações
                    <span id="contador-notificacoes" class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center hidden">0</span>
                </button>
            </div>

            <!-- Lista de Tarefas Pendentes -->
            <div class="card p-6">
                <h4 class="text-xl font-semibold mb-4 text-gray-800">Tarefas da Turma ${usuarioLogado.Turma}</h4>
                <div id="lista-tarefas-aluno" class="space-y-4">
                    <div class="text-center text-gray-500">Carregando tarefas...</div>
                </div>
            </div>

            <!-- Histórico de Entregas -->
            <div class="card p-6">
                <h4 class="text-xl font-semibold mb-4 text-gray-800">Minhas Entregas</h4>
                <div id="historico-entregas">
                    <div class="text-center text-gray-500">Carregando histórico...</div>
                </div>
            </div>
        </div>

        <!-- Modal de Entrega -->
        <div id="modal-entrega" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold mb-4">Entregar Tarefa</h3>
                <form id="form-entrega" class="space-y-4">
                    <input type="hidden" id="tarefa-entrega-id">
                    <div id="campos-links">
                        <!-- Campos dinâmicos para links -->
                    </div>
                    <div class="flex space-x-4">
                        <button type="submit" class="btn-primary flex-1">Enviar Entrega</button>
                        <button type="button" onclick="fecharModalEntrega()" class="btn-secondary flex-1">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal de Notificações -->
        <div id="modal-notificacoes" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg p-6 max-w-md w-full max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Notificações</h3>
                    <button onclick="fecharModalNotificacoes()" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div id="lista-notificacoes" class="space-y-3">
                    <!-- Notificações serão inseridas aqui -->
                </div>
            </div>
        </div>
    `;

    await carregarTarefasAluno();
    await carregarHistoricoEntregas();
    await carregarNotificacoes();
    renderIcons();
}

// ... (código anterior, como funções do professor, etc.) ...

// --- NOVAS FUNÇÕES PARA ENTREGAS E PRAZOS ---

/**
 * Calcula os prazos para cada parte baseado na data da aula
 * Regras:
 * - Parte 1: até 18h do mesmo dia da aula
 * - Parte 2: a partir do 3º dia até o 7º dia
 * - Parte 3: a partir do 8º dia até o 14º dia
 * - Parte 4: a partir do 15º dia até o 28º dia
 */
function calcularPrazos(dataAula) {
    const data = new Date(dataAula);
    const prazos = {
        parte1: {
            inicio: new Date(data),
            fim: new Date(data.setHours(18, 0, 0, 0)) // mesmo dia até 18h
        },
        parte2: {
            inicio: new Date(data.getTime() + 2 * 24 * 60 * 60 * 1000), // 3º dia (2 dias depois)
            fim: new Date(data.getTime() + 6 * 24 * 60 * 60 * 1000) // 7º dia (6 dias depois)
        },
        parte3: {
            inicio: new Date(data.getTime() + 7 * 24 * 60 * 60 * 1000), // 8º dia (7 dias depois)
            fim: new Date(data.getTime() + 13 * 24 * 60 * 60 * 1000) // 14º dia (13 dias depois)
        },
        parte4: {
            inicio: new Date(data.getTime() + 14 * 24 * 60 * 60 * 1000), // 15º dia (14 dias depois)
            fim: new Date(data.getTime() + 27 * 24 * 60 * 60 * 1000) // 28º dia (27 dias depois)
        }
    };
    return prazos;
}

/**
 * Verifica se a parte pode ser entregue no momento
 */
function verificarDisponibilidadeParte(parte, prazos) {
    const agora = new Date();
    const prazo = prazos[parte];
    return agora >= prazo.inicio && agora <= prazo.fim;
}

/**
 * Abre o modal de entrega para a tarefa, mostrando apenas as partes disponíveis
 */
async function abrirModalEntrega(idTarefa, temaTarefa) {
    const tarefa = tarefas.find(t => t.ID === idTarefa);
    if (!tarefa) return;

    const prazos = calcularPrazos(tarefa.DataAula);
    const container = document.getElementById('campos-links');
    container.innerHTML = '';

    // Parte 1
    const parte1Disponivel = verificarDisponibilidadeParte('parte1', prazos);
    container.innerHTML += `
        <div class="mb-4">
            <label for="link1" class="block text-sm font-medium text-gray-700">Parte 1 ${parte1Disponivel ? '' : '(Indisponível)'}</label>
            <input type="url" id="link1" ${parte1Disponivel ? '' : 'disabled'} placeholder="Link da Parte 1" class="mt-1">
            <p class="text-xs text-gray-500">Prazo: até ${formatarData(prazos.parte1.fim)}</p>
        </div>
    `;

    // Parte 2
    const parte2Disponivel = verificarDisponibilidadeParte('parte2', prazos);
    container.innerHTML += `
        <div class="mb-4">
            <label for="link2" class="block text-sm font-medium text-gray-700">Parte 2 ${parte2Disponivel ? '' : '(Indisponível)'}</label>
            <input type="url" id="link2" ${parte2Disponivel ? '' : 'disabled'} placeholder="Link da Parte 2" class="mt-1">
            <p class="text-xs text-gray-500">Prazo: de ${formatarData(prazos.parte2.inicio)} até ${formatarData(prazos.parte2.fim)}</p>
        </div>
    `;

    // Parte 3
    const parte3Disponivel = verificarDisponibilidadeParte('parte3', prazos);
    container.innerHTML += `
        <div class="mb-4">
            <label for="link3" class="block text-sm font-medium text-gray-700">Parte 3 ${parte3Disponivel ? '' : '(Indisponível)'}</label>
            <input type="url" id="link3" ${parte3Disponivel ? '' : 'disabled'} placeholder="Link da Parte 3" class="mt-1">
            <p class="text-xs text-gray-500">Prazo: de ${formatarData(prazos.parte3.inicio)} até ${formatarData(prazos.parte3.fim)}</p>
        </div>
    `;

    // Parte 4
    const parte4Disponivel = verificarDisponibilidadeParte('parte4', prazos);
    container.innerHTML += `
        <div class="mb-4">
            <label for="link4" class="block text-sm font-medium text-gray-700">Parte 4 ${parte4Disponivel ? '' : '(Indisponível)'}</label>
            <input type="url" id="link4" ${parte4Disponivel ? '' : 'disabled'} placeholder="Link da Parte 4" class="mt-1">
            <p class="text-xs text-gray-500">Prazo: de ${formatarData(prazos.parte4.inicio)} até ${formatarData(prazos.parte4.fim)}</p>
        </div>
    `;

    document.getElementById('tarefa-entrega-id').value = idTarefa;
    document.getElementById('modal-entrega').classList.remove('hidden');
    document.getElementById('modal-entrega').classList.add('flex');
}

// ... (outras funções, como carregarTarefasAluno, carregarHistoricoEntregas, etc.) ...

// --- FUNÇÕES DE AVALIAÇÃO PARA O PROFESSOR ---

// ... (funções de avaliação, como carregarEntregasParaAvaliacao, abrirModalAvaliacao, etc.) ...

// --- SISTEMA DE NOTIFICAÇÕES ---

// ... (funções de notificações: carregarNotificacoes, mostrarNotificacoes, etc.) ...

// --- FUNÇÕES DE COMUNICAÇÃO COM A API (com token) ---

async function apiRequest(url, options = {}) {
    const config = {
        ...options,
        headers: {
            'Content-Type': 'application/json',
            ...options.headers
        },
        body: options.body ? JSON.stringify({
            ...JSON.parse(options.body),
            token: API_CONFIG.token
        }) : undefined
    };

    try {
        const response = await fetch(url, config);
        const data = await response.json();
        
        if (data.status === 'error') {
            throw new Error(data.message);
        }
        
        return data;
    } catch (error) {
        console.error('Erro na requisição:', error);
        showModal('Erro', error.message || 'Falha na comunicação com o servidor');
        throw error;
    }
}

// Exemplo de uso para entregar tarefa
async function entregarTarefa(dados) {
    return await apiRequest(API_URL, {
        method: 'POST',
        body: JSON.stringify({
            action: 'entregarTarefa',
            ...dados
        })
    });
}

// ... (restante do código, como inicialização, etc.) ...

// --- INICIALIZAÇÃO ---
init();
</script>
</body>
</html>
