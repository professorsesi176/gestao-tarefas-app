<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o de Tarefas Escolar</title>
    
    <!-- Otimiza√ß√µes de Performance -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://script.google.com">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        :root {
            --cor-primaria: #CC0000;
            --cor-secundaria: #A00000;
            --cor-sucesso: #10b981;
            --cor-erro: #ef4444;
            --cor-aviso: #f59e0b;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f4f7f9;
            margin: 0;
            padding: 0;
        }
        
        .card { 
            background-color: white; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.2); 
        }
        
        .btn-primario { 
            background-color: var(--cor-primaria); 
            color: white; 
            padding: 10px 20px; 
            border-radius: 8px; 
            font-weight: 600; 
            transition: all 0.2s; 
            cursor: pointer; 
            font-size: 14px;
            border: none;
        }
        
        .btn-primario:hover { 
            background-color: var(--cor-secundaria); 
            transform: translateY(-1px);
        }
        
        .btn-secundario { 
            background-color: #d1d5db; 
            color: #1e1e1e; 
            padding: 8px 16px; 
            border-radius: 8px; 
            font-weight: 600; 
            transition: background-color 0.2s; 
            cursor: pointer; 
            border: none;
        }
        
        .btn-secundario:hover { 
            background-color: #9ca3af; 
        }
        
        input, textarea, select {
            border: 1px solid #d1d5db; 
            padding: 12px; 
            border-radius: 8px; 
            width: 100%; 
            transition: border-color 0.2s; 
            margin-top: 4px; 
            margin-bottom: 8px;
            font-family: inherit;
        }
        
        input:focus, textarea:focus, select:focus { 
            border-color: var(--cor-primaria); 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(204, 0, 0, 0.1);
        }
        
        .hidden { 
            display: none; 
        }
        
        .loading-skeleton {
            background: linear-gradient(90deg, #f9fafb 25%, #f3f4f6 50%, #f9fafb 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 6px;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .spinner {
            border: 2px solid #f3f3f3;
            border-radius: 50%;
            border-top: 2px solid var(--cor-primaria);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Componentes Reutiliz√°veis */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }
        
        .table-responsive {
            overflow-x: auto;
        }
        
        .compact-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .compact-table th, 
        .compact-table td {
            padding: 12px 8px;
            border: 1px solid #e5e7eb;
        }
        
        .compact-table th {
            background-color: var(--cor-primaria);
            color: white;
            font-weight: 600;
        }
        
        .compact-table tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        
        /* Utilit√°rios de Layout */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .space-x-2 > * + * { margin-left: 0.5rem; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        
        /* Componentes Espec√≠ficos */
        .contador {
            display: inline-block;
            padding: 4px 8px;
            background-color: #f3f4f6;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 8px;
            min-width: 80px;
            text-align: center;
        }
        
        .contador.disponivel {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .contador.expirado {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .contador.aguardando {
            background-color: #e5e7eb;
            color: #374151;
        }
        
        .turma-column {
            width: 80px;
            text-align: center;
        }
        
        .data-column {
            width: 120px;
            text-align: center;
        }
        
        .acoes-column {
            width: 200px;
            text-align: center;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        /* Cards de Diagn√≥stico */
        .diagnostico-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .diagnostico-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            background-color: white;
        }
        
        .test-result {
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .test-success {
            background-color: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }
        
        .test-error {
            background-color: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }
        
        .test-warning {
            background-color: #fef3c7;
            border: 1px solid #fde68a;
            color: #92400e;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .diagnostico-grid {
                grid-template-columns: 1fr;
            }
            
            .compact-table {
                font-size: 0.875rem;
            }
            
            .acoes-column {
                width: 150px;
            }
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 sm:p-8">
    <div id="app-container" class="w-full max-w-6xl bg-white shadow-xl rounded-2xl p-6 sm:p-8 transition-all duration-300">
        <header class="mb-8 border-b pb-4">
            <div class="header-content">
                <h1 class="text-3xl font-extrabold text-red-700 text-center">Sistema de Gest√£o de Tarefas Escolar</h1>
                <div id="user-info" class="user-info-container text-center mt-2 text-gray-600"></div>
                <div class="absolute top-0 right-0 flex space-x-2">
                    <button id="diagnosticoBtn" class="btn-primario hidden">Diagn√≥stico</button>
                    <button id="relatorioBtn" class="btn-primario hidden" style="background-color: #10b981;">Relat√≥rio</button>
                    <button onclick="logout()" id="logoutBtn" class="btn-secundario hidden">Sair</button>
                </div>
            </div>
        </header>

        <div id="content-area"></div>

        <footer class="mt-8 pt-4 border-t text-xs text-gray-500 text-center">
            Desenvolvido por Geovane Modena | Vers√£o 9.6
        </footer>
    </div>

    <!-- Modal para mensagens -->
    <div id="modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-600"></h3>
            <p id="modal-message" class="text-gray-700 mb-4 whitespace-pre-wrap"></p>
            <button onclick="closeModal()" class="btn-primario w-full">OK</button>
        </div>
    </div>

    <!-- Modal de confirma√ß√£o -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-3 text-red-600">Confirmar Exclus√£o</h3>
            <p id="confirm-message" class="text-gray-700 mb-4"></p>
            <div class="flex space-x-4">
                <button id="confirm-cancel" class="btn-secundario flex-1">Cancelar</button>
                <button id="confirm-delete" class="btn-primario flex-1">Excluir</button>
            </div>
        </div>
    </div>

    <script>
    // ==================== CONFIGURA√á√ÉO E CONSTANTES ====================
    const CONFIG = {
        API_URL: "https://script.google.com/macros/s/AKfycbzKymbA3QgIdhBw7AfUJQveK3l3gbzT-2eccOJpF1K4E-HrEc51pefiJFWCEnDWZm4V/exec",
        TOKEN: 'SESI_EDUCATION_2024',
        CACHE_TTL: 5 * 60 * 1000, // 5 minutos
        MAX_TEMA_LEN: 200,
        MAX_PARTE_LEN: 4000,
        TURMAS: ["1A", "1B", "2A", "2B", "3A", "3B"]
    };

    // ==================== ESTADO GLOBAL ====================
    const STATE = {
        usuarios: [],
        usuarioLogado: null,
        tarefas: [],
        tarefaEditando: null,
        tarefaParaExcluir: null,
        contadoresAtivos: [],
        jsonpCallbackId: 0,
        rmVisible: false,
        performanceMetrics: {
            apiCalls: 0,
            cacheHits: 0,
            cacheMisses: 0,
            startTime: performance.now()
        }
    };

    // ==================== SISTEMA DE CACHE ====================
    const CacheManager = {
        get: (key) => {
            try {
                const item = localStorage.getItem(`task_${key}`);
                if (item) {
                    const { data, expiry } = JSON.parse(item);
                    if (Date.now() > expiry) {
                        localStorage.removeItem(`task_${key}`);
                        STATE.performanceMetrics.cacheMisses++;
                        return null;
                    }
                    STATE.performanceMetrics.cacheHits++;
                    return data;
                }
            } catch (e) {
                console.warn('Erro ao acessar cache:', e);
            }
            STATE.performanceMetrics.cacheMisses++;
            return null;
        },
        
        set: (key, data, ttl = CONFIG.CACHE_TTL) => {
            try {
                const item = {
                    data,
                    expiry: Date.now() + ttl
                };
                localStorage.setItem(`task_${key}`, JSON.stringify(item));
                return true;
            } catch (e) {
                console.warn('Erro ao salvar no cache:', e);
                return false;
            }
        },
        
        remove: (key) => {
            try {
                localStorage.removeItem(key.startsWith('task_') ? key : `task_${key}`);
            } catch (e) {
                console.warn('Erro ao remover do cache:', e);
            }
        },
        
        clear: () => {
            try {
                const keys = Object.keys(localStorage).filter(k => k.startsWith('task_'));
                keys.forEach(k => localStorage.removeItem(k));
            } catch (e) {
                console.warn('Erro ao limpar cache:', e);
            }
        },
        
        getStats: () => {
            let count = 0;
            let size = 0;
            
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('task_')) {
                        count++;
                        size += localStorage.getItem(key).length;
                    }
                }
            } catch (e) {
                console.warn('Erro ao calcular estat√≠sticas do cache:', e);
            }
            
            return {
                count,
                size: (size / 1024).toFixed(2) + ' KB',
                efficiency: STATE.performanceMetrics.cacheHits + STATE.performanceMetrics.cacheMisses > 0 
                    ? ((STATE.performanceMetrics.cacheHits / (STATE.performanceMetrics.cacheHits + STATE.performanceMetrics.cacheMisses)) * 100).toFixed(1) + '%'
                    : '0%'
            };
        }
    };

    // ==================== UTILIT√ÅRIOS ====================
    const Utils = {
        debounce: (func, wait, immediate = false) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    timeout = null;
                    if (!immediate) func(...args);
                };
                const callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                if (callNow) func(...args);
            };
        },

        formatarData: (dataISO) => {
            if (!dataISO) return 'N/A';
            const data = new Date(dataISO);
            return isNaN(data.getTime()) ? 'N/A' : data.toLocaleDateString('pt-BR');
        },

        escapeHTML: (texto) => {
            if (!texto) return '';
            return String(texto)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        },

        sanitizeForSheet: (str) => {
            if (!str) return '';
            const s = String(str);
            const trimmed = s.trimStart();
            return /^[=+\-@]/.test(trimmed) ? "'" + s : s;
        },

        setButtonLoading: (button, isLoading) => {
            if (!button) return;
            if (isLoading) {
                button.disabled = true;
                button.classList.add('btn-loading');
            } else {
                button.disabled = false;
                button.classList.remove('btn-loading');
            }
        }
    };

    // ==================== SISTEMA DE PERFORMANCE ====================
    const PerformanceMonitor = {
        metrics: {
            pageLoad: 0,
            apiCalls: 0,
            cacheHits: 0,
            cacheMisses: 0,
            startTime: performance.now()
        },

        recordApiCall: (duration) => {
            PerformanceMonitor.metrics.apiCalls++;
            console.log(`API Call: ${duration}ms`);
        },

        getMetrics: () => {
            const cacheStats = CacheManager.getStats();
            const memory = performance.memory ? {
                used: (performance.memory.usedJSHeapSize / 1048576).toFixed(2) + ' MB',
                total: (performance.memory.totalJSHeapSize / 1048576).toFixed(2) + ' MB'
            } : null;

            return {
                ...PerformanceMonitor.metrics,
                cache: cacheStats,
                memory: memory,
                totalTime: (performance.now() - PerformanceMonitor.metrics.startTime).toFixed(2) + 'ms'
            };
        },

        testApiPerformance: () => {
            return new Promise((resolve) => {
                const start = performance.now();
                
                apiGet('getUsers', {}, true)
                    .then(() => {
                        const tempo = performance.now() - start;
                        resolve({
                            tempo: tempo.toFixed(2) + 'ms',
                            status: tempo < 1000 ? '√ìtimo' : tempo < 3000 ? 'Bom' : 'Lento'
                        });
                    })
                    .catch(() => {
                        resolve({
                            tempo: 'Falha',
                            status: 'Erro'
                        });
                    });
            });
        }
    };

    // ==================== GERENCIADOR DE API ====================
    const ApiManager = {
        jsonpCallbackId: 0,

        requestJSONP: (url, callback) => {
            const callbackName = 'jsonp_callback_' + ApiManager.jsonpCallbackId++;
            
            const timeout = setTimeout(() => {
                if (window[callbackName]) {
                    delete window[callbackName];
                    callback(new Error('Timeout: A requisi√ß√£o demorou muito para responder'));
                }
            }, 15000);
            
            window[callbackName] = function(data) {
                clearTimeout(timeout);
                delete window[callbackName];
                if (script.parentNode) {
                    document.body.removeChild(script);
                }
                callback(null, data);
            };
            
            const script = document.createElement('script');
            script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;
            script.onerror = function() {
                clearTimeout(timeout);
                delete window[callbackName];
                if (script.parentNode) {
                    document.body.removeChild(script);
                }
                callback(new Error('Falha ao carregar o script. Verifique sua conex√£o.'));
            };
            
            document.body.appendChild(script);
        },

        get: async (func, params = {}, forceRefresh = false) => {
            const cacheKey = `api_${func}_${JSON.stringify(params)}`;
            
            if (!forceRefresh) {
                const cached = CacheManager.get(cacheKey);
                if (cached) {
                    return cached;
                }
            }
            
            return new Promise((resolve, reject) => {
                const startTime = performance.now();
                let url = `${CONFIG.API_URL}?token=${CONFIG.TOKEN}`;
                
                if (func) {
                    url += `&func=${func}`;
                }
                
                for (const key in params) {
                    if (params[key] !== undefined && params[key] !== null) {
                        url += `&${key}=${encodeURIComponent(params[key])}`;
                    }
                }
                
                if (forceRefresh) {
                    url += `&_=${Date.now()}`;
                }
                
                ApiManager.requestJSONP(url, (error, data) => {
                    const duration = performance.now() - startTime;
                    PerformanceMonitor.recordApiCall(duration);
                    
                    if (error) {
                        reject(error);
                    } else if (data && data.success === false) {
                        reject(new Error(data.error));
                    } else {
                        CacheManager.set(cacheKey, data, 2 * 60 * 1000);
                        resolve(data);
                    }
                });
            });
        },

        post: async (action, dados) => {
            return new Promise((resolve, reject) => {
                const startTime = performance.now();
                let url = `${CONFIG.API_URL}?token=${CONFIG.TOKEN}&action=${action}`;
                
                for (const key in dados) {
                    if (dados[key] !== undefined && dados[key] !== null) {
                        if (Array.isArray(dados[key])) {
                            url += `&${key}=${encodeURIComponent(JSON.stringify(dados[key]))}`;
                        } else {
                            url += `&${key}=${encodeURIComponent(dados[key])}`;
                        }
                    }
                }
                
                ApiManager.requestJSONP(url, (error, data) => {
                    const duration = performance.now() - startTime;
                    PerformanceMonitor.recordApiCall(duration);
                    
                    if (error) {
                        reject(error);
                    } else if (data && data.success === false) {
                        reject(new Error(data.error));
                    } else {
                        resolve(data);
                    }
                });
            });
        }
    };

    // Aliases para compatibilidade
    const apiGet = ApiManager.get;
    const apiPost = ApiManager.post;

    // ==================== GERENCIADOR DE INTERFACE ====================
    const UIManager = {
        elements: {
            contentArea: document.getElementById('content-area'),
            userInfo: document.getElementById('user-info'),
            logoutBtn: document.getElementById('logoutBtn'),
            relatorioBtn: document.getElementById('relatorioBtn'),
            diagnosticoBtn: document.getElementById('diagnosticoBtn'),
            modalOverlay: document.getElementById('modal-overlay'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmMessage: document.getElementById('confirm-message'),
            confirmCancel: document.getElementById('confirm-cancel'),
            confirmDelete: document.getElementById('confirm-delete')
        },

        showModal: (title, message) => {
            UIManager.elements.modalTitle.textContent = title;
            UIManager.elements.modalMessage.textContent = message;
            UIManager.elements.modalOverlay.classList.remove('hidden');
        },

        closeModal: () => {
            UIManager.elements.modalOverlay.classList.add('hidden');
        },

        showConfirmModal: (message, onConfirm) => {
            UIManager.elements.confirmMessage.textContent = message;
            UIManager.elements.confirmModal.classList.remove('hidden');
            
            UIManager.elements.confirmCancel.onclick = () => {
                UIManager.elements.confirmModal.classList.add('hidden');
                STATE.tarefaParaExcluir = null;
            };
            
            UIManager.elements.confirmDelete.onclick = () => {
                UIManager.elements.confirmModal.classList.add('hidden');
                if (onConfirm) onConfirm();
                STATE.tarefaParaExcluir = null;
            };
        },

        renderLoading: (message = 'Carregando...') => {
            return `
                <div class="text-center py-8">
                    <div class="spinner"></div>
                    <p class="mt-4 text-gray-600">${message}</p>
                </div>
            `;
        },

        renderError: (message) => {
            return `
                <div class="text-center py-8">
                    <p class="text-red-500 mb-4">${Utils.escapeHTML(message)}</p>
                    <button onclick="location.reload()" class="btn-primario">Tentar Novamente</button>
                </div>
            `;
        }
    };

    // ==================== SISTEMA DE AUTENTICA√á√ÉO ====================
    const AuthManager = {
        async login(credenciais) {
            const { email, senha } = credenciais;
            
            // Verificar se o e-mail existe
            const userByEmail = STATE.usuarios.find(u => {
                const userEmail = String(u.Email || '').toLowerCase().trim();
                const inputEmail = email.toLowerCase().trim();
                return userEmail === inputEmail;
            });

            if (!userByEmail) {
                throw new Error('E-mail n√£o encontrado!');
            }

            // Verificar se o RM corresponde
            const user = STATE.usuarios.find(u => {
                const userEmail = String(u.Email || '').toLowerCase().trim();
                const userRM = String(u.RM || '').trim();
                const inputEmail = email.toLowerCase().trim();
                const inputRM = senha.trim();
                
                return userEmail === inputEmail && userRM === inputRM;
            });
            
            if (!user) {
                throw new Error('Senha incorreta para este e-mail!');
            }
            
            return user;
        },

        logout() {
            STATE.usuarioLogado = null;
            STATE.tarefaEditando = null;
            UIManager.elements.logoutBtn.classList.add('hidden');
            UIManager.elements.relatorioBtn.classList.add('hidden');
            UIManager.elements.diagnosticoBtn.classList.add('hidden');
            UIManager.elements.userInfo.innerHTML = '';
            STATE.contadoresAtivos.forEach(interval => clearInterval(interval));
            STATE.contadoresAtivos = [];
            CacheManager.clear();
            renderLogin();
        },

        updateUserInfo() {
            if (!STATE.usuarioLogado) return;
            
            const user = STATE.usuarioLogado;
            if (user.Perfil === "Professor") {
                UIManager.elements.userInfo.innerHTML = `
                    <div class="user-info-text">
                        Logado como: <span class="font-semibold text-red-700">${Utils.escapeHTML(user.NomeCompleto)} (${user.Perfil})</span>
                    </div>
                `;
                UIManager.elements.relatorioBtn.onclick = mostrarRelatorioProfessor;
                UIManager.elements.diagnosticoBtn.classList.remove('hidden');
                UIManager.elements.diagnosticoBtn.onclick = mostrarPainelDiagnostico;
            } else {
                UIManager.elements.userInfo.innerHTML = `
                    <div class="user-info-text">
                        Logado como: <span class="font-semibold text-red-700">${Utils.escapeHTML(user.NomeCompleto)} (${user.Perfil})</span> | 
                        Turma: ${Utils.escapeHTML(user.Turma || 'N/A')} | 
                        N¬∫: ${Utils.escapeHTML(user.Numero || 'N/A')}
                    </div>
                `;
                UIManager.elements.relatorioBtn.onclick = mostrarRelatorioAluno;
                UIManager.elements.diagnosticoBtn.classList.add('hidden');
            }
            
            UIManager.elements.logoutBtn.classList.remove('hidden');
            UIManager.elements.relatorioBtn.classList.remove('hidden');
        }
    };

    // ==================== SISTEMA DE TEMPO E PRAZOS ====================
    const TimeManager = {
        calcularStatusParteDiaUnico(dataAula, diasOffset) {
            const agora = new Date();
            const base = new Date(dataAula);

            if (isNaN(base.getTime())) {
                return {
                    texto: 'Data inv√°lida',
                    classe: 'aguardando',
                    liberada: false,
                    expirado: false,
                    dentroHorarioEntrega: false
                };
            }

            base.setHours(0, 0, 0, 0);
            const diaEntrega = new Date(base);
            diaEntrega.setDate(diaEntrega.getDate() + diasOffset);

            const inicio = new Date(diaEntrega);
            inicio.setHours(13, 0, 0, 0);

            const fim = new Date(diaEntrega);
            fim.setHours(22, 0, 0, 0);

            if (agora < inicio) {
                const diff = inicio - agora;
                const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
                const horas = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutos = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                let texto = '';
                if (dias > 0) texto = `Libera em ${dias}d ${horas}h`;
                else if (horas > 0) texto = `Libera em ${horas}h ${minutos}m`;
                else texto = `Libera em ${minutos}m`;

                return {
                    texto,
                    classe: 'aguardando',
                    liberada: false,
                    expirado: false,
                    dentroHorarioEntrega: false
                };
            }

            if (agora > fim) {
                return {
                    texto: 'Expirado',
                    classe: 'expirado',
                    liberada: false,
                    expirado: true,
                    dentroHorarioEntrega: false
                };
            }

            // Dentro do √∫nico dia de entrega (13h‚Äì22h)
            const diffFim = fim - agora;
            const horasFim = Math.floor(diffFim / (1000 * 60 * 60));
            const minutosFim = Math.floor((diffFim % (1000 * 60 * 60)) / (1000 * 60));
            let texto = '';
            if (horasFim > 0) texto = `Termina em ${horasFim}h ${minutosFim}m`;
            else texto = `Termina em ${minutosFim}m`;

            return {
                texto,
                classe: 'disponivel',
                liberada: true,
                expirado: false,
                dentroHorarioEntrega: true
            };
        },

        calcularContadoresOtimizado(dataAula) {
            return {
                parte1: TimeManager.calcularStatusParteDiaUnico(dataAula, 0),
                parte2: TimeManager.calcularStatusParteDiaUnico(dataAula, 7),
                parte3: TimeManager.calcularStatusParteDiaUnico(dataAula, 14),
                parte4: TimeManager.calcularStatusParteDiaUnico(dataAula, 28)
            };
        },

        iniciarAtualizacaoContadores() {
            STATE.contadoresAtivos.forEach(interval => clearInterval(interval));
            STATE.contadoresAtivos = [];
            
            const interval = setInterval(() => {
                if (STATE.usuarioLogado && STATE.usuarioLogado.Perfil === 'Aluno') {
                    atualizarContadoresAluno();
                }
            }, 1000);
            
            STATE.contadoresAtivos.push(interval);
        }
    };

    // ==================== COMPONENTES DE INTERFACE ====================
    const Components = {
        loginForm: () => {
            return `
                <div id="login" class="max-w-md mx-auto p-6">
                    <h2 class="text-2xl font-bold text-center text-red-700 mb-6">Login</h2>
                    <div id="loginErro" class="text-red-500 mb-4 hidden text-center font-semibold"></div>

                    <form id="login-form" class="space-y-4">
                        <div class="form-group">
                            <label for="email" class="form-label">E-mail</label>
                            <div class="flex">
                                <input type="text" id="email" name="email" required placeholder="nome.sobrenome" 
                                       class="rounded-r-none border-r-0">
                                <span class="flex items-center px-3 bg-gray-100 border border-l-0 border-gray-300 rounded-r-lg text-gray-600">
                                    @portalsesisp.org.br
                                </span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="senha" class="form-label">Senha</label>
                            <div class="relative">
                                <input type="password" id="senha" name="senha" required placeholder="" 
                                       class="pr-10">
                                <button type="button" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500" 
                                        id="toggleSenha" onclick="toggleRmVisibility()">
                                    üëÅÔ∏è
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="btn-primario w-full py-3" id="login-button">
                            <span id="login-text">Entrar</span>
                        </button>
                    </form>
                </div>
            `;
        },

        metricasPerformance: () => {
            return `
                <div class="diagnostico-card">
                    <h4 class="font-semibold mb-3">M√©tricas de Performance</h4>
                    <button onclick="mostrarMetricasPerformance()" class="btn-primario w-full mb-3">Coletar M√©tricas</button>
                    <div id="metricas-performance">
                        <p class="text-gray-500 text-center text-sm">Clique para coletar m√©tricas</p>
                    </div>
                </div>
            `;
        }
    };

    // ==================== FUN√á√ïES PRINCIPAIS ====================

    // Fun√ß√£o de inicializa√ß√£o
    async function init() {
        try {
            console.log('Inicializando sistema...');
            const response = await apiGet('getUsers', {}, true);
            STATE.usuarios = response.data || response;
            console.log('Usu√°rios carregados:', STATE.usuarios.length);
        } catch (error) {
            console.error('Erro ao carregar usu√°rios:', error);
            STATE.usuarios = [];
            UIManager.showModal('Aviso', 'N√£o foi poss√≠vel carregar a lista de usu√°rios. Verifique sua conex√£o.');
        }
        
        renderLogin();
    }

    // Renderizar tela de login
    function renderLogin() {
        UIManager.elements.contentArea.innerHTML = Components.loginForm();

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await handleLogin(e);
        });
    }

    // Manipular login
    async function handleLogin(event) {
        event.preventDefault();
        const emailPrefix = document.getElementById('email').value.trim();
        const senha = document.getElementById('senha').value.trim();
        const email = `${emailPrefix}@portalsesisp.org.br`;
        
        const loginErro = document.getElementById('loginErro');
        const loginButton = document.getElementById('login-button');
        const loginText = document.getElementById('login-text');
        
        Utils.setButtonLoading(loginButton, true);
        loginText.textContent = "Entrando...";
        
        try {
            const user = await AuthManager.login({ email, senha });
            STATE.usuarioLogado = user;
            loginErro.style.display = 'none';
            
            UIManager.elements.contentArea.innerHTML = UIManager.renderLoading('Carregando painel...');
            
            // Carregar tarefas
            try {
                const response = await apiGet('getTarefas', {}, true);
                STATE.tarefas = response.data || [];
                console.log('Tarefas carregadas:', STATE.tarefas.length);
            } catch (error) {
                console.error('Erro ao carregar tarefas:', error);
                STATE.tarefas = [];
                UIManager.showModal('Aviso', 'Algumas funcionalidades podem estar limitadas devido a problemas de conex√£o.');
            }

            AuthManager.updateUserInfo();

            // Redirecionar para o painel apropriado
            if (user.Perfil === "Professor") {
                await mostrarPainelProfessor();
            } else {
                await mostrarPainelAluno();
            }
            
        } catch (error) {
            loginErro.textContent = error.message;
            loginErro.style.display = 'block';
        } finally {
            Utils.setButtonLoading(loginButton, false);
            loginText.textContent = "Entrar";
        }
    }

    // Toggle visibilidade da senha
    function toggleRmVisibility() {
        const senhaInput = document.getElementById('senha');
        STATE.rmVisible = !STATE.rmVisible;
        senhaInput.type = STATE.rmVisible ? 'text' : 'password';
    }

    // Painel de diagn√≥stico
    async function mostrarPainelDiagnostico() {
        const metricas = PerformanceMonitor.getMetrics();
        const cacheStats = CacheManager.getStats();
        
        UIManager.elements.contentArea.innerHTML = `
            <div class="card p-6">
                <h3 class="text-2xl font-bold text-red-700 mb-4">Painel de Diagn√≥stico e Performance</h3>
                
                <div class="diagnostico-grid">
                    ${Components.metricasPerformance()}
                    
                    <div class="diagnostico-card">
                        <h4 class="font-semibold mb-3">Teste de Conex√£o</h4>
                        <button onclick="testarConexaoCompleta()" class="btn-primario w-full mb-3">Testar Conex√£o Completa</button>
                        <div id="resultado-conexao"></div>
                    </div>
                    
                    <div class="diagnostico-card">
                        <h4 class="font-semibold mb-3">Status do Cache</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Itens em Cache:</span>
                                <span class="font-semibold">${cacheStats.count}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Tamanho do Cache:</span>
                                <span class="font-semibold">${cacheStats.size}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Efici√™ncia do Cache:</span>
                                <span class="font-semibold ${parseFloat(cacheStats.efficiency) > 70 ? 'text-green-600' : 'text-yellow-600'}">${cacheStats.efficiency}</span>
                            </div>
                        </div>
                        <button onclick="limparCache()" class="btn-primario w-full mt-3" style="background-color: #ef4444;">Limpar Cache</button>
                    </div>
                    
                    <div class="diagnostico-card">
                        <h4 class="font-semibold mb-3">Estat√≠sticas do Sistema</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Usu√°rios Carregados:</span>
                                <span class="font-semibold">${STATE.usuarios.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Tarefas Carregadas:</span>
                                <span class="font-semibold">${STATE.tarefas.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Chamadas API:</span>
                                <span class="font-semibold">${metricas.apiCalls}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Tempo Total:</span>
                                <span class="font-semibold">${metricas.totalTime}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 text-center">
                    <button onclick="mostrarPainelProfessor()" class="btn-secundario">Voltar ao Painel</button>
                </div>
            </div>
        `;
    }

    // Mostrar m√©tricas de performance
    async function mostrarMetricasPerformance() {
        const container = document.getElementById('metricas-performance');
        container.innerHTML = UIManager.renderLoading('Coletando m√©tricas...');
        
        const [metricas, performanceAPI] = await Promise.all([
            PerformanceMonitor.getMetrics(),
            PerformanceMonitor.testApiPerformance()
        ]);
        
        container.innerHTML = `
            <div class="space-y-3 text-sm">
                <div class="flex justify-between">
                    <span>Tempo API:</span>
                    <span class="font-semibold ${performanceAPI.status === '√ìtimo' ? 'text-green-600' : performanceAPI.status === 'Bom' ? 'text-yellow-600' : 'text-red-600'}">
                        ${performanceAPI.tempo}
                    </span>
                </div>
                <div class="flex justify-between">
                    <span>Status API:</span>
                    <span class="font-semibold">${performanceAPI.status}</span>
                </div>
                <div class="flex justify-between">
                    <span>Chamadas API:</span>
                    <span class="font-semibold">${metricas.apiCalls}</span>
                </div>
                ${metricas.memory ? `
                <div class="flex justify-between">
                    <span>Mem√≥ria Usada:</span>
                    <span class="font-semibold">${metricas.memory.used}</span>
                </div>
                <div class="flex justify-between">
                    <span>Mem√≥ria Total:</span>
                    <span class="font-semibold">${metricas.memory.total}</span>
                </div>
                ` : ''}
            </div>
            
            <div class="mt-4 p-3 bg-blue-50 rounded border border-blue-200">
                <h5 class="font-semibold text-blue-800 mb-2">Recomenda√ß√µes:</h5>
                <ul class="text-xs text-blue-700 space-y-1">
                    ${parseFloat(metricas.cache.efficiency) < 50 ? '<li>‚Ä¢ Cache com baixa efici√™ncia - considere reduzir TTL</li>' : ''}
                    ${performanceAPI.status === 'Lento' ? '<li>‚Ä¢ API lenta - verifique conex√£o ou otimize requisi√ß√µes</li>' : ''}
                    ${metricas.cache.count > 20 ? '<li>‚Ä¢ Muitos itens em cache - considere limpeza peri√≥dica</li>' : ''}
                </ul>
            </div>
        `;
    }

    // Testar conex√£o
    async function testarConexaoCompleta() {
        const resultado = document.getElementById('resultado-conexao');
        resultado.innerHTML = UIManager.renderLoading('Testando conex√£o...');
        
        try {
            const [usersResponse, tarefasResponse] = await Promise.all([
                apiGet('getUsers', {}, true),
                apiGet('getTarefas', {}, true)
            ]);

            const users = usersResponse.data || usersResponse;
            const tarefas = tarefasResponse.data || tarefasResponse;

            resultado.innerHTML = `
                <div class="test-result test-success">
                    <strong>‚úì Conex√£o bem-sucedida!</strong><br>
                    - Usu√°rios: ${users.length} registros<br>
                    - Tarefas: ${tarefas.length} registros<br>
                    - Status: Operacional
                </div>
            `;
        } catch (error) {
            resultado.innerHTML = `
                <div class="test-result test-error">
                    <strong>‚úó Erro na conex√£o:</strong> ${Utils.escapeHTML(error.message)}
                </div>
            `;
        }
    }

    // Limpar cache
    function limparCache() {
        CacheManager.clear();
        UIManager.showModal('Sucesso', 'Cache limpo com sucesso!');
        setTimeout(() => {
            mostrarPainelDiagnostico();
        }, 1000);
    }

    // Fun√ß√µes de logout (para compatibilidade)
    function logout() {
        AuthManager.logout();
    }

    function closeModal() {
        UIManager.closeModal();
    }

    // ==================== INICIALIZA√á√ÉO ====================
    document.addEventListener('DOMContentLoaded', init);

    // ==================== FUN√á√ïES DE COMPATIBILIDADE ====================
    // Estas fun√ß√µes s√£o mantidas para compatibilidade com o c√≥digo existente
    // Elas ser√£o implementadas conforme necess√°rio

    async function mostrarPainelProfessor() {
        UIManager.elements.contentArea.innerHTML = UIManager.renderLoading('Carregando painel do professor...');
        // Implementa√ß√£o simplificada - expandir conforme necess√°rio
    }

    async function mostrarPainelAluno() {
        UIManager.elements.contentArea.innerHTML = UIManager.renderLoading('Carregando painel do aluno...');
        // Implementa√ß√£o simplificada - expandir conforme necess√°rio
    }

    async function mostrarRelatorioProfessor() {
        UIManager.elements.contentArea.innerHTML = UIManager.renderLoading('Carregando relat√≥rio...');
        // Implementa√ß√£o simplificada - expandir conforme necess√°rio
    }

    async function mostrarRelatorioAluno() {
        UIManager.elements.contentArea.innerHTML = UIManager.renderLoading('Carregando relat√≥rio...');
        // Implementa√ß√£o simplificada - expandir conforme necess√°rio
    }

    function atualizarContadoresAluno() {
        // Implementa√ß√£o simplificada - expandir conforme necess√°rio
    }

    // Exportar fun√ß√µes para o escopo global
    window.logout = logout;
    window.closeModal = closeModal;
    window.toggleRmVisibility = toggleRmVisibility;
    window.mostrarPainelDiagnostico = mostrarPainelDiagnostico;
    window.mostrarMetricasPerformance = mostrarMetricasPerformance;
    window.testarConexaoCompleta = testarConexaoCompleta;
    window.limparCache = limparCache;
    window.mostrarPainelProfessor = mostrarPainelProfessor;
    window.mostrarPainelAluno = mostrarPainelAluno;
    window.mostrarRelatorioProfessor = mostrarRelatorioProfessor;
    window.mostrarRelatorioAluno = mostrarRelatorioAluno;
    </script>
</body>
</html>
