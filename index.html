<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Gestão de Tarefas</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: #ffffff;
    margin: 0;
    padding: 0;
    color: #111;
  }

  header {
    background: #000;
    color: #fff;
    text-align: center;
    padding: 20px 0;
    font-size: 1.8em;
    font-weight: 700;
    border-bottom: 6px solid #D50000;
  }

  footer {
    text-align: center;
    padding: 15px;
    color: #333;
    font-size: 0.9em;
    border-top: 2px solid #D50000;
    margin-top: 30px;
  }

  .card {
    background: #fff;
    margin: 30px auto;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    width: 90%;
    max-width: 550px;
  }

  input, textarea, select, button {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 1em;
  }

  input:focus, textarea:focus {
    border-color: #D50000;
    outline: none;
  }

  button {
    background: #D50000;
    color: #fff;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 1em;
    border-radius: 8px;
    transition: 0.2s;
  }

  button:hover {
    background: #b40000;
  }

  .hidden {
    display: none;
  }

  h3 {
    color: #000;
    border-left: 5px solid #D50000;
    padding-left: 10px;
  }

  .checkbox-group label {
    display: block;
    margin: 5px 0;
  }

  .tarefa {
    border-left: 5px solid #D50000;
    padding: 10px;
    margin-bottom: 12px;
    border-radius: 8px;
    background: #f8f8f8;
  }

  .tarefa button {
    background: #000;
  }
</style>
</head>
<body>
<header>Gestão de Tarefas</header>

<div class="card" id="loginCard">
  <h3>Login</h3>
  <input id="emailInput" placeholder="Digite seu E-mail">
  <input id="raInput" placeholder="Digite seu RA">
  <button onclick="login()">Entrar</button>
</div>

<div class="card hidden" id="profCard">
  <h3>Criar Nova Tarefa</h3>
  <label>Selecione as turmas:</label>
  <div class="checkbox-group" id="turmasBox"></div>
  <input id="tema" placeholder="Tema">
  <textarea id="parte1" placeholder="Parte 1"></textarea>
  <textarea id="parte2" placeholder="Parte 2"></textarea>
  <textarea id="parte3" placeholder="Parte 3"></textarea>
  <textarea id="parte4" placeholder="Parte 4"></textarea>
  <input type="date" id="dataAula">
  <button onclick="criarTarefa()">Salvar Tarefa</button>
</div>

<div class="card hidden" id="alunoCard">
  <h3 id="saudacao"></h3>
  <div id="tarefasContainer"></div>
</div>

<footer>Desenvolvido por <b>Geovane Módena</b></footer>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzKymbA3QgIdhBw7AfUJQveK3l3gbzT-2eccOJpF1K4E-HrEc51pefiJFWCEnDWZm4V/exec";
let usuarios = [], tarefas = [], userAtual = null;

async function login() {
  const email = document.getElementById("emailInput").value.trim().toLowerCase();
  const ra = document.getElementById("raInput").value.trim();
  if (!email || !ra) return alert("Digite seu e-mail e RA!");

  const res = await fetch(`${API_URL}?func=getUsers`);
  const data = await res.json();
  usuarios = data.users;

  userAtual = usuarios.find(u =>
    u.Email && u.Email.toLowerCase() === email && u.RA == ra
  );

  if (!userAtual) {
    alert("Usuário não encontrado! Verifique os dados.");
    return;
  }

  document.getElementById("loginCard").classList.add("hidden");

  if (userAtual.Turma.toLowerCase() === "professor") {
    document.getElementById("profCard").classList.remove("hidden");
    carregarTurmas();
  } else {
    document.getElementById("alunoCard").classList.remove("hidden");
    document.getElementById("saudacao").innerText = `Olá, ${userAtual.NomeCompleto}!`;
    carregarTarefas();
  }
}

async function carregarTurmas() {
  const turmas = [...new Set(usuarios.map(u => u.Turma).filter(t => t.toLowerCase() !== "professor"))];
  const box = document.getElementById("turmasBox");
  box.innerHTML = turmas.map(t => `<label><input type="checkbox" value="${t}"> ${t}</label>`).join('');
}

async function criarTarefa() {
  const turmas = [...document.querySelectorAll('#turmasBox input:checked')].map(i => i.value);
  if (turmas.length === 0) return alert("Selecione ao menos uma turma!");

  const body = {
    action: 'novaTarefa',
    turmas,
    tema: document.getElementById("tema").value,
    parte1: document.getElementById("parte1").value,
    parte2: document.getElementById("parte2").value,
    parte3: document.getElementById("parte3").value,
    parte4: document.getElementById("parte4").value,
    dataAula: document.getElementById("dataAula").value
  };

  const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(body) });
  const json = await res.json();
  alert(json.message);
}

async function carregarTarefas() {
  const res = await fetch(`${API_URL}?func=getTarefas`);
  const data = await res.json();
  tarefas = data.tarefas.filter(t => t.Turmas.includes(userAtual.Turma));

  const cont = document.getElementById("tarefasContainer");
  cont.innerHTML = "";
  tarefas.forEach(t => {
    cont.innerHTML += `
      <div class="tarefa">
        <b>${t.Tema}</b><br>
        <small>Data da Aula: ${t.DataAula}</small>
        <p>Parte 1: ${t.Parte1}</p>
        <input id="link1-${t.ID}" placeholder="Link da Parte 1">
        <p>Parte 2: ${t.Parte2}</p>
        <input id="link2-${t.ID}" placeholder="Link da Parte 2">
        <p>Parte 3: ${t.Parte3}</p>
        <input id="link3-${t.ID}" placeholder="Link da Parte 3">
        <p>Parte 4: ${t.Parte4}</p>
        <input id="link4-${t.ID}" placeholder="Link da Parte 4">
        <button onclick="enviarLinks(${t.ID})">Enviar</button>
      </div>`;
  });
}

async function enviarLinks(id) {
  const body = {
    action: 'novaEntrega',
    RA: userAtual.RA,
    NomeCompleto: userAtual.NomeCompleto,
    Turma: userAtual.Turma,
    ID_Tarefa: id,
    Link1: document.getElementById(`link1-${id}`).value,
    Link2: document.getElementById(`link2-${id}`).value,
    Link3: document.getElementById(`link3-${id}`).value,
    Link4: document.getElementById(`link4-${id}`).value
  };
  const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(body) });
  const json = await res.json();
  alert("Entrega salva! Nota atual: " + json.nota);
}
</script>
</body>
</html>
