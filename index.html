<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Tarefas Escolar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bibliotecas para exportação -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.2); }
        .btn-primary { background-color: #CC0000; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; transition: background-color 0.2s; cursor: pointer; font-size: 14px; }
        .btn-primary:hover { background-color: #A00000; }
        .btn-secondary { background-color: #d1d5db; color: #1e1e1e; padding: 8px 16px; border-radius: 8px; font-weight: 600; transition: background-color 0.2s; cursor: pointer; }
        .btn-secondary:hover { background-color: #9ca3af; }
        .btn-small { padding: 6px 12px; font-size: 0.875rem; }
        input, textarea, select {
            border: 1px solid #d1d5db; padding: 12px; border-radius: 8px; width: 100%; box-sizing: border-box;
            transition: border-color 0.2s; margin-top: 4px; margin-bottom: 8px;
        }
        input:focus, textarea:focus, select:focus { border-color: #CC0000; outline: none; }
        [data-lucide] { width: 20px; height: 20px; display: inline-block; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #CC0000; color: white; }
        tbody tr:nth-child(even) { background-color: #f9f9f9; }
        .hidden { display: none; }
        
        .checkbox-group {
            display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; padding: 10px;
            background-color: #f9f9f9; border-radius: 8px;
        }
        .checkbox-group label { font-weight: normal; display: flex; align-items: center; }
        .checkbox-group input { width: auto; margin: 0 5px 0 0; }
        
        .form-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .form-row label {
            margin-bottom: 0;
            min-width: 120px;
        }
        .form-row input, .form-row textarea {
            flex: 1;
            margin-top: 0;
        }
        
        .compact-table th, .compact-table td {
            padding: 12px 8px;
        }
        .turma-column {
            width: 80px;
            text-align: center;
        }
        .data-column {
            width: 120px;
            text-align: center;
        }
        .acoes-column {
            width: 200px;
            text-align: center;
        }
        
        .contador {
            display: inline-block;
            padding: 4px 8px;
            background-color: #f3f4f6;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 8px;
            min-width: 80px;
            text-align: center;
        }
        .contador.disponivel {
            background-color: #d1fae5;
            color: #065f46;
        }
        .contador.urgente {
            background-color: #fef3c7;
            color: #92400e;
        }
        .contador.expirado {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .contador.aguardando {
            background-color: #e5e7eb;
            color: #374151;
        }
        
        .link-container {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            align-items: center;
        }
        .link-input {
            flex: 1;
            padding: 8px;
            font-size: 0.875rem;
        }
        .btn-link {
            padding: 8px 12px;
            font-size: 0.8rem;
        }

        .btn-link:disabled {
            background-color: #9ca3af !important;
            color: #6b7280 !important;
            cursor: not-allowed !important;
            opacity: 0.6;
        }

        .btn-link:disabled:hover {
            background-color: #9ca3af !important;
            transform: none !important;
        }

        .link-salvo {
            background-color: #f3f4f6 !important;
            color: #6b7280 !important;
            cursor: not-allowed !important;
            border: 1px solid #d1d5db;
        }

        #login-form input {
            height: 50px;
            width: 100%;
            padding: 12px 16px;
            font-size: 16px;
        }

        #login-form button {
            padding: 10px 30px;
            font-size: 16px;
            width: auto;
            margin: 10px auto 0 auto;
            display: block;
            height: auto;
        }

        #login {
            max-width: 500px;
            margin: 0 auto;
            padding: 2rem;
        }

        .acoes-column button {
            margin: 0 4px;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .btn-editar {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-editar:hover {
            background-color: #2563eb;
        }

        .btn-excluir {
            background-color: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-excluir:hover {
            background-color: #dc2626;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item label {
            margin-bottom: 0;
            min-width: auto;
        }

        .user-info-container {
            text-align: center;
            margin: 10px 0;
            padding: 0 20px;
            line-height: 1.5;
        }

        .user-info-text {
            font-size: 14px;
            color: #4b5563;
        }

        .user-info-name {
            font-weight: 600;
            color: #CC0000;
        }

        .header-content {
            position: relative;
            padding-bottom: 15px;
        }

        .btn-relatorio {
            background-color: #10b981;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
            margin-left: 10px;
        }

        .btn-relatorio:hover {
            background-color: #059669;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .btn-turma {
            background-color: #CC0000;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
            margin: 5px;
        }

        .btn-turma:hover {
            background-color: #A00000;
        }

        .table-header-white th {
            color: white !important;
            background-color: #CC0000 !important;
        }

        /* ESTILOS PARA LOADING */
        .spinner {
            border: 2px solid #f3f3f3;
            border-radius: 50%;
            border-top: 2px solid #CC0000;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #6b7280;
        }

        .tarefa-loading {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            background: linear-gradient(90deg, #f9fafb 25%, #f3f4f6 50%, #f9fafb 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .btn-loading {
            position: relative;
            color: transparent;
        }

        .btn-loading::after {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        /* ESTILOS PARA CARREGAMENTO GRADUAL */
        .cache-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background-color: #10b981;
            transition: width 0.3s ease;
        }

        .aluno-loading {
            background: linear-gradient(90deg, #f9fafb 25%, #f3f4f6 50%, #f9fafb 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        .nota-loading {
            display: inline-block;
            width: 40px;
            height: 20px;
            background-color: #f3f4f6;
            border-radius: 4px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        /* ESTILOS PARA O RELATÓRIO */
        .relatorio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .relatorio-info {
            font-size: 14px;
            color: #6b7280;
            margin-top: 5px;
        }
        
        .relatorio-status {
            background-color: #f3f4f6;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
            border-left: 4px solid #3b82f6;
        }
        
        /* ESTILOS PARA RETENÇÃO E CONTEÚDO CONDICIONAL */
        .retencao-aviso {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .retencao-50 {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .retencao-25 {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .retencao-15 {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .retencao-10 {
            background-color: #e0e7ff;
            color: #3730a3;
        }
        
        .conteudo-bloqueado {
            color: #6b7280;
            font-style: italic;
            padding: 8px;
            background-color: #f9fafb;
            border-radius: 4px;
            margin-top: 8px;
        }

        /* ESTILOS PARA INFORMAÇÕES ADICIONAIS */
        .instrucoes-box {
            background-color: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .instrucoes-title {
            color: #0369a1;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .instrucoes-list {
            list-style-type: decimal;
            padding-left: 20px;
            margin-bottom: 0;
        }

        .instrucoes-list li {
            margin-bottom: 8px;
        }

        .fundamento-cientifico {
            background-color: #fefce8;
            border: 1px solid #fef08a;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }

        .fundamento-title {
            color: #854d0e;
            font-weight: 600;
            margin-bottom: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
        }

        .fundamento-title:hover {
            color: #713f12;
        }

        .fundamento-content {
            display: none;
        }

        .fundamento-content.expandido {
            display: block;
        }

        .fundamento-list {
            list-style-type: decimal;
            padding-left: 20px;
            margin-bottom: 16px;
        }

        .fundamento-list li {
            margin-bottom: 8px;
        }

        .referencias {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 16px;
        }

        .referencias-title {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .referencias-list {
            list-style-type: none;
            padding-left: 0;
        }

        .referencias-list li {
            margin-bottom: 4px;
        }

        .imagem-curva {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin: 12px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .expand-icon {
            transition: transform 0.3s ease;
        }

        .expand-icon.expandido {
            transform: rotate(180deg);
        }

        .info-nota {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 4px;
            font-style: italic;
        }
        
        .conteudo-formatado {
            white-space: pre-line;
            line-height: 1.6;
            margin-top: 8px;
        }
        
        .conteudo-formatado ul, .conteudo-formatado ol {
            margin-left: 20px;
            margin-top: 8px;
            margin-bottom: 8px;
        }
        
        .conteudo-formatado li {
            margin-bottom: 4px;
        }
        
        .btn-formatacao {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .btn-formatacao:hover {
            background-color: #e5e7eb;
        }
        
        .btn-atualizar-dados {
            background-color: #3b82f6;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
            margin-top: 10px;
        }
        
        .btn-atualizar-dados:hover {
            background-color: #2563eb;
        }
        
        .btn-atualizar-dados:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        
        .horario-info {
            font-size: 0.75rem;
            margin-top: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            text-align: center;
        }
        
        .horario-maxima {
            background-color: #d1fae5;
            color: #065f46;
            font-weight: 600;
        }
        
        .horario-regular {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .horario-fora {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .tarefa-atualizada {
            animation: highlight 2s ease;
        }

        @keyframes highlight {
            0% { background-color: #d1fae5; }
            100% { background-color: transparent; }
        }

        .btn-exportar {
            background-color: #059669;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
            margin-left: 10px;
        }

        .btn-exportar:hover {
            background-color: #047857;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }

        .numero-coluna {
            width: 50px;
            text-align: center;
        }

        .media-coluna {
            width: 100px;
            text-align: center;
            font-weight: bold;
        }

        .password-container {
            position: relative;
            width: 100%;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #6b7280;
            z-index: 10;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .password-toggle:hover {
            color: #374151;
        }

        .password-container input {
            padding-right: 40px;
        }

        .turma-info {
            background-color: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
        }

        .turma-title {
            color: #0369a1;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .turma-stats {
            display: flex;
            gap: 16px;
            font-size: 0.875rem;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-value {
            font-weight: 700;
            color: #0369a1;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.75rem;
        }

        .debug-info {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            font-size: 0.75rem;
            color: #6b7280;
        }

        .debug-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #374151;
        }

        /* ESTILOS PARA O PAINEL DE DIAGNÓSTICO */
        .btn-diagnostico {
            background-color: #8b5cf6;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
            margin-left: 10px;
        }

        .btn-diagnostico:hover {
            background-color: #7c3aed;
        }

        .test-result {
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }

        .test-success {
            background-color: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }

        .test-warning {
            background-color: #fef3c7;
            border: 1px solid #fde68a;
            color: #92400e;
        }

        .test-error {
            background-color: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }

        .test-info {
            background-color: #dbeafe;
            border: 1px solid #bfdbfe;
            color: #1e40af;
        }

        .diagnostico-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .diagnostico-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            background-color: white;
        }

        .diagnostico-card h4 {
            margin-top: 0;
            margin-bottom: 12px;
            color: #374151;
        }

        .log-entry {
            font-family: monospace;
            font-size: 0.75rem;
            background-color: #f9fafb;
            padding: 8px;
            border-radius: 4px;
            margin: 4px 0;
            border-left: 3px solid #d1d5db;
        }

        .log-success {
            border-left-color: #10b981;
        }

        .log-warning {
            border-left-color: #f59e0b;
        }

        .log-error {
            border-left-color: #ef4444;
        }

        .link-externo {
            display: block;
            padding: 8px 12px;
            background-color: #f3f4f6;
            border-radius: 4px;
            margin: 4px 0;
            text-decoration: none;
            color: #374151;
            transition: background-color 0.2s;
        }

        .link-externo:hover {
            background-color: #e5e7eb;
        }

        /* NOVOS ESTILOS PARA LOGIN */
        .email-container {
            display: flex;
            width: 100%;
        }
        .email-prefix {
            flex: 1;
        }
        .email-suffix {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            border-left: none;
            border-radius: 0 8px 8px 0;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            color: #6b7280;
            font-weight: 500;
        }
        .email-prefix input {
            border-radius: 8px 0 0 8px !important;
        }

        /* NOVOS ESTILOS PARA O RELATÓRIO COM PARTES */
        .parte-column {
            width: 60px;
            text-align: center;
            font-size: 0.75rem;
        }

        .media-tarefa-column {
            width: 70px;
            text-align: center;
            font-weight: bold;
        }

        .header-tarefa {
            background-color: #CC0000;
            color: white;
            text-align: center;
            font-weight: bold;
        }

        .subheader-tarefa {
            background-color: #e53e3e;
            color: white;
            text-align: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .tarefa-group {
            border-right: 2px solid #c53030;
        }

        .tarefa-group:last-child {
            border-right: none;
        }

        /* CORREÇÃO DO ÍCONE DO OLHO - SOLUÇÃO ALTERNATIVA */
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #6b7280;
            z-index: 10;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .password-toggle:focus {
            outline: none;
        }

        /* NOVO LAYOUT PARA OS BOTÕES DE TURMA */
        .turmas-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .turmas-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .btn-turma-compact {
            background-color: #CC0000;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
            min-width: 40px;
            text-align: center;
        }

        .btn-turma-compact:hover {
            background-color: #A00000;
        }

        .btn-turma-compact.active {
            background-color: #A00000;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #CC0000;
        }

        .export-buttons-container {
            display: flex;
            gap: 10px;
        }

        /* CORREÇÃO DO ÍCONE DO OLHO - MELHOR SOLUÇÃO */
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #6b7280;
            z-index: 10;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .password-toggle:hover {
            color: #374151;
        }

        .password-toggle:focus {
            outline: none;
        }

        .password-container input {
            padding-right: 40px;
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 sm:p-8">

<div id="app-container" class="w-full max-w-6xl bg-white shadow-xl rounded-2xl p-6 sm:p-8 transition-all duration-300">
    <header class="mb-8 border-b pb-4">
        <div class="header-content">
            <h1 class="text-3xl font-extrabold text-red-700 text-center">Gestão de Tarefas Escolar</h1>
            <div id="user-info" class="user-info-container"></div>
            <div class="absolute top-0 right-0 flex space-x-2">
                <button id="diagnosticoBtn" class="btn-diagnostico hidden">Diagnóstico</button>
                <button id="relatorioBtn" class="btn-relatorio hidden">Relatório</button>
                <button onclick="logout()" id="logoutBtn" class="btn-secondary hidden">Sair</button>
            </div>
        </div>
    </header>

    <div id="content-area"></div>

    <footer class="mt-8 pt-4 border-t text-xs text-gray-500 text-center">
        Desenvolvido por Geovane Modena | Versão 9.5
    </footer>
</div>

<!-- Modal para mensagens -->
<div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full shadow-2xl">
        <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-600"></h3>
        <p id="modal-message" class="text-gray-700 mb-4 whitespace-pre-wrap"></p>
        <button onclick="closeModal()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition">OK</button>
    </div>
</div>

<!-- Modal de confirmação para exclusão -->
<div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full shadow-2xl">
        <h3 class="text-xl font-bold mb-3 text-red-600">Confirmar Exclusão</h3>
        <p id="confirm-message" class="text-gray-700 mb-4">Tem certeza que deseja excluir esta tarefa?</p>
        <div class="flex space-x-4">
            <button id="confirm-cancel" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded transition">Cancelar</button>
            <button id="confirm-delete" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition">Excluir</button>
        </div>
    </div>
</div>

<script>
/* ==================== CONFIGURAÇÃO GERAL ==================== */
const API_URL = "https://script.google.com/macros/s/AKfycbzKymbA3QgIdhBw7AfUJQveK3l3gbzT-2eccOJpF1K4E-HrEc51pefiJFWCEnDWZm4V/exec";
const SECURITY_TOKEN = 'SESI_EDUCATION_2024';

// limites de texto
const MAX_TEMA_LEN = 200;
const MAX_PARTE_LEN = 4000;

// --- ESTADO DA APLICAÇÃO ---
let usuarios = [];
let usuarioLogado = null;
let tarefas = [];
let jsonpCallbackId = 0;
let tarefaParaExcluir = null;
let contadoresAtivos = [];
let tarefaEditando = null;
let rmVisible = false;

// --- RATE LIMITING SIMPLES ---
const rateLimiter = {
    last: {},
    minIntervalMs: 2000,
    canRun(action) {
        const now = Date.now();
        const last = this.last[action] || 0;
        if (now - last < this.minIntervalMs) {
            return false;
        }
        this.last[action] = now;
        return true;
    }
};

// --- SISTEMA DE CACHE NO FRONTEND ---
const frontendCache = {
    get: (key) => {
        try {
            const item = localStorage.getItem(`task_${key}`);
            if (item) {
                const { data, expiry } = JSON.parse(item);
                if (Date.now() > expiry) {
                    localStorage.removeItem(`task_${key}`);
                    return null;
                }
                return data;
            }
        } catch (e) {
            console.warn('Erro ao acessar cache local:', e);
        }
        return null;
    },
    
    set: (key, data, ttl = 5 * 60 * 1000) => {
        try {
            const item = {
                data,
                expiry: Date.now() + ttl
            };
            localStorage.setItem(`task_${key}`, JSON.stringify(item));
            return true;
        } catch (e) {
            console.warn('LocalStorage não disponível:', e);
            return false;
        }
    },
    
    remove: (key) => {
        try {
            localStorage.removeItem(key.startsWith('task_') ? key : `task_${key}`);
        } catch (e) {
            console.warn('Erro ao remover do cache local:', e);
        }
    },
    
    clear: () => {
        try {
            const keys = Object.keys(localStorage).filter(k => k.startsWith('task_'));
            keys.forEach(k => localStorage.removeItem(k));
        } catch (e) {
            console.warn('Erro ao limpar cache local:', e);
        }
    }
};

// --- DEBOUNCE FUNCTION ---
function debounce(func, wait, immediate = false) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            timeout = null;
            if (!immediate) func(...args);
        };
        const callNow = immediate && !timeout;
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
        if (callNow) func(...args);
    };
}

// --- ELEMENTOS DOM ---
const contentArea = document.getElementById('content-area');
const userInfoDisplay = document.getElementById('user-info');
const logoutBtn = document.getElementById('logoutBtn');
const relatorioBtn = document.getElementById('relatorioBtn');
const diagnosticoBtn = document.getElementById('diagnosticoBtn');
const modalOverlay = document.getElementById('modal-overlay');
const modalTitle = document.getElementById('modal-title');
const modalMessage = document.getElementById('modal-message');
const confirmModal = document.getElementById('confirm-modal');
const confirmMessage = document.getElementById('confirm-message');
const confirmCancel = document.getElementById('confirm-cancel');
const confirmDelete = document.getElementById('confirm-delete');

/* ==================== FUNÇÕES UTILITÁRIAS ==================== */

const showModal = (title, message) => {
    modalTitle.textContent = title;
    modalMessage.textContent = message;
    modalOverlay.classList.remove('hidden');
    modalOverlay.classList.add('flex');
};

const closeModal = () => modalOverlay.classList.add('hidden');

const showConfirmModal = (message, onConfirm) => {
    confirmMessage.textContent = message;
    confirmModal.classList.remove('hidden');
    confirmModal.classList.add('flex');
    
    confirmCancel.onclick = () => {
        confirmModal.classList.add('hidden');
        tarefaParaExcluir = null;
    };
    
    confirmDelete.onclick = () => {
        confirmModal.classList.add('hidden');
        if (onConfirm) onConfirm();
        tarefaParaExcluir = null;
    };
};

const renderIcons = () => {
    const eyeIcon = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
        <circle cx="12" cy="12" r="3"></circle>
    </svg>`;
    
    const eyeOffIcon = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
        <line x1="1" y1="1" x2="23" y2="23"></line>
    </svg>`;
    
    window.eyeIcons = { eye: eyeIcon, eyeOff: eyeOffIcon };
};

const formatarData = (dataISO) => {
    if (!dataISO) return 'N/A';
    
    let data = new Date(dataISO);
    if (isNaN(data.getTime())) {
        const partes = dataISO.split('-');
        if (partes.length === 3) {
            data = new Date(partes[0], partes[1] - 1, partes[2]);
        }
    }
    
    return data.toLocaleDateString('pt-BR');
};

function formatarConteudoParaExibicao(texto) {
    if (!texto) return '';
    const textoStr = String(texto);
    return textoStr
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}
const escapeHTML = formatarConteudoParaExibicao;

// sanitização anti-fórmula (Excel/CSV injection)
function sanitizeForSheet(str) {
    if (!str) return '';
    const s = String(str);
    const trimmed = s.trimStart();
    if (/^[=+\-@]/.test(trimmed)) {
        return "'" + s;
    }
    return s;
}

function adicionarFormatacao(parteId, tipo) {
    const textarea = document.getElementById(parteId);
    const inicio = textarea.selectionStart;
    const fim = textarea.selectionEnd;
    const textoSelecionado = textarea.value.substring(inicio, fim);
    
    let textoFormatado = '';
    let novoInicio = inicio;
    let novoFim = fim;
    
    switch(tipo) {
        case 'urls':
            if (textoSelecionado) {
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                textoFormatado = textoSelecionado.replace(urlRegex, '<a href="$1" target="_blank">$1</a>');
            } else {
                textoFormatado = 'https://exemplo.com';
                novoFim = inicio + 19;
            }
            break;
        case 'lista':
            if (textoSelecionado) {
                const linhas = textoSelecionado.split('\n');
                textoFormatado = linhas.map(linha => linha.trim() ? `• ${linha}` : '').join('\n');
            } else {
                textoFormatado = '• ';
                novoFim = inicio + 2;
            }
            break;
        case 'numerada':
            if (textoSelecionado) {
                const linhas = textoSelecionado.split('\n');
                textoFormatado = linhas.map((linha, index) => linha.trim() ? `${index + 1}. ${linha}` : '').join('\n');
            } else {
                textoFormatado = '1. ';
                novoFim = inicio + 3;
            }
            break;
    }
    
    textarea.value = textarea.value.substring(0, inicio) + textoFormatado + textarea.value.substring(fim);
    
    textarea.focus();
    textarea.setSelectionRange(novoInicio, novoFim);
}

function criarBotoesFormatacao(parteId) {
    return `
        <div class="mt-2">
            <button type="button" class="btn-formatacao" onclick="adicionarFormatacao('${parteId}', 'urls')">Transformar URLs em Links</button>
            <button type="button" class="btn-formatacao" onclick="adicionarFormatacao('${parteId}', 'lista')">Lista com Marcadores</button>
            <button type="button" class="btn-formatacao" onclick="adicionarFormatacao('${parteId}', 'numerada')">Lista Numerada</button>
        </div>
    `;
}

function setButtonLoading(button, isLoading) {
    if (!button) return;
    if (isLoading) {
        button.disabled = true;
        button.classList.add('btn-loading');
    } else {
        button.disabled = false;
        button.classList.remove('btn-loading');
    }
}

function mostrarLoadingTarefasAluno() {
    const container = document.getElementById('tarefas-aluno-container');
    if (!container) return;
    
    container.innerHTML = `
        <div class="space-y-4">
            <div class="tarefa-loading" style="height: 120px;"></div>
            <div class="tarefa-loading" style="height: 120px;"></div>
            <div class="tarefa-loading" style="height: 120px;"></div>
            <div class="loading-text">
                <div class="spinner"></div>
                Carregando tarefas...
            </div>
        </div>
    `;
}

function mostrarLoadingRelatorio() {
    const container = document.getElementById('relatorio-turma-container');
    if (!container) return;
    
    container.innerHTML = `
        <div class="loading-text py-8">
            <div class="spinner"></div>
            Carregando relatório...
        </div>
    `;
}

/* ==================== LÓGICA DE TEMPO (ALINHADA COM BACK) ==================== */
/*
    Parte 1: apenas dia da aula (13h–22h).
    Parte 2: apenas o 7º dia após a aula (13h–22h).
    Parte 3: apenas o 14º dia após a aula (13h–22h).
    Parte 4: apenas o 28º dia após a aula (13h–22h).
*/

function calcularStatusParteDiaUnico(dataAula, diasOffset) {
    const agora = new Date();
    const base = new Date(dataAula);

    if (isNaN(base.getTime())) {
        return {
            texto: 'Data inválida',
            classe: 'aguardando',
            liberada: false,
            expirado: false,
            dentroHorarioEntrega: false
        };
    }

    base.setHours(0, 0, 0, 0);
    const diaEntrega = new Date(base);
    diaEntrega.setDate(diaEntrega.getDate() + diasOffset);

    const inicio = new Date(diaEntrega);
    inicio.setHours(13, 0, 0, 0);

    const fim = new Date(diaEntrega);
    fim.setHours(22, 0, 0, 0);

    if (agora < inicio) {
        const diff = inicio - agora;
        const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
        const horas = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutos = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

        let texto = '';
        if (dias > 0) texto = `Libera em ${dias}d ${horas}h`;
        else if (horas > 0) texto = `Libera em ${horas}h ${minutos}m`;
        else texto = `Libera em ${minutos}m`;

        return {
            texto,
            classe: 'aguardando',
            liberada: false,
            expirado: false,
            dentroHorarioEntrega: false
        };
    }

    if (agora > fim) {
        return {
            texto: 'Expirado',
            classe: 'expirado',
            liberada: false,
            expirado: true,
            dentroHorarioEntrega: false
        };
    }

    // Dentro do único dia de entrega (13h–22h)
    const diffFim = fim - agora;
    const horasFim = Math.floor(diffFim / (1000 * 60 * 60));
    const minutosFim = Math.floor((diffFim % (1000 * 60 * 60)) / (1000 * 60));
    let texto = '';
    if (horasFim > 0) texto = `Termina em ${horasFim}h ${minutosFim}m`;
    else texto = `Termina em ${minutosFim}m`;

    return {
        texto,
        classe: 'disponivel',
        liberada: true,
        expirado: false,
        dentroHorarioEntrega: true
    };
}

function calcularContadoresOtimizado(dataAula) {
    return {
        parte1: calcularStatusParteDiaUnico(dataAula, 0),
        parte2: calcularStatusParteDiaUnico(dataAula, 7),
        parte3: calcularStatusParteDiaUnico(dataAula, 14),
        parte4: calcularStatusParteDiaUnico(dataAula, 28)
    };
}

// --- CONTADORES OTIMIZADOS ---
function iniciarAtualizacaoContadoresOtimizada() {
    contadoresAtivos.forEach(interval => clearInterval(interval));
    contadoresAtivos = [];
    
    const interval = setInterval(() => {
        if (usuarioLogado && usuarioLogado.Perfil === 'Aluno') {
            atualizarContadoresAlunoOtimizado();
        }
    }, 1000);
    
    contadoresAtivos.push(interval);
}

function atualizarContadoresAlunoOtimizado() {
    const containers = document.querySelectorAll('#tarefas-aluno-container > div');
    
    containers.forEach(container => {
        if (!isElementInViewport(container)) return;
        
        const tema = container.querySelector('h4')?.textContent;
        if (!tema) return;
        
        const tarefa = tarefas.find(t => t.Tema === tema);
        if (tarefa) {
            const contadores = calcularContadoresOtimizado(tarefa.DataAula);
            
            [1, 2, 3, 4].forEach(parte => {
                const contadorElement = container.querySelector(`.parte-${parte} .contador`);
                if (contadorElement) {
                    const contador = contadores[`parte${parte}`];
                    if (contadorElement.textContent !== contador.texto) {
                        contadorElement.textContent = contador.texto;
                        contadorElement.className = `contador ${contador.classe}`;
                    }
                }
            });
        }
    });
}

function isElementInViewport(el) {
    const rect = el.getBoundingClientRect();
    return (
        rect.top >= 0 &&
        rect.left >= 0 &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
        rect.right <= (window.innerWidth || document.documentElement.clientWidth)
    );
}

/* ==================== API JSONP ==================== */

function apiRequestJSONP(url, callback) {
    const callbackName = 'jsonp_callback_' + jsonpCallbackId++;
    
    const timeout = setTimeout(() => {
        if (window[callbackName]) {
            delete window[callbackName];
            callback(new Error('Timeout: A requisição demorou muito para responder'));
        }
    }, 15000);
    
    window[callbackName] = function(data) {
        clearTimeout(timeout);
        delete window[callbackName];
        if (script.parentNode) {
            document.body.removeChild(script);
        }
        callback(null, data);
    };
    
    const script = document.createElement('script');
    script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;
    script.onerror = function() {
        clearTimeout(timeout);
        delete window[callbackName];
        if (script.parentNode) {
            document.body.removeChild(script);
        }
        callback(new Error('Falha ao carregar o script. Verifique sua conexão.'));
    };
    
    document.body.appendChild(script);
}

async function apiGet(func, params = {}, forceRefresh = false) {
    const cacheKey = `api_${func}_${JSON.stringify(params)}`;
    
    if (!forceRefresh) {
        const cached = frontendCache.get(cacheKey);
        if (cached) {
            return cached;
        }
    }
    
    return new Promise((resolve, reject) => {
        let url = `${API_URL}?token=${SECURITY_TOKEN}`;
        
        if (func) {
            url += `&func=${func}`;
        }
        
        for (const key in params) {
            if (params[key] !== undefined && params[key] !== null) {
                url += `&${key}=${encodeURIComponent(params[key])}`;
            }
        }
        
        if (forceRefresh) {
            url += `&_=${Date.now()}`;
        }
        
        apiRequestJSONP(url, (error, data) => {
            if (error) {
                reject(error);
            } else if (data && data.success === false) {
                reject(new Error(data.error));
            } else {
                frontendCache.set(cacheKey, data, 2 * 60 * 1000);
                resolve(data);
            }
        });
    });
}

async function apiPost(action, dados) {
    return new Promise((resolve, reject) => {
        let url = `${API_URL}?token=${SECURITY_TOKEN}&action=${action}`;
        
        for (const key in dados) {
            if (dados[key] !== undefined && dados[key] !== null) {
                if (Array.isArray(dados[key])) {
                    url += `&${key}=${encodeURIComponent(JSON.stringify(dados[key]))}`;
                } else {
                    url += `&${key}=${encodeURIComponent(dados[key])}`;
                }
            }
        }
        
        apiRequestJSONP(url, (error, data) => {
            if (error) {
                reject(error);
            } else if (data && data.success === false) {
                reject(new Error(data.error));
            } else {
                resolve(data);
            }
        });
    });
}

/* ==================== INICIALIZAÇÃO E LOGIN ==================== */

async function init() {
    renderIcons();
    
    try {
        console.log('Carregando usuários (forceRefresh)...');
        const response = await apiGet('getUsers', {}, true);
        usuarios = response.data || response;
        console.log('Usuários carregados:', usuarios.length);
    } catch (error) {
        console.error('Erro ao carregar usuários:', error);
        usuarios = [];
        showModal('Aviso', 'Não foi possível carregar a lista de usuários. Verifique sua conexão.');
    }
    
    renderLogin();
}

function toggleRmVisibility() {
    const senhaInput = document.getElementById('senha');
    const toggleButton = document.getElementById('toggleSenha');
    
    rmVisible = !rmVisible;
    
    if (rmVisible) {
        senhaInput.type = 'text';
        toggleButton.innerHTML = window.eyeIcons.eyeOff;
    } else {
        senhaInput.type = 'password';
        toggleButton.innerHTML = window.eyeIcons.eye;
    }
}

const renderLogin = () => {
    contentArea.innerHTML = `
        <div id="login" class="max-w-md mx-auto p-6">
            <h2 class="text-2xl font-bold text-center text-red-700 mb-6">Login</h2>
            <div id="loginErro" class="text-red-500 mb-4 hidden text-center font-semibold">Usuário ou senha incorretos!</div>

            <form id="login-form" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">E-mail</label>
                    <div class="email-container">
                        <div class="email-prefix">
                            <input type="text" id="email" name="email" required placeholder="nome.sobrenome" class="w-full p-3 border rounded-lg rounded-r-none">
                        </div>
                        <div class="email-suffix">
                            @portalsesisp.org.br
                        </div>
                    </div>
                </div>
                <div>
                    <label for="senha" class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                    <div class="password-container">
                        <input type="password" id="senha" name="senha" required placeholder="" class="w-full p-3 border rounded-lg pr-10">
                        <button type="button" class="password-toggle" id="toggleSenha">
                            ${window.eyeIcons.eye}
                        </button>
                    </div>
                </div>
                <button type="submit" class="btn-primary w-full py-3" id="login-button">
                    <span id="login-text">Entrar</span>
                </button>
            </form>
        </div>
    `;

    document.getElementById('toggleSenha').addEventListener('click', toggleRmVisibility);

    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await login(e);
    });
};

async function login(event) {
    event.preventDefault(); 
    const emailPrefix = document.getElementById('email').value.trim();
    const senha = document.getElementById('senha').value.trim();
    
    // Concatenar o prefixo com o domínio fixo
    const email = `${emailPrefix}@portalsesisp.org.br`;
    
    const loginErro = document.getElementById('loginErro'); 
    const loginButton = document.getElementById('login-button');
    const loginText = document.getElementById('login-text');
    
    loginButton.disabled = true;
    loginText.textContent = "Entrando...";
    
    // Se não temos usuários carregados, tenta de novo com forceRefresh
    if (!usuarios || usuarios.length === 0) {
        try {
            const response = await apiGet('getUsers', {}, true);
            usuarios = response.data || response;
        } catch (e) {
            console.error('Erro ao recarregar usuários no login:', e);
        }
    }
    
    console.log('Tentando login com:', { email, senha });
    
    await new Promise(resolve => setTimeout(resolve, 300));
    
    // Verifica se o e-mail existe
    const userByEmail = usuarios.find(u => {
        const userEmail = String(u.Email || '').toLowerCase().trim();
        const inputEmail = email.toLowerCase().trim();
        return userEmail === inputEmail;
    });

    if (!userByEmail) {
        console.log('E-mail não encontrado');
        loginErro.textContent = 'E-mail não encontrado!';
        loginErro.style.display = 'block';
        loginButton.disabled = false;
        loginText.textContent = "Entrar";
        return;
    }

    // Verifica se o RM corresponde
    const user = usuarios.find(u => {
        const userEmail = String(u.Email || '').toLowerCase().trim();
        const userRM = String(u.RM || '').trim();
        const inputEmail = email.toLowerCase().trim();
        const inputRM = senha.trim();
        
        return userEmail === inputEmail && userRM === inputRM;
    });
    
    if (!user) {
        console.log('Senha incorreta');
        loginErro.textContent = 'Senha incorreta para este e-mail!';
        loginErro.style.display = 'block';
        loginButton.disabled = false;
        loginText.textContent = "Entrar";
        return;
    }
    
    usuarioLogado = user;
    loginErro.style.display = 'none';
    
    contentArea.innerHTML = `<div class="text-center text-gray-500 py-8"><div class="spinner"></div>Carregando painel...</div>`;
    logoutBtn.classList.remove('hidden');
    relatorioBtn.classList.remove('hidden');
    
    if (user.Perfil === "Professor") {
        userInfoDisplay.innerHTML = `
            <div class="user-info-text">
                Logado como: <span class="user-info-name">${escapeHTML(user.NomeCompleto)} (${user.Perfil})</span>
            </div>
        `;
        relatorioBtn.onclick = mostrarRelatorioProfessor;
        diagnosticoBtn.classList.remove('hidden');
        diagnosticoBtn.onclick = mostrarPainelDiagnostico;
    } else {
        userInfoDisplay.innerHTML = `
            <div class="user-info-text">
                Logado como: <span class="user-info-name">${escapeHTML(user.NomeCompleto)} (${user.Perfil})</span> | Turma: ${escapeHTML(user.Turma || 'N/A')} | Nº: ${escapeHTML(user.Numero || 'N/A')}
            </div>
        `;
        relatorioBtn.onclick = mostrarRelatorioAluno;
        diagnosticoBtn.classList.add('hidden');
    }

    try {
        const response = await apiGet('getTarefas', {}, true);
        tarefas = response.data || [];
        console.log('Tarefas carregadas:', tarefas.length);
    } catch (error) {
        console.error('Erro ao carregar tarefas:', error);
        tarefas = [];
        showModal('Aviso', 'Algumas funcionalidades podem estar limitadas devido a problemas de conexão.');
    }

    if (user.Perfil === "Professor") {
        await mostrarPainelProfessor();
    } else {
        await mostrarPainelAluno(); 
    }
    
    loginButton.disabled = false;
    loginText.textContent = "Entrar";
}

function logout() {
    usuarioLogado = null;
    tarefaEditando = null;
    logoutBtn.classList.add('hidden');
    relatorioBtn.classList.add('hidden');
    diagnosticoBtn.classList.add('hidden');
    userInfoDisplay.innerHTML = '';
    contadoresAtivos.forEach(interval => clearInterval(interval));
    contadoresAtivos = [];
    frontendCache.clear();
    renderLogin(); 
}

/* ==================== PAINEL DE DIAGNÓSTICO ==================== */

async function mostrarPainelDiagnostico() {
    contentArea.innerHTML = `
        <div class="card p-6">
            <h3 class="text-2xl font-bold text-red-700 mb-4">Painel de Diagnóstico</h3>
            
            <div class="diagnostico-grid">
                <div class="diagnostico-card">
                    <h4>Teste de Conexão</h4>
                    <button onclick="testarConexaoCompleta()" class="btn-primary w-full mb-3">Testar Conexão Completa</button>
                    <div id="resultado-conexao"></div>
                </div>
                
                <div class="diagnostico-card">
                    <h4>Verificar Estrutura de Dados</h4>
                    <button onclick="verificarEstruturaDados()" class="btn-primary w-full mb-3">Verificar Estrutura</button>
                    <div id="resultado-estrutura"></div>
                </div>
                
                <div class="diagnostico-card">
                    <h4>Testar Funcionalidades</h4>
                    <button onclick="testarFuncionalidades()" class="btn-primary w-full mb-3">Testar Funcionalidades</button>
                    <div id="resultado-funcionalidades"></div>
                </div>
                
                <div class="diagnostico-card">
                    <h4>Verificar Usuários</h4>
                    <button onclick="verificarUsuarios()" class="btn-primary w-full mb-3">Verificar Usuários</button>
                    <div id="resultado-usuarios"></div>
                </div>
                
                <div class="diagnostico-card">
                    <h4>Criar Tarefas de Teste</h4>
                    <button onclick="criarTarefasTeste()" class="btn-primary w-full mb-3">Criar Tarefas de Teste</button>
                    <div id="resultado-tarefas-teste"></div>
                </div>
            </div>
            
            <div class="mt-6">
                <h4 class="font-semibold text-lg mb-3">Links para Verificação</h4>
                <div class="space-y-2">
                    <a href="https://docs.google.com/spreadsheets/d/1M1CV4wDyV0kktu5N3CBOmC5O5dRc-9J9Xw-XxXnJ6_E/edit" target="_blank" class="link-externo">
                        📊 Planilha USERS (Verificar estrutura e dados)
                    </a>
                    <a href="https://docs.google.com/spreadsheets/d/1M1CV4wDyV0kktu5N3CBOmC5O5dRc-9J9Xw-XxXnJ6_E/edit#gid=1135465325" target="_blank" class="link-externo">
                        📊 Planilha TAREFAS
                    </a>
                    <a href="https://docs.google.com/spreadsheets/d/1M1CV4wDyV0kktu5N3CBOmC5O5dRc-9J9Xw-XxXnJ6_E/edit#gid=2132814578" target="_blank" class="link-externo">
                        📊 Planilha ENTREGAS
                    </a>
                    <a href="https://script.google.com/home/projects/1M1CV4wDyV0kktu5N3CBOmC5O5dRc-9J9Xw-XxXnJ6_E/edit" target="_blank" class="link-externo">
                        🔧 Google Apps Script (Backend)
                    </a>
                </div>
            </div>
            
            <div class="mt-6">
                <h4 class="font-semibold text-lg mb-3">Log de Diagnóstico</h4>
                <div id="log-diagnostico" class="space-y-2 max-h-60 overflow-y-auto p-3 bg-gray-50 rounded border">
                    <!-- Logs serão inseridos aqui -->
                </div>
            </div>
            
            <div class="mt-6 text-center">
                <button onclick="mostrarPainelProfessor()" class="btn-secondary">Voltar ao Painel</button>
            </div>
        </div>
    `;
}

function adicionarLog(mensagem, tipo = 'info') {
    const logContainer = document.getElementById('log-diagnostico');
    if (!logContainer) return;
    
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry log-${tipo}`;
    logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${mensagem}`;
    
    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;
}

async function testarConexaoCompleta() {
    const resultado = document.getElementById('resultado-conexao');
    resultado.innerHTML = '<div class="spinner"></div> Testando conexão completa...';
    
    adicionarLog('Iniciando teste de conexão completa...', 'info');
    
    try {
        // Testar conexão com cada planilha
        const [usersResponse, tarefasResponse, entregasResponse] = await Promise.all([
            apiGet('getUsers', {}, true),
            apiGet('getTarefas', {}, true),
            apiGet('getEntregas', {}, true)
        ]);

        const users = usersResponse.data || usersResponse;
        const tarefas = tarefasResponse.data || tarefasResponse;
        const entregas = entregasResponse.data || entregasResponse;

        adicionarLog(`✓ Conexão com USERS: ${users.length} registros`, 'success');
        adicionarLog(`✓ Conexão com TAREFAS: ${tarefas.length} registros`, 'success');
        adicionarLog(`✓ Conexão com ENTREGAS: ${entregas.length} registros`, 'success');

        resultado.innerHTML = `
            <div class="test-result test-success">
                <strong>✓ Conexão bem-sucedida com todas as planilhas!</strong><br>
                - Usuários: ${users.length} registros<br>
                - Tarefas: ${tarefas.length} registros<br>
                - Entregas: ${entregas.length} registros<br><br>
                <strong>URL da API:</strong> ${API_URL}
            </div>
        `;
        
        adicionarLog('Teste de conexão completo: SUCESSO', 'success');
    } catch (error) {
        adicionarLog(`✗ Erro na conexão: ${error.message}`, 'error');
        resultado.innerHTML = `
            <div class="test-result test-error">
                <strong>✗ Erro na conexão:</strong> ${escapeHTML(error.message)}<br><br>
                <strong>Possíveis causas:</strong><br>
                - Planilha não compartilhada publicamente<br>
                - Problema no Google Apps Script<br>
                - Token de segurança incorreto<br>
                - Problema de rede<br><br>
                <strong>URL da API:</strong> ${API_URL}
            </div>
        `;
    }
}

async function verificarEstruturaDados() {
    const resultado = document.getElementById('resultado-estrutura');
    resultado.innerHTML = '<div class="spinner"></div> Verificando estrutura...';
    
    adicionarLog('Verificando estrutura de dados...', 'info');
    
    try {
        const usersResponse = await apiGet('getUsers', {}, true);
        const users = usersResponse.data || usersResponse;

        if (users.length === 0) {
            adicionarLog('✗ Nenhum usuário encontrado na planilha', 'error');
            resultado.innerHTML = '<div class="test-result test-error">Nenhum usuário encontrado na planilha USERS.</div>';
            return;
        }

        const primeiroUser = users[0];
        const camposEsperados = ['Numero', 'NomeCompleto', 'Email', 'RM', 'Turma', 'Perfil'];
        const camposFaltantes = camposEsperados.filter(campo => !(campo in primeiroUser));

        if (camposFaltantes.length > 0) {
            adicionarLog(`✗ Estrutura incompleta. Campos faltantes: ${camposFaltantes.join(', ')}`, 'error');
            resultado.innerHTML = `
                <div class="test-result test-error">
                    <strong>✗ Estrutura incompleta:</strong> Campos faltantes: ${camposFaltantes.join(', ')}<br>
                    <strong>Estrutura atual:</strong> ${Object.keys(primeiroUser).join(', ')}<br><br>
                    <strong>Estrutura esperada:</strong><br>
                    - Numero: Número do aluno<br>
                    - NomeCompleto: Nome completo<br>
                    - Email: E-mail institucional<br>
                    - RM: Registro do aluno<br>
                    - Turma: Turma (ex: 1A, 2B)<br>
                    - Perfil: "Aluno" ou "Professor"
                </div>
            `;
        } else {
            adicionarLog('✓ Estrutura de dados correta', 'success');
            resultado.innerHTML = `
                <div class="test-result test-success">
                    <strong>✓ Estrutura de usuários correta!</strong><br>
                    Campos: ${camposEsperados.join(', ')}<br><br>
                    <strong>Exemplo do primeiro usuário:</strong><br>
                    - Número: ${primeiroUser.Numero}<br>
                    - Nome: ${primeiroUser.NomeCompleto}<br>
                    - E-mail: ${primeiroUser.Email}<br>
                    - RM: ${primeiroUser.RM}<br>
                    - Turma: ${primeiroUser.Turma}<br>
                    - Perfil: ${primeiroUser.Perfil}
                </div>
            `;
        }
    } catch (error) {
        adicionarLog(`✗ Erro ao verificar estrutura: ${error.message}`, 'error');
        resultado.innerHTML = `
            <div class="test-result test-error">
                <strong>✗ Erro ao verificar estrutura:</strong> ${escapeHTML(error.message)}
            </div>
        `;
    }
}

async function testarFuncionalidades() {
    const resultado = document.getElementById('resultado-funcionalidades');
    resultado.innerHTML = '<div class="spinner"></div> Testando funcionalidades...';
    
    adicionarLog('Testando funcionalidades básicas...', 'info');
    
    try {
        // Testar criação de tarefa
        const tarefaTeste = {
            Turmas: ['1A'],
            Tema: 'Tarefa de Teste - Pode Excluir',
            Parte1: 'Parte 1 de teste',
            Parte2: 'Parte 2 de teste',
            Parte3: 'Parte 3 de teste',
            Parte4: 'Parte 4 de teste',
            DataAula: new Date().toISOString().split('T')[0],
            professor: 'Sistema de Teste'
        };

        const criacaoResponse = await apiPost('criarTarefa', tarefaTeste);
        adicionarLog('✓ Criação de tarefa: SUCESSO', 'success');
        
        resultado.innerHTML = `
            <div class="test-result test-success">
                <strong>✓ Funcionalidades básicas OK!</strong><br>
                - Conexão com API: ✓<br>
                - Estrutura de dados: ✓<br>
                - Criação de tarefas: ✓<br>
                - Pronto para uso<br><br>
                <strong>Tarefa de teste criada com sucesso!</strong><br>
                ID: ${criacaoResponse.id || 'N/A'}<br>
                <em>Você pode excluir esta tarefa no painel principal</em>
            </div>
        `;
    } catch (error) {
        adicionarLog(`✗ Erro nas funcionalidades: ${error.message}`, 'error');
        resultado.innerHTML = `
            <div class="test-result test-error">
                <strong>✗ Erro nas funcionalidades:</strong> ${escapeHTML(error.message)}
            </div>
        `;
    }
}

async function verificarUsuarios() {
    const resultado = document.getElementById('resultado-usuarios');
    resultado.innerHTML = '<div class="spinner"></div> Verificando usuários...';
    
    adicionarLog('Verificando lista de usuários...', 'info');
    
    try {
        const usersResponse = await apiGet('getUsers', {}, true);
        const users = usersResponse.data || usersResponse;
        
        if (users.length === 0) {
            adicionarLog('✗ Nenhum usuário encontrado', 'error');
            resultado.innerHTML = '<div class="test-result test-error">Nenhum usuário encontrado na planilha USERS.</div>';
            return;
        }
        
        const alunos = users.filter(u => u.Perfil === 'Aluno');
        const professores = users.filter(u => u.Perfil === 'Professor');
        
        adicionarLog(`✓ Total de usuários: ${users.length} (${alunos.length} alunos, ${professores.length} professores)`, 'success');
        
        let html = `
            <div class="test-result test-success">
                <strong>✓ Usuários carregados com sucesso!</strong><br>
                - Total: ${users.length} usuários<br>
                - Alunos: ${alunos.length}<br>
                - Professores: ${professores.length}<br><br>
                <strong>Primeiros 5 usuários:</strong><br>
        `;
        
        users.slice(0, 5).forEach((user, index) => {
            html += `
                ${index + 1}. ${user.NomeCompleto} (${user.Email}) - ${user.Perfil}<br>
            `;
        });
        
        if (users.length > 5) {
            html += `<br>... e mais ${users.length - 5} usuários`;
        }
        
        html += `</div>`;
        
        resultado.innerHTML = html;
        
    } catch (error) {
        adicionarLog(`✗ Erro ao verificar usuários: ${error.message}`, 'error');
        resultado.innerHTML = `
            <div class="test-result test-error">
                <strong>✗ Erro ao verificar usuários:</strong> ${escapeHTML(error.message)}
            </div>
        `;
    }
}

async function criarTarefasTeste() {
    const resultado = document.getElementById('resultado-tarefas-teste');
    resultado.innerHTML = '<div class="spinner"></div> Criando tarefas de teste...';
    
    adicionarLog('Criando tarefa de teste de Física para todas as turmas...', 'info');
    
    try {
        // Calcular data de aula para que todas as partes estejam disponíveis
        const hoje = new Date();
        const dataAula = new Date(hoje);
        dataAula.setDate(hoje.getDate() - 1); // Aula foi ontem para que a parte 1 esteja disponível
        
        // APENAS UMA TAREFA DE FÍSICA PARA TODAS AS TURMAS
        const tarefasTeste = [
            {
                Turmas: ['1A', '1B', '2A', '2B', '3A', '3B'],
                Tema: 'Tarefa de Teste - Física',
                Parte1: 'Parte 1 de Física: Introdução à Cinemática\n- Calcule a velocidade média de um carro que percorre 240 km em 3 horas.\n- Escreva a equação da posição em função do tempo para um movimento uniforme.',
                Parte2: 'Parte 2 de Física: Leis de Newton\n- Explique a Primeira Lei de Newton (Lei da Inércia).\n- Calcule a força resultante sobre um objeto de 5 kg que acelera a 2 m/s².',
                Parte3: 'Parte 3 de Física: Energia e Trabalho\n- Defina energia cinética e energia potencial gravitacional.\n- Calcule o trabalho realizado por uma força de 10 N que desloca um objeto por 5 m.',
                Parte4: 'Parte 4 de Física: Termodinâmica\n- Explique a diferença entre calor e temperatura.\n- Descreva a Primeira Lei da Termodinâmica.',
                DataAula: dataAula.toISOString().split('T')[0],
                professor: 'Sistema de Teste'
            }
        ];
        
        let tarefasCriadas = 0;
        let erros = [];
        
        for (const tarefa of tarefasTeste) {
            try {
                await apiPost('criarTarefa', tarefa);
                tarefasCriadas++;
                adicionarLog(`✓ Tarefa criada: "${tarefa.Tema}" para turmas: ${tarefa.Turmas.join(', ')}`, 'success');
            } catch (error) {
                erros.push(`Erro ao criar "${tarefa.Tema}": ${error.message}`);
                adicionarLog(`✗ Erro ao criar tarefa: ${error.message}`, 'error');
            }
            
            // Pequena pausa entre as criações
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        if (erros.length > 0) {
            resultado.innerHTML = `
                <div class="test-result test-warning">
                    <strong>Tarefas de teste criadas parcialmente!</strong><br>
                    - Tarefas criadas com sucesso: ${tarefasCriadas}<br>
                    - Erros: ${erros.length}<br><br>
                    <strong>Detalhes dos erros:</strong><br>
                    ${erros.map(erro => `• ${erro}`).join('<br>')}<br><br>
                    <em>As tarefas criadas podem ser usadas para testes pelos alunos.</em>
                </div>
            `;
        } else {
            resultado.innerHTML = `
                <div class="test-result test-success">
                    <strong>✓ Tarefas de teste criadas com sucesso!</strong><br>
                    - Total de tarefas criadas: ${tarefasCriadas}<br>
                    - Turmas contempladas: 1A, 1B, 2A, 2B, 3A, 3B<br><br>
                    <strong>Instruções para teste:</strong><br>
                    1. Faça login como aluno de qualquer turma<br>
                    2. As tarefas de teste estarão disponíveis<br>
                    3. Teste o envio de links para todas as 4 partes<br>
                    4. Verifique se as notas são calculadas corretamente<br><br>
                    <em>As tarefas podem be excluídas no painel principal quando não forem mais necessárias.</em>
                </div>
            `;
        }
        
    } catch (error) {
        adicionarLog(`✗ Erro ao criar tarefas de teste: ${error.message}`, 'error');
        resultado.innerHTML = `
            <div class="test-result test-error">
                <strong>✗ Erro ao criar tarefas de teste:</strong> ${escapeHTML(error.message)}<br><br>
                <strong>Possíveis causas:</strong><br>
                - Problema de conexão com a API<br>
                - Token de segurança incorreto<br>
                - Limite de taxa excedido<br>
                - Erro no Google Apps Script
            </div>
        `;
    }
}

/* ==================== RELATÓRIO PROFESSOR ==================== */

async function mostrarRelatorioProfessor() {
    const turmas = ["1A", "1B", "2A", "2B", "3A", "3B"];
    
    let relatorioHTML = `
        <div class="card p-6">
            <h3 class="text-2xl font-bold text-red-700 mb-4">Relatório por Turma</h3>
            <div class="turmas-container">
                <div class="turmas-buttons">
    `;
    
    turmas.forEach(turma => {
        relatorioHTML += `
            <button onclick="carregarRelatorioTurma('${turma}')" class="btn-turma-compact" id="btn-turma-${turma}">
                ${turma}
            </button>
        `;
    });
    
    relatorioHTML += `
                </div>
                <div class="export-buttons-container">
                    <button onclick="exportarParaExcel(turmaSelecionada)" class="btn-exportar" id="btn-excel">
                        Exportar Excel
                    </button>
                    <button onclick="exportarParaPDF(turmaSelecionada)" class="btn-exportar" id="btn-pdf">
                        Exportar PDF
                    </button>
                </div>
            </div>
            <div id="relatorio-turma-container" class="mt-4">
                <p class="text-gray-500 text-center py-8">Selecione uma turma para visualizar o relatório</p>
            </div>
            <div class="mt-4 text-center">
                <button onclick="mostrarPainelProfessor()" class="btn-secondary">Voltar ao Painel</button>
            </div>
        </div>
    `;
    
    contentArea.innerHTML = relatorioHTML;
    
    // Variável global para armazenar a turma selecionada
    window.turmaSelecionada = null;
}

async function carregarRelatorioTurma(turma) {
    // Atualizar botões ativos
    document.querySelectorAll('.btn-turma-compact').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById(`btn-turma-${turma}`).classList.add('active');
    
    window.turmaSelecionada = turma;
    
    frontendCache.remove(`relatorio_${turma}`);
    
    document.getElementById('relatorio-turma-container').innerHTML = `
        <div class="text-center py-8">
            <div class="spinner"></div>
            <p class="mt-4 text-gray-600">Carregando relatório da turma ${escapeHTML(turma)}...</p>
        </div>
    `;
    
    try {
        const [usersResponse, tarefasResponse] = await Promise.all([
            apiGet('getUsers', {}, true),
            apiGet('getTarefasPorTurma', { turma: turma }, true)
        ]);
        
        const alunosTurma = (usersResponse.data || usersResponse).filter(user => 
            user.Turma === turma && user.Perfil === 'Aluno'
        ).sort((a, b) => {
            const numA = parseInt(a.Numero) || 999;
            const numB = parseInt(b.Numero) || 999;
            return numA - numB;
        });
        
        const tarefasTurma = tarefasResponse.data || [];
        
        const todasEntregas = await apiGet('getEntregas', {}, true);
        const entregasTurma = (todasEntregas.data || todasEntregas).filter(entrega => 
            entrega.Turma === turma
        );
        
        let relatorioTurmaHTML = `
            <div class="relatorio-header">
                <h4 class="text-lg font-semibold text-red-700">Relatório da Turma ${escapeHTML(turma)}</h4>
            </div>
            <div class="relatorio-status" id="carregamento-status">
                <div class="spinner"></div>
                Carregando dados da turma...
            </div>
            <div class="relatorio-info">
                Total de alunos: ${alunosTurma.length} | Total de tarefas: ${tarefasTurma.length} | Total de entregas: ${entregasTurma.length} | Última atualização em ${new Date().toLocaleDateString()} às ${new Date().toLocaleTimeString()}
            </div>
        `;
        
        if (alunosTurma.length === 0) {
            relatorioTurmaHTML += `
                <div class="text-center py-8">
                    <p class="text-gray-500 mb-4">Nenhum aluno encontrado na turma ${escapeHTML(turma)}.</p>
                    <p class="text-sm text-gray-400">Verifique se a turma está correta e se os alunos estão cadastrados na planilha USERS.</p>
                </div>
            `;
        } else if (tarefasTurma.length === 0) {
            relatorioTurmaHTML += `
                <div class="text-center py-8">
                    <p class="text-gray-500 mb-4">Nenhuma tarefa encontrada para a turma ${escapeHTML(turma)}.</p>
                    <p class="text-sm text-gray-400">Crie tarefas para esta turma no painel principal.</p>
                </div>
            `;
        } else {
            relatorioTurmaHTML += `
                <div class="overflow-x-auto border rounded-lg mt-4">
                    <table class="min-w-full compact-table table-header-white" id="tabela-relatorio">
                        <thead>
                            <tr>
                                <th class="px-4 py-3 text-center font-semibold border-b numero-coluna" rowspan="2">Nº</th>
                                <th class="px-4 py-3 text-left font-semibold border-b" rowspan="2">Aluno</th>
                                <th class="px-4 py-3 text-center font-semibold border-b media-coluna" rowspan="2">Média</th>
            `;
            
            // Cabeçalho das tarefas: cada tarefa ocupa 5 colunas (Parte1, Parte2, Parte3, Parte4, Total)
            tarefasTurma.forEach(tarefa => {
                relatorioTurmaHTML += `
                    <th class="px-2 py-3 text-center font-semibold border-b header-tarefa tarefa-group" colspan="5">
                        ${escapeHTML(tarefa.Tema)}
                    </th>
                `;
            });
            
            relatorioTurmaHTML += `</tr><tr>`;
            
            // Subcabeçalho das partes para cada tarefa
            tarefasTurma.forEach(() => {
                relatorioTurmaHTML += `
                    <th class="px-1 py-2 text-center border-b subheader-tarefa parte-column">P1</th>
                    <th class="px-1 py-2 text-center border-b subheader-tarefa parte-column">P2</th>
                    <th class="px-1 py-2 text-center border-b subheader-tarefa parte-column">P3</th>
                    <th class="px-1 py-2 text-center border-b subheader-tarefa parte-column">P4</th>
                    <th class="px-1 py-2 text-center border-b subheader-tarefa media-tarefa-column">Total</th>
                `;
            });
            
            relatorioTurmaHTML += `
                            </tr>
                        </thead>
                        <tbody id="relatorio-tbody">
            `;
            
            alunosTurma.forEach((aluno, index) => {
                relatorioTurmaHTML += `
                    <tr class="aluno-loading">
                        <td class="px-4 py-3 text-center border-b numero-coluna">${aluno.Numero || (index + 1)}</td>
                        <td class="px-4 py-3 font-medium text-gray-900 border-b">${escapeHTML(aluno.NomeCompleto)}</td>
                        <td class="px-4 py-3 text-center border-b media-coluna"><div class="nota-loading"></div></td>
                `;
                
                tarefasTurma.forEach(() => {
                    // 5 colunas por tarefa (4 partes + total)
                    for (let i = 0; i < 5; i++) {
                        relatorioTurmaHTML += `<td class="px-1 py-3 text-center border-b"><div class="nota-loading"></div></td>`;
                    }
                });
                
                relatorioTurmaHTML += `</tr>`;
            });
            
            relatorioTurmaHTML += `
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        document.getElementById('relatorio-turma-container').innerHTML = relatorioTurmaHTML;
        
        if (alunosTurma.length === 0 || tarefasTurma.length === 0) {
            document.getElementById('carregamento-status').innerHTML = 'Relatório completo!';
            document.getElementById('carregamento-status').className = 'relatorio-status bg-green-50 text-green-700 border-l-green-500';
            return;
        }
        
        const carregamentoStatus = document.getElementById('carregamento-status');
        const tbody = document.getElementById('relatorio-tbody');
        
        let alunosProcessados = 0;
        
        for (let i = 0; i < alunosTurma.length; i++) {
            const aluno = alunosTurma[i];
            const linha = tbody.rows[i];
            
            if (linha) {
                let totalNotasTodasTarefas = 0;
                let countNotasTodasTarefas = 0;
                
                for (let j = 0; j < tarefasTurma.length; j++) {
                    const tarefa = tarefasTurma[j];
                    const entrega = entregasTurma.find(e => 
                        e.RM_Aluno === aluno.RM && e.ID_Tarefa === tarefa.ID
                    );
                    
                    let totalNotasTarefa = 0;
                    let countNotasTarefa = 0;
                    
                    // Para cada parte (1 a 4)
                    for (let parte = 1; parte <= 4; parte++) {
                        const notaParte = entrega ? parseFloat(entrega[`NotaParte${parte}`] || 0) : 0;
                        const colunaParte = 3 + (j * 5) + (parte - 1); // 3 colunas fixas + (5 colunas por tarefa) + offset da parte
                        
                        let classeNota = 'text-gray-600';
                        if (notaParte > 0) {
                            if (notaParte >= 2.5) {
                                classeNota = 'text-green-600 font-semibold';
                            } else {
                                classeNota = 'text-red-600';
                            }
                        }
                        
                        linha.cells[colunaParte].innerHTML = `<span class="${classeNota}">${notaParte > 0 ? notaParte.toFixed(1) : '-'}</span>`;
                        
                        if (notaParte > 0) {
                            totalNotasTarefa += notaParte;
                            countNotasTarefa++;
                            totalNotasTodasTarefas += notaParte;
                            countNotasTodasTarefas++;
                        }
                    }
                    
                    // Coluna do total da tarefa
                    const totalTarefa = countNotasTarefa > 0 ? totalNotasTarefa.toFixed(1) : '-';
                    const colunaTotalTarefa = 3 + (j * 5) + 4; // 3 colunas fixas + (5 colunas por tarefa) + offset do total (última coluna)
                    
                    let classeTotalTarefa = 'text-gray-600';
                    if (totalTarefa !== '-') {
                        const totalNum = parseFloat(totalTarefa);
                        if (totalNum >= 7.5) {
                            classeTotalTarefa = 'text-green-600 font-bold';
                        } else if (totalNum > 0) {
                            classeTotalTarefa = 'text-red-600 font-semibold';
                        }
                    }
                    
                    linha.cells[colunaTotalTarefa].innerHTML = `<span class="${classeTotalTarefa}">${totalTarefa}</span>`;
                }
                
                // Média geral do aluno (coluna 2)
                const mediaGeral = countNotasTodasTarefas > 0 ? (totalNotasTodasTarefas / countNotasTodasTarefas).toFixed(1) : '-';
                let classeMediaGeral = 'text-gray-600';
                if (mediaGeral !== '-') {
                    const mediaNum = parseFloat(mediaGeral);
                    if (mediaNum >= 7.5) {
                        classeMediaGeral = 'text-green-600 font-bold';
                    } else {
                        classeMediaGeral = 'text-red-600 font-semibold';
                    }
                }
                
                linha.cells[2].innerHTML = `<span class="${classeMediaGeral}">${mediaGeral}</span>`;
                linha.classList.remove('aluno-loading');
                
                alunosProcessados++;
                carregamentoStatus.innerHTML = `<div class="spinner"></div> Processando aluno ${alunosProcessados} de ${alunosTurma.length}...`;
                
                if (i % 3 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
            }
        }
        
        carregamentoStatus.innerHTML = 'Relatório completo!';
        carregamentoStatus.className = 'relatorio-status bg-green-50 text-green-700 border-l-green-500';
        
        const relatorioCompletoHTML = document.getElementById('relatorio-turma-container').innerHTML;
        frontendCache.set(`relatorio_${turma}`, relatorioCompletoHTML, 10 * 60 * 1000);
        
    } catch (error) {
        console.error('Erro ao carregar relatório:', error);
        document.getElementById('relatorio-turma-container').innerHTML = `
            <div class="text-center py-8">
                <p class="text-red-500">Erro ao carregar relatório: ${escapeHTML(error.message || String(error))}</p>
                <button onclick="carregarRelatorioTurma('${turma}')" class="btn-secondary mt-4">
                    Tentar Novamente
                </button>
            </div>
        `;
    }
}

function exportarParaExcel(turma) {
    if (!turma) {
        showModal('Atenção', 'Selecione uma turma primeiro.');
        return;
    }
    
    try {
        const table = document.getElementById('tabela-relatorio');
        if (!table) {
            showModal('Erro', 'Tabela não encontrada para exportação.');
            return;
        }

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.table_to_sheet(table);
        XLSX.utils.book_append_sheet(wb, ws, `Turma ${turma}`);
        XLSX.writeFile(wb, `relatorio_turma_${turma}.xlsx`);
    } catch (error) {
        showModal('Erro', `Erro ao exportar para Excel: ${error.message}`);
    }
}

function exportarParaPDF(turma) {
    if (!turma) {
        showModal('Atenção', 'Selecione uma turma primeiro.');
        return;
    }
    
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(16);
        doc.text(`Relatório da Turma ${turma}`, 14, 15);

        doc.setFontSize(10);
        doc.text(`Emitido em: ${new Date().toLocaleDateString()}`, 14, 22);

        const table = document.getElementById('tabela-relatorio');
        doc.autoTable({
            html: table,
            startY: 30,
            styles: { fontSize: 8 },
            headStyles: { fillColor: [204, 0, 0] }
        });

        doc.save(`relatorio_turma_${turma}.pdf`);
    } catch (error) {
        showModal('Erro', `Erro ao exportar para PDF: ${error.message}`);
    }
}

/* ==================== RELATÓRIO ALUNO ==================== */

async function mostrarRelatorioAluno() {
    // REMOVER CACHE E MOSTRAR LOADING IMEDIATAMENTE
    frontendCache.remove(`relatorio_aluno_${usuarioLogado.RM}`);
    
    contentArea.innerHTML = `
        <div class="card p-6">
            <h3 class="text-2xl font-bold text-red-700 mb-4">Meu Relatório</h3>
            <div class="text-center py-8">
                <div class="spinner"></div>
                <p class="mt-4 text-gray-600">Carregando relatório...</p>
            </div>
        </div>
    `;
    
    try {
        const entregasResponse = await apiGet('getEntregasAluno', { rm: usuarioLogado.RM }, true);
        const entregas = entregasResponse.data || [];
        
        let relatorioHTML = `
            <div class="card p-6">
                <h3 class="text-2xl font-bold text-red-700 mb-4">Meu Relatório</h3>
        `;
        
        if (entregas.length === 0) {
            relatorioHTML += `
                <p class="text-gray-500 text-center py-4">Nenhuma entrega registrada.</p>
            `;
        } else {
            const tarefasResponse = await apiGet('getTarefas', {}, true);
            const todasTarefas = tarefasResponse.data || [];
            
            let notaTotal = 0;
            let countEntregas = 0;
            
            relatorioHTML += `
                <div class="overflow-x-auto">
                    <table class="min-w-full compact-table">
                        <thead>
                            <tr>
                                <th>Tarefa</th>
                                <th>Links Entregues</th>
                                <th class="data-column">Data de Submissão</th>
                                <th class="data-column">Nota</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            entregas.forEach(entrega => {
                let tarefa = todasTarefas.find(t => t.ID === entrega.ID_Tarefa);
                const temaTarefa = tarefa ? tarefa.Tema : `Tarefa (ID: ${entrega.ID_Tarefa})`;
                
                const linksEntregues = [];
                if (entrega.Link1) linksEntregues.push('Parte 1');
                if (entrega.Link2) linksEntregues.push('Parte 2');
                if (entrega.Link3) linksEntregues.push('Parte 3');
                if (entrega.Link4) linksEntregues.push('Parte 4');
                
                const notaEntrega = parseFloat(entrega.Nota) || 0;
                if (notaEntrega > 0) {
                    notaTotal += notaEntrega;
                    countEntregas++;
                }
                
                relatorioHTML += `
                    <tr>
                        <td>${escapeHTML(temaTarefa)}</td>
                        <td>${linksEntregues.join(', ') || 'Nenhum'}</td>
                        <td class="data-column">${formatarData(entrega.DataSubmissao)}</td>
                        <td class="data-column font-semibold">${notaEntrega.toFixed(1)}</td>
                    </tr>
                `;
            });
            
            const media = countEntregas > 0 ? (notaTotal / countEntregas).toFixed(1) : '0.0';
            
            relatorioHTML += `
                        </tbody>
                    </table>
                    <div class="mt-4 p-3 bg-gray-50 rounded border">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold">Média Geral:</span>
                            <span class="text-lg font-bold ${parseFloat(media) >= 7.5 ? 'text-green-600' : 'text-red-600'}">${media}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        relatorioHTML += `
                <div class="mt-4 text-center">
                    <button onclick="mostrarPainelAluno()" class="btn-secondary">Voltar ao Painel</button>
                </div>
            </div>
        `;
        
        contentArea.innerHTML = relatorioHTML;
        // NÃO SALVAR NO CACHE - SEMPRE ATUALIZAR
    } catch (error) {
        showModal('Erro', `Erro ao carregar relatório: ${error.message}`);
    }
}

/* ==================== PAINEL DO PROFESSOR ==================== */

async function mostrarPainelProfessor() {
    const cacheKey = 'painel_professor';
    const cached = frontendCache.get(cacheKey);
    
    if (cached && !tarefaEditando) {
        contentArea.innerHTML = cached;
        await carregarTarefasProfessor();
        return;
    }
    
    contentArea.innerHTML = `
        <div id="painelProfessor" class="space-y-6">
            <div class="card p-6 border-t-4 border-red-600">
                <h3 class="text-2xl font-bold mb-4 text-red-700" id="titulo-formulario">${tarefaEditando ? 'Editar Tarefa' : 'Criar Nova Tarefa'}</h3>
                
                <div class="form-row">
                    <label class="block text-sm font-medium text-gray-700">Turmas:</label>
                    <div class="checkbox-group" id="turmasCheckboxes"></div>
                </div>
                
                <div class="form-row">
                    <label for="tema" class="block text-sm font-medium text-gray-700">Tema da Tarefa</label>
                    <input type="text" id="tema" placeholder="Ex: Matemática - Frações" class="mt-1" required maxlength="${MAX_TEMA_LEN}">
                </div>
                
                <div class="form-row">
                    <label for="dataAula" class="block text-sm font-medium text-gray-700">Data da Aula</label>
                    <input type="date" id="dataAula" class="mt-1" required>
                </div>
                
                <div class="mt-4 space-y-4">
                    <div>
                        <label for="parte1" class="block text-sm font-medium text-gray-700 mb-2">Parte 1 (dia da aula, 13h–22h) <span class="retencao-aviso retencao-50">50% retenção</span></label>
                        ${criarBotoesFormatacao('parte1')}
                        <textarea id="parte1" placeholder="Descreva a parte 1 da tarefa. Use Enter para criar parágrafos." rows="5" required maxlength="${MAX_PARTE_LEN}"></textarea>
                    </div>
                    <div>
                        <label for="parte2" class="block text-sm font-medium text-gray-700 mb-2">Parte 2 (7º dia, 13h–22h) <span class="retencao-aviso retencao-25">25% retenção</span></label>
                        ${criarBotoesFormatacao('parte2')}
                        <textarea id="parte2" placeholder="Descreva a parte 2 da tarefa. Use Enter para criar parágrafos." rows="5" required maxlength="${MAX_PARTE_LEN}"></textarea>
                    </div>
                    <div>
                        <label for="parte3" class="block text-sm font-medium text-gray-700 mb-2">Parte 3 (14º dia, 13h–22h) <span class="retencao-aviso retencao-15">15% retenção</span></label>
                        ${criarBotoesFormatacao('parte3')}
                        <textarea id="parte3" placeholder="Descreva a parte 3 da tarefa. Use Enter para criar parágrafos." rows="5" required maxlength="${MAX_PARTE_LEN}"></textarea>
                    </div>
                    <div>
                        <label for="parte4" class="block text-sm font-medium text-gray-700 mb-2">Parte 4 (28º dia, 13h–22h) <span class="retencao-aviso retencao-10">9.99% retenção</span></label>
                        ${criarBotoesFormatacao('parte4')}
                        <textarea id="parte4" placeholder="Descreva a parte 4 da tarefa. Use Enter para criar parágrafos." rows="5" required maxlength="${MAX_PARTE_LEN}"></textarea>
                    </div>
                </div>
                
                <div class="mt-6 flex space-x-4">
                    <button onclick="${tarefaEditando ? 'atualizarTarefa()' : 'salvarTarefa()'}" class="btn-primary flex-1" id="btnSalvarTarefa">
                        ${tarefaEditando ? 'Atualizar Tarefa' : 'Salvar Tarefa'}
                    </button>
                    <button onclick="limparFormulario()" class="btn-secondary flex-1">
                        ${tarefaEditando ? 'Cancelar Edição' : 'Limpar'}
                    </button>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="text-2xl font-bold mb-4 text-red-700">Tarefas Criadas</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full compact-table">
                        <thead>
                            <tr>
                                <th class="turma-column">Turma</th>
                                <th>Tema e Partes</th>
                                <th class="data-column">Data</th>
                                <th class="acoes-column">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaTarefasBody">
                            <tr>
                                <td colspan="4" class="text-center py-4 text-gray-500">Carregando tarefas...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    const turmas = ["1A", "1B", "2A", "2B", "3A", "3B"];
    document.getElementById('turmasCheckboxes').innerHTML = turmas.map(t => `
        <div class="checkbox-item">
            <input type="checkbox" value="${t}" class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
            <label class="text-gray-700">${t}</label>
        </div>
    `).join("");

    if (tarefaEditando) {
        preencherFormularioEdicao();
    }

    await carregarTarefasProfessor();
    
    frontendCache.set(cacheKey, contentArea.innerHTML, 2 * 60 * 1000);
}

function preencherFormularioEdicao() {
    if (!tarefaEditando) return;
    
    document.getElementById('titulo-formulario').textContent = 'Editar Tarefa';
    document.getElementById('tema').value = tarefaEditando.Tema;
    document.getElementById('dataAula').value = String(tarefaEditando.DataAula).split('T')[0];
    document.getElementById('parte1').value = tarefaEditando.Parte1 || '';
    document.getElementById('parte2').value = tarefaEditando.Parte2 || '';
    document.getElementById('parte3').value = tarefaEditando.Parte3 || '';
    document.getElementById('parte4').value = tarefaEditando.Parte4 || '';
    
    const checkboxes = document.querySelectorAll('#turmasCheckboxes input');
    checkboxes.forEach(checkbox => {
        checkbox.checked = checkbox.value === tarefaEditando.Turma;
    });
    
    window.scrollTo(0, 0);
}

async function carregarTarefasProfessor() {
    const tbody = document.getElementById('tabelaTarefasBody');
    
    tbody.innerHTML = `
        <tr>
            <td colspan="4" class="text-center py-4 text-gray-500">
                <div class="spinner"></div>
                Carregando tarefas...
            </td>
        </tr>
    `;
    
    try {
        const response = await apiGet('getTarefas', {}, true);
        tarefas = response.data || [];
        frontendCache.remove('tarefas_professor_lista');
        frontendCache.set('tarefas_professor_lista', tarefas, 2 * 60 * 1000);
        renderizarTabelaTarefas();
    } catch (error) {
        tbody.innerHTML = 
            `<tr><td colspan="4" class="text-center py-4 text-red-500">Erro ao carregar tarefas: ${escapeHTML(error.message || String(error))}</td></tr>`;
    }
}

function renderizarTabelaTarefas() {
    const tbody = document.getElementById('tabelaTarefasBody');
    
    if (!tarefas || tarefas.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">Nenhuma tarefa criada</td></tr>`;
        return;
    }

    tbody.innerHTML = tarefas.map(tarefa => {
        const parte1 = String(tarefa.Parte1 || '');
        const parte2 = String(tarefa.Parte2 || '');
        const parte3 = String(tarefa.Parte3 || '');
        const parte4 = String(tarefa.Parte4 || '');

        const formatarParaTabela = (texto) => {
            if (!texto) return '';
            const textoLimitado = texto.length > 100 ? texto.substring(0, 100) + '...' : texto;
            return formatarConteudoParaExibicao(textoLimitado);
        };

        return `
        <tr class="tarefa-item">
            <td class="turma-column">${escapeHTML(tarefa.Turma)}</td>
            <td class="px-4 py-2">
                <div class="font-semibold text-gray-800 mb-2">${escapeHTML(tarefa.Tema)}</div>
                ${parte1 ? `<div class="text-sm text-gray-600 mb-1"><span class="font-medium">Parte 1:</span> <span class="conteudo-formatado">${formatarParaTabela(parte1)}</span> <span class="retencao-aviso retencao-50">50% retenção</span></div>` : ''}
                ${parte2 ? `<div class="text-sm text-gray-600 mb-1"><span class="font-medium">Parte 2:</span> <span class="conteudo-formatado">${formatarParaTabela(parte2)}</span> <span class="retencao-aviso retencao-25">25% retenção</span></div>` : ''}
                ${parte3 ? `<div class="text-sm text-gray-600 mb-1"><span class="font-medium">Parte 3:</span> <span class="conteudo-formatado">${formatarParaTabela(parte3)}</span> <span class="retencao-aviso retencao-15">15% retenção</span></div>` : ''}
                ${parte4 ? `<div class="text-sm text-gray-600"><span class="font-medium">Parte 4:</span> <span class="conteudo-formatado">${formatarParaTabela(parte4)}</span> <span class="retencao-aviso retencao-10">9.99% retenção</span></div>` : ''}
            </td>
            <td class="data-column">${formatarData(tarefa.DataAula)}</td>
            <td class="acoes-column">
                <div class="flex justify-center space-x-2">
                    <button onclick="editarTarefa('${tarefa.ID}')" class="btn-editar">
                        Editar
                    </button>
                    <button onclick="solicitarExclusaoTarefa('${tarefa.ID}')" class="btn-excluir">
                        Excluir
                    </button>
                </div>
            </td>
        </tr>
        `;
    }).join('');
}

function solicitarExclusaoTarefa(idTarefa) {
    const tarefa = tarefas.find(t => t.ID === idTarefa);
    tarefaParaExcluir = idTarefa;
    showConfirmModal(`Tem certeza que deseja excluir a tarefa "${tarefa?.Tema}" da turma ${tarefa?.Turma}?`, () => {
        excluirTarefa(idTarefa);
    });
}

async function editarTarefa(idTarefa) {
    const tarefa = tarefas.find(t => t.ID === idTarefa);
    if (!tarefa) {
        showModal('Erro', 'Tarefa não encontrada.');
        return;
    }

    tarefaEditando = tarefa;
    frontendCache.remove('painel_professor');
    frontendCache.remove('tarefas_professor_lista');
    await mostrarPainelProfessor();
}

const salvarTarefa = debounce(async function() {
    const btnSalvar = document.getElementById('btnSalvarTarefa');
    
    try {
        if (!rateLimiter.canRun('salvarTarefa')) {
            showModal('Aguarde', 'Você acabou de salvar uma tarefa. Tente novamente em alguns segundos.');
            return;
        }

        setButtonLoading(btnSalvar, true);
        
        const turmasSelecionadas = Array.from(document.querySelectorAll('#turmasCheckboxes input:checked'))
            .map(c => c.value);
        
        if (turmasSelecionadas.length === 0) {
            showModal('Atenção', 'Selecione pelo menos uma turma.');
            return;
        }

        const tema = document.getElementById('tema').value.trim();
        const dataAula = document.getElementById('dataAula').value;

        if (!tema || !dataAula) {
            showModal('Atenção', 'Preencha o tema e a data da aula.');
            return;
        }

        if (tema.length > MAX_TEMA_LEN) {
            showModal('Atenção', `O tema deve ter no máximo ${MAX_TEMA_LEN} caracteres.`);
            return;
        }

        const parte1 = document.getElementById('parte1').value.trim();
        const parte2 = document.getElementById('parte2').value.trim();
        const parte3 = document.getElementById('parte3').value.trim();
        const parte4 = document.getElementById('parte4').value.trim();

        if (!parte1 || !parte2 || !parte3 || !parte4) {
            showModal('Atenção', 'Todas as partes da tarefa devem ser preenchidas.');
            return;
        }

        if ([parte1, parte2, parte3, parte4].some(p => p.length > MAX_PARTE_LEN)) {
            showModal('Atenção', `Cada parte deve ter no máximo ${MAX_PARTE_LEN} caracteres.`);
            return;
        }

        const dados = {
            Turmas: turmasSelecionadas,
            Tema: sanitizeForSheet(tema),
            Parte1: sanitizeForSheet(parte1),
            Parte2: sanitizeForSheet(parte2),
            Parte3: sanitizeForSheet(parte3),
            Parte4: sanitizeForSheet(parte4),
            DataAula: dataAula,
            professor: sanitizeForSheet(usuarioLogado.NomeCompleto)
        };

        await apiPost('criarTarefa', dados);
        showModal('Sucesso', 'Tarefa criada com sucesso!');
        
        frontendCache.remove('painel_professor');
        frontendCache.remove('tarefas_professor_lista');
        turmasSelecionadas.forEach(turma => {
            frontendCache.remove(`api_getTarefasPorTurma_${JSON.stringify({turma: turma})}`);
            frontendCache.remove(`relatorio_${turma}`);
        });
        
        limparFormulario();
        await carregarTarefasProfessor();
        
        document.querySelectorAll('.tarefa-item').forEach(item => {
            item.classList.add('tarefa-atualizada');
        });
        
    } catch (error) {
        showModal('Erro', `Erro ao criar tarefa: ${error.message}`);
    } finally {
        setButtonLoading(btnSalvar, false);
    }
}, 500);

const atualizarTarefa = debounce(async function() {
    const btnSalvar = document.getElementById('btnSalvarTarefa');
    
    try {
        if (!rateLimiter.canRun('atualizarTarefa')) {
            showModal('Aguarde', 'Você acabou de atualizar uma tarefa. Tente novamente em alguns segundos.');
            return;
        }

        setButtonLoading(btnSalvar, true);
        
        if (!tarefaEditando) {
            showModal('Erro', 'Nenhuma tarefa selecionada para edição.');
            return;
        }

        const tema = document.getElementById('tema').value.trim();
        const dataAula = document.getElementById('dataAula').value;
        const turmaSelecionada = Array.from(document.querySelectorAll('#turmasCheckboxes input:checked'))
            .map(c => c.value)[0];

        if (!tema || !dataAula || !turmaSelecionada) {
            showModal('Atenção', 'Preencha todos os campos obrigatórios.');
            return;
        }

        if (tema.length > MAX_TEMA_LEN) {
            showModal('Atenção', `O tema deve ter no máximo ${MAX_TEMA_LEN} caracteres.`);
            return;
        }

        const parte1 = document.getElementById('parte1').value.trim();
        const parte2 = document.getElementById('parte2').value.trim();
        const parte3 = document.getElementById('parte3').value.trim();
        const parte4 = document.getElementById('parte4').value.trim();

        if (!parte1 || !parte2 || !parte3 || !parte4) {
            showModal('Atenção', 'Todas as partes da tarefa devem ser preenchidas.');
            return;
        }

        if ([parte1, parte2, parte3, parte4].some(p => p.length > MAX_PARTE_LEN)) {
            showModal('Atenção', `Cada parte deve ter no máximo ${MAX_PARTE_LEN} caracteres.`);
            return;
        }

        const dados = {
            ID: tarefaEditando.ID,
            Tema: sanitizeForSheet(tema),
            Parte1: sanitizeForSheet(parte1),
            Parte2: sanitizeForSheet(parte2),
            Parte3: sanitizeForSheet(parte3),
            Parte4: sanitizeForSheet(parte4),
            DataAula: dataAula
        };

        await apiPost('editarTarefa', dados);
        showModal('Sucesso', 'Tarefa atualizada com sucesso!');
        
        frontendCache.remove('painel_professor');
        frontendCache.remove('tarefas_professor_lista');
        frontendCache.remove(`api_getTarefasPorTurma_${JSON.stringify({turma: turmaSelecionada})}`);
        frontendCache.remove(`relatorio_${turmaSelecionada}`);
        
        tarefaEditando = null;
        limparFormulario();
        await carregarTarefasProfessor();
        
    } catch (error) {
        showModal('Erro', `Erro ao atualizar tarefa: ${error.message}`);
    } finally {
        setButtonLoading(btnSalvar, false);
    }
}, 500);

async function excluirTarefa(idTarefa) {
    try {
        await apiPost('excluirTarefa', { ID: idTarefa });
        showModal('Sucesso', 'Tarefa excluída com sucesso.');
        
        frontendCache.remove('painel_professor');
        frontendCache.remove('tarefas_professor_lista');
        ['1A', '1B', '2A', '2B', '3A', '3B'].forEach(turma => {
            frontendCache.remove(`api_getTarefasPorTurma_${JSON.stringify({turma: turma})}`);
            frontendCache.remove(`relatorio_${turma}`);
        });
        
        await carregarTarefasProfessor();
    } catch (error) {
        showModal('Erro', `Erro ao excluir tarefa: ${error.message}`);
    }
}

function limparFormulario() {
    const temaEl = document.getElementById('tema');
    const dataEl = document.getElementById('dataAula');
    const p1 = document.getElementById('parte1');
    const p2 = document.getElementById('parte2');
    const p3 = document.getElementById('parte3');
    const p4 = document.getElementById('parte4');
    if (temaEl) temaEl.value = '';
    if (dataEl) dataEl.value = '';
    if (p1) p1.value = '';
    if (p2) p2.value = '';
    if (p3) p3.value = '';
    if (p4) p4.value = '';
    document.querySelectorAll('#turmasCheckboxes input:checked').forEach(c => c.checked = false);
    
    if (tarefaEditando) {
        tarefaEditando = null;
        document.getElementById('titulo-formulario').textContent = 'Criar Nova Tarefa';
        const btn = document.getElementById('btnSalvarTarefa');
        btn.textContent = 'Salvar Tarefa';
        btn.setAttribute('onclick', 'salvarTarefa()');
    }
}

/* ==================== PAINEL DO ALUNO ==================== */

async function mostrarPainelAluno() {
    const cacheKey = `painel_aluno_${usuarioLogado.RM}`;
    const cached = frontendCache.get(cacheKey);
    
    if (cached) {
        contentArea.innerHTML = cached;
        iniciarAtualizacaoContadoresOtimizada();
        return;
    }
    
    contentArea.innerHTML = `
        <div id="painelAluno" class="space-y-6">
            <div class="card p-6">
                <h3 class="text-2xl font-bold text-red-700 mb-4">Minhas Tarefas</h3>
                
                <div class="instrucoes-box">
                    <div class="instrucoes-title">Instruções para entrega:</div>
                    <ol class="instrucoes-list">
                        <li>Realize as atividades em folhas e as guarde com cuidado para serem entregues futuramente.</li>
                        <li>Tire uma foto, converta o arquivo em PDF, suba no seu OneDrive com o e-mail do SESI, compartilhe o link publicamente e o copie.</li>
                        <li>Cole no espaço indicado dentro do prazo estabelecido e salve para validar sua nota.</li>
                    </ol>
                </div>
                
                <div id="tarefas-aluno-container">
                    <div class="text-center text-gray-500 py-8">Carregando tarefas...</div>
                </div>
                
                <div class="fundamento-cientifico">
                    <div class="fundamento-title" onclick="toggleFundamentoCientifico()">
                        <svg class="expand-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="m6 9 6 6 6-6"/>
                        </svg>
                        Fundamentos Científicos da Aprendizagem
                    </div>
                    <div class="fundamento-content" id="conteudo-fundamento">
                        <p class="mb-4">A curva de esquecimento de Ebbinghaus e os estudos modernos de neuroaprendizagem mostram que:</p>
                        <ol class="fundamento-list">
                            <li>O cérebro consolida melhor a memória entre 6h e 9h após o aprendizado inicial.</li>
                            <li>O sono tem papel essencial — é durante o sono que ocorre a consolidação sináptica (transformar memórias de curto em longo prazo).</li>
                            <li>A atenção sustentada é máxima no período entre 8h e 11h da manhã e tem uma segunda faixa ótima entre 17h e 20h.</li>
                            <li>À noite, atividades reflexivas e criativas têm melhor rendimento, porque o córtex pré-frontal está menos sobrecarregado de estímulos novos.</li>
                            <li>Sono de 7h a 9h por noite.</li>
                            <li>Evitar telas nos 30 min antes de dormir.</li>
                            <li>Fazer revisão leve antes do sono.</li>
                        </ol>
                        
                        <div class="flex justify-center my-4">
                            <img src="https://blog-static.infra.grancursosonline.com.br/wp-content/uploads/2017/01/curva-do-esquecimento-1.png" 
                                 alt="Curva do Esquecimento de Ebbinghaus" 
                                 class="imagem-curva">
                        </div>
                        
                        <div class="referencias">
                            <div class="referencias-title">Referências:</div>
                            <ul class="referencias-list">
                                <li>EBBINGHAUS, Hermann. Memory: A Contribution to Experimental Psychology. 1913.</li>
                                <li>DUNLOSKY, John et al. Improving Students' Learning with Effective Learning Techniques. 2013.</li>
                                <li>WALKER, Matthew. Why We Sleep. 2018.</li>
                                <li>BLOOM, Benjamin S. Taxonomy of Educational Objectives. 1956.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    await carregarTarefasAluno();
    iniciarAtualizacaoContadoresOtimizada();
    
    frontendCache.set(cacheKey, contentArea.innerHTML, 2 * 60 * 1000);
}

function toggleFundamentoCientifico() {
    const conteudo = document.getElementById('conteudo-fundamento');
    const icon = document.querySelector('.expand-icon');
    
    if (conteudo.classList.contains('expandido')) {
        conteudo.classList.remove('expandido');
        icon.classList.remove('expandido');
    } else {
        conteudo.classList.add('expandido');
        icon.classList.add('expandido');
    }
}

async function carregarTarefasAluno() {
    const cacheKey = `tarefas_aluno_${usuarioLogado.RM}_dados`;
    const cached = frontendCache.get(cacheKey);
    
    if (cached) {
        renderTarefasAlunoFromCache(cached.tarefas, cached.entregas);
        return;
    }

    mostrarLoadingTarefasAluno();
    
    try {
        const response = await apiGet('getTarefasPorTurma', { turma: usuarioLogado.Turma }, true);
        const container = document.getElementById('tarefas-aluno-container');
        
        if (!response.data || response.data.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-8">Nenhuma tarefa disponível para sua turma.</div>';
            frontendCache.set(cacheKey, {tarefas: [], entregas: []}, 2 * 60 * 1000);
            return;
        }

        let entregas = [];
        try {
            const entregasResponse = await apiGet('getEntregasAluno', { rm: usuarioLogado.RM }, true);
            entregas = entregasResponse.data || [];
        } catch (error) {
            console.warn('Erro ao carregar entregas do aluno (não crítico):', error);
        }

        frontendCache.set(cacheKey, {tarefas: response.data, entregas: entregas}, 2 * 60 * 1000);
        
        renderTarefasAlunoGradualmente(response.data, entregas, container);
        
    } catch (error) {
        document.getElementById('tarefas-aluno-container').innerHTML = 
            `<div class="text-center text-red-500 py-8">Erro ao carregar tarefas: ${escapeHTML(error.message || String(error))}</div>`;
    }
}

function renderTarefasAlunoFromCache(tarefasLocal, entregas) {
    const container = document.getElementById('tarefas-aluno-container');
    container.innerHTML = '';
    
    if (!tarefasLocal || tarefasLocal.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-8">Nenhuma tarefa disponível para sua turma.</div>';
        return;
    }

    container.innerHTML = tarefasLocal.map(tarefa => {
        const contadores = calcularContadoresOtimizado(tarefa.DataAula);
        const entrega = entregas.find(e => e.ID_Tarefa === tarefa.ID);

        return renderTarefaItem(tarefa, entrega, contadores, true);
    }).join('');
}

async function renderTarefasAlunoGradualmente(tarefasLocal, entregas, container) {
    container.innerHTML = '';
    
    for (let i = 0; i < tarefasLocal.length; i++) {
        if (i % 2 === 0 && i > 0) {
            await new Promise(resolve => setTimeout(resolve, 0));
        }
        
        const tarefa = tarefasLocal[i];
        const entrega = entregas.find(e => e.ID_Tarefa === tarefa.ID);
        const contadores = calcularContadoresOtimizado(tarefa.DataAula);
        
        const tarefaHTML = renderTarefaItem(tarefa, entrega, contadores, false);
        container.innerHTML += tarefaHTML;
    }
    
    const conclusao = document.createElement('div');
    conclusao.className = 'text-green-600 text-center mt-4 p-3 bg-green-50 rounded border border-green-200';
    conclusao.innerHTML = '<strong>✓ Todas as tarefas foram carregadas!</strong>';
    container.appendChild(conclusao);
    
    setTimeout(() => {
        if (conclusao.parentNode) {
            conclusao.remove();
        }
    }, 3000);
    
    atualizarContadoresAlunoOtimizado();
}

function renderTarefaItem(tarefa, entrega, contadores, fromCache) {
    const parte1 = tarefa.Parte1 || '';
    const parte2 = tarefa.Parte2 || '';
    const parte3 = tarefa.Parte3 || '';
    const parte4 = tarefa.Parte4 || '';

    return `
    <div class="border border-gray-200 rounded-lg p-4 mb-4 ${fromCache ? '' : ''}">
        ${fromCache ? '<div class="cache-indicator">CACHE</div>' : ''}
        <div class="flex justify-between items-start">
            <div class="flex-1">
                <h4 class="font-semibold text-lg text-gray-800">${escapeHTML(tarefa.Tema)}</h4>
                <p class="text-sm text-gray-600 mt-1">Data da aula: ${formatarData(tarefa.DataAula)}</p>
                ${entrega && entrega.Nota ? `<p class="text-sm font-semibold text-green-600 mt-1">Nota: ${entrega.Nota}</p>` : ''}
                
                ${parte1 ? renderParteTarefa(tarefa.ID, 1, parte1, contadores.parte1, entrega) : ''}
                ${parte2 ? renderParteTarefa(tarefa.ID, 2, parte2, contadores.parte2, entrega) : ''}
                ${parte3 ? renderParteTarefa(tarefa.ID, 3, parte3, contadores.parte3, entrega) : ''}
                ${parte4 ? renderParteTarefa(tarefa.ID, 4, parte4, contadores.parte4, entrega) : ''}
            </div>
        </div>
    </div>
    `;
}

function renderParteTarefa(idTarefa, numeroParte, conteudo, contador, entrega) {
    const linkSalvo = entrega ? entrega[`Link${numeroParte}`] : '';
    const inputId = `link-${idTarefa}-${numeroParte}`;
    const temLinkSalvo = linkSalvo && String(linkSalvo).trim() !== '';
    
    const disponivel = contador.liberada && !contador.expirado && !temLinkSalvo;
    const expirado = contador.expirado;
    
    let retencaoAviso = '';
    if (numeroParte === 1) retencaoAviso = '<span class="retencao-aviso retencao-50">50% retenção</span>';
    else if (numeroParte === 2) retencaoAviso = '<span class="retencao-aviso retencao-25">25% retenção</span>';
    else if (numeroParte === 3) retencaoAviso = '<span class="retencao-aviso retencao-15">15% retenção</span>';
    else if (numeroParte === 4) retencaoAviso = '<span class="retencao-aviso retencao-10">9.99% retenção</span>';

    let horarioInfo = '';
    if (contador.liberada && !expirado) {
        horarioInfo = '<div class="horario-info horario-maxima">Entrega disponível hoje das 13h às 22h.</div>';
    } else if (!contador.liberada && !expirado) {
        horarioInfo = '<div class="horario-info horario-fora">Entrega disponível apenas em seu dia específico, das 13h às 22h.</div>';
    } else if (expirado) {
        horarioInfo = '<div class="horario-info horario-fora">Prazo de entrega desta parte já expirou.</div>';
    }

    if (!contador.liberada && !expirado) {
        return `
        <div class="mt-3 p-3 bg-gray-50 rounded border parte-${numeroParte}">
            <div class="flex justify-between items-center">
                <strong>Parte ${numeroParte}: ${retencaoAviso}</strong>
                <span class="contador ${contador.classe}">${contador.texto}</span>
            </div>
            <div class="conteudo-bloqueado">
                Conteúdo liberado para entrega apenas no dia específico desta parte, entre 13h e 22h.
            </div>
            ${horarioInfo}
        </div>`;
    }

    const conteudoFormatado = formatarConteudoParaExibicao(conteudo);
    
    const mostrarLinkSalvo = temLinkSalvo;
    
    return `
    <div class="mt-3 p-3 bg-gray-50 rounded border parte-${numeroParte}">
        <div class="flex justify-between items-center">
            <strong>Parte ${numeroParte}: ${retencaoAviso}</strong>
            <span class="contador ${contador.classe}">${contador.texto}</span>
        </div>
        <div class="conteudo-formatado">${conteudoFormatado}</div>
        ${horarioInfo}
        <div class="link-container">
            <input type="text" 
                   class="link-input ${mostrarLinkSalvo ? 'link-salvo' : ''}" 
                   placeholder="${!contador.liberada ? 'Aguardando liberação...' : (expirado ? 'Prazo expirado' : 'Cole o link da atividade aqui')}" 
                   id="${inputId}"
                   value="${linkSalvo || ''}"
                   ${mostrarLinkSalvo || !disponivel ? 'disabled' : ''}>
            ${!mostrarLinkSalvo ? `
                <button class="btn-primary btn-link btn-salvar" 
                        onclick="salvarLink('${idTarefa}', ${numeroParte})"
                        ${!disponivel ? 'disabled' : ''}>
                    Salvar
                </button>
            ` : ''}
            <button class="btn-secondary btn-link btn-excluir" 
                    onclick="excluirLink('${idTarefa}', ${numeroParte})"
                    ${!mostrarLinkSalvo ? 'disabled' : ''}>
                Excluir
            </button>
        </div>
        ${mostrarLinkSalvo ? '<p class="text-green-600 text-sm mt-1">✓ Link salvo com sucesso</p>' : ''}
    </div>`;
}

const salvarLink = debounce(async function(idTarefa, parte) {
    if (!rateLimiter.canRun('salvarLink')) {
        showModal('Aguarde', 'Você acabou de salvar um link. Tente novamente em alguns segundos.');
        return;
    }

    const input = document.getElementById(`link-${idTarefa}-${parte}`);
    const link = input ? input.value.trim() : '';

    if (!link) {
        showModal('Atenção', 'Por favor, cole um link válido.');
        return;
    }

    try {
        // CORREÇÃO: ENVIAR A TURMA CORRETA DO ALUNO, NÃO A NOTA
        await apiPost('entregarTarefa', {
            ID_Tarefa: idTarefa,
            RM_Aluno: usuarioLogado.RM,
            NomeAluno: sanitizeForSheet(usuarioLogado.NomeCompleto),
            Turma: usuarioLogado.Turma, // CORREÇÃO: ENVIAR A TURMA DO ALUNO
            Parte: parte,
            [`Link${parte}`]: sanitizeForSheet(link)
        });
        
        showModal('Sucesso', `Link da parte ${parte} salvo com sucesso!`);
        
        frontendCache.remove(`painel_aluno_${usuarioLogado.RM}`);
        frontendCache.remove(`tarefas_aluno_${usuarioLogado.RM}_dados`);
        frontendCache.remove(`relatorio_aluno_${usuarioLogado.RM}`);
        frontendCache.remove(`api_getEntregasAluno_${JSON.stringify({rm: usuarioLogado.RM})}`);
        frontendCache.remove(`relatorio_${usuarioLogado.Turma}`);
        
        await carregarTarefasAluno();
    } catch (error) {
        const msg = error.message || String(error);
        if (msg.includes('Fora do período de entrega')) {
            showModal(
                'Fora do horário de entrega',
                'Essa parte só pode ser entregue no dia específico dela, entre 13h e 22h. Verifique o cronograma na descrição da tarefa.'
            );
        } else {
            showModal('Erro', `Erro ao salvar link: ${msg}`);
        }
    }
}, 500);

const excluirLink = debounce(async function(idTarefa, parte) {
    if (!rateLimiter.canRun('excluirLink')) {
        showModal('Aguarde', 'Você acabou de atualizar um link. Tente novamente em alguns segundos.');
        return;
    }

    try {
        // CORREÇÃO: EXCLUIR O LINK E ZERAR A NOTA
        await apiPost('excluirEntrega', {
            ID_Tarefa: idTarefa,
            RM_Aluno: usuarioLogado.RM,
            Parte: parte
        });
        
        showModal('Sucesso', `Link da parte ${parte} excluído com sucesso! A nota desta parte foi zerada.`);
        
        frontendCache.remove(`painel_aluno_${usuarioLogado.RM}`);
        frontendCache.remove(`tarefas_aluno_${usuarioLogado.RM}_dados`);
        frontendCache.remove(`relatorio_aluno_${usuarioLogado.RM}`);
        frontendCache.remove(`api_getEntregasAluno_${JSON.stringify({rm: usuarioLogado.RM})}`);
        frontendCache.remove(`relatorio_${usuarioLogado.Turma}`);
        
        await carregarTarefasAluno();
    } catch (error) {
        showModal('Erro', `Erro ao excluir link: ${error.message}`);
    }
}, 500);

/* ==================== EXPOR FUNÇÕES GLOBAIS ==================== */

window.login = login;
window.logout = logout;
window.mostrarPainelProfessor = mostrarPainelProfessor;
window.mostrarPainelAluno = mostrarPainelAluno;
window.mostrarRelatorioProfessor = mostrarRelatorioProfessor;
window.mostrarRelatorioAluno = mostrarRelatorioAluno;
window.carregarRelatorioTurma = carregarRelatorioTurma;
window.salvarTarefa = salvarTarefa;
window.atualizarTarefa = atualizarTarefa;
window.excluirTarefa = excluirTarefa;
window.solicitarExclusaoTarefa = solicitarExclusaoTarefa;
window.editarTarefa = editarTarefa;
window.limparFormulario = limparFormulario;
window.closeModal = closeModal;
window.salvarLink = salvarLink;
window.excluirLink = excluirLink;
window.toggleFundamentoCientifico = toggleFundamentoCientifico;
window.adicionarFormatacao = adicionarFormatacao;
window.exportarParaExcel = exportarParaExcel;
window.exportarParaPDF = exportarParaPDF;
window.toggleRmVisibility = toggleRmVisibility;
window.mostrarPainelDiagnostico = mostrarPainelDiagnostico;
window.testarConexaoCompleta = testarConexaoCompleta;
window.verificarEstruturaDados = verificarEstruturaDados;
window.testarFuncionalidades = testarFuncionalidades;
window.verificarUsuarios = verificarUsuarios;
window.criarTarefasTeste = criarTarefasTeste;
window.adicionarLog = adicionarLog;

init();
</script>
</body>
</html>
