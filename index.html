<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Tarefas Escolar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide-static@latest/dist/lucide.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.2); }
        .btn-primary { background-color: #CC0000; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; transition: background-color 0.2s; cursor: pointer; font-size: 14px; }
        .btn-primary:hover { background-color: #A00000; }
        .btn-secondary { background-color: #d1d5db; color: #1e1e1e; padding: 8px 16px; border-radius: 8px; font-weight: 600; transition: background-color 0.2s; cursor: pointer; }
        .btn-secondary:hover { background-color: #9ca3af; }
        .btn-small { padding: 6px 12px; font-size: 0.875rem; }
        input, textarea, select {
            border: 1px solid #d1d5db; padding: 12px; border-radius: 8px; width: 100%; box-sizing: border-box;
            transition: border-color 0.2s; margin-top: 4px; margin-bottom: 8px;
        }
        input:focus, textarea:focus, select:focus { border-color: #CC0000; outline: none; }
        [data-lucide] { width: 20px; height: 20px; display: inline-block; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #CC0000; color: white; }
        tbody tr:nth-child(even) { background-color: #f9f9f9; }
        .hidden { display: none; }
        
        .checkbox-group {
            display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; padding: 10px;
            background-color: #f9f9f9; border-radius: 8px;
        }
        .checkbox-group label { font-weight: normal; display: flex; align-items: center; }
        .checkbox-group input { width: auto; margin: 0 5px 0 0; }
        
        .form-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .form-row label {
            margin-bottom: 0;
            min-width: 120px;
        }
        .form-row input, .form-row textarea {
            flex: 1;
            margin-top: 0;
        }
        
        .compact-table th, .compact-table td {
            padding: 12px 8px;
        }
        .turma-column {
            width: 80px;
            text-align: center;
        }
        .data-column {
            width: 120px;
            text-align: center;
        }
        .acoes-column {
            width: 200px;
            text-align: center;
        }
        
        .contador {
            display: inline-block;
            padding: 4px 8px;
            background-color: #f3f4f6;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 8px;
            min-width: 80px;
            text-align: center;
        }
        .contador.disponivel {
            background-color: #d1fae5;
            color: #065f46;
        }
        .contador.urgente {
            background-color: #fef3c7;
            color: #92400e;
        }
        .contador.expirado {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .contador.aguardando {
            background-color: #e5e7eb;
            color: #374151;
        }
        
        .link-container {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            align-items: center;
        }
        .link-input {
            flex: 1;
            padding: 8px;
            font-size: 0.875rem;
        }
        .btn-link {
            padding: 8px 12px;
            font-size: 0.8rem;
        }

        .btn-link:disabled {
            background-color: #9ca3af !important;
            color: #6b7280 !important;
            cursor: not-allowed !important;
            opacity: 0.6;
        }

        .btn-link:disabled:hover {
            background-color: #9ca3af !important;
            transform: none !important;
        }

        .link-salvo {
            background-color: #f3f4f6 !important;
            color: #6b7280 !important;
            cursor: not-allowed !important;
            border: 1px solid #d1d5db;
        }

        #login-form input {
            height: 50px;
            width: 100%;
            padding: 12px 16px;
            font-size: 16px;
        }

        #login-form button {
            padding: 10px 30px;
            font-size: 16px;
            width: auto;
            margin: 10px auto 0 auto;
            display: block;
            height: auto;
        }

        #login {
            max-width: 500px;
            margin: 0 auto;
            padding: 2rem;
        }

        .acoes-column button {
            margin: 0 4px;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .btn-editar {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-editar:hover {
            background-color: #2563eb;
        }

        .btn-excluir {
            background-color: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-excluir:hover {
            background-color: #dc2626;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item label {
            margin-bottom: 0;
            min-width: auto;
        }

        .user-info-container {
            text-align: center;
            margin: 10px 0;
            padding: 0 20px;
            line-height: 1.5;
        }

        .user-info-text {
            font-size: 14px;
            color: #4b5563;
        }

        .user-info-name {
            font-weight: 600;
            color: #CC0000;
        }

        .header-content {
            position: relative;
            padding-bottom: 15px;
        }

        .btn-relatorio {
            background-color: #10b981;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
            margin-left: 10px;
        }

        .btn-relatorio:hover {
            background-color: #059669;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .btn-turma {
            background-color: #CC0000;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
            margin: 5px;
        }

        .btn-turma:hover {
            background-color: #A00000;
        }

        .table-header-white th {
            color: white !important;
            background-color: #CC0000 !important;
        }

        /* NOVOS ESTILOS PARA LOADING */
        .spinner {
            border: 2px solid #f3f3f3;
            border-radius: 50%;
            border-top: 2px solid #CC0000;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #6b7280;
        }

        .tarefa-loading {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            background: linear-gradient(90deg, #f9fafb 25%, #f3f4f6 50%, #f9fafb 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .btn-loading {
            position: relative;
            color: transparent;
        }

        .btn-loading::after {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 sm:p-8">

<div id="app-container" class="w-full max-w-6xl bg-white shadow-xl rounded-2xl p-6 sm:p-8 transition-all duration-300">
    <header class="mb-8 border-b pb-4">
        <div class="header-content">
            <h1 class="text-3xl font-extrabold text-red-700 text-center">Gestão de Tarefas Escolar</h1>
            <div id="user-info" class="user-info-container"></div>
            <div class="absolute top-0 right-0 flex space-x-2">
                <button id="relatorioBtn" class="btn-relatorio hidden">Relatório</button>
                <button onclick="logout()" id="logoutBtn" class="btn-secondary hidden">Sair</button>
            </div>
        </div>
    </header>

    <div id="content-area"></div>

    <footer class="mt-8 pt-4 border-t text-xs text-gray-500 text-center">
        Desenvolvido por Geovane Modena | Versão 6.1
    </footer>
</div>

<!-- Modal para mensagens -->
<div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full shadow-2xl">
        <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-600"></h3>
        <p id="modal-message" class="text-gray-700 mb-4 whitespace-pre-wrap"></p>
        <button onclick="closeModal()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition">OK</button>
    </div>
</div>

<!-- Modal de confirmação para exclusão -->
<div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full shadow-2xl">
        <h3 class="text-xl font-bold mb-3 text-red-600">Confirmar Exclusão</h3>
        <p id="confirm-message" class="text-gray-700 mb-4">Tem certeza que deseja excluir esta tarefa?</p>
        <div class="flex space-x-4">
            <button id="confirm-cancel" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded transition">Cancelar</button>
            <button id="confirm-delete" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition">Excluir</button>
        </div>
    </div>
</div>

<script>
// --- CONFIGURAÇÃO ---
const API_URL = "https://script.google.com/macros/s/AKfycbzKymbA3QgIdhBw7AfUJQveK3l3gbzT-2eccOJpF1K4E-HrEc51pefiJFWCEnDWZm4V/exec";
const SECURITY_TOKEN = 'SESI_EDUCATION_2024';

// --- ESTADO DA APLICAÇÃO ---
let usuarios = [];
let usuarioLogado = null;
let tarefas = [];
let jsonpCallbackId = 0;
let tarefaParaExcluir = null;
let contadoresAtivos = [];
let tarefaEditando = null;

// --- ELEMENTOS DOM ---
const contentArea = document.getElementById('content-area');
const userInfoDisplay = document.getElementById('user-info');
const logoutBtn = document.getElementById('logoutBtn');
const relatorioBtn = document.getElementById('relatorioBtn');
const modalOverlay = document.getElementById('modal-overlay');
const modalTitle = document.getElementById('modal-title');
const modalMessage = document.getElementById('modal-message');
const confirmModal = document.getElementById('confirm-modal');
const confirmMessage = document.getElementById('confirm-message');
const confirmCancel = document.getElementById('confirm-cancel');
const confirmDelete = document.getElementById('confirm-delete');

// --- FUNÇÕES UTILITÁRIAS ---
const showModal = (title, message) => {
    modalTitle.textContent = title;
    modalMessage.textContent = message;
    modalOverlay.classList.remove('hidden');
    modalOverlay.classList.add('flex');
};

const closeModal = () => modalOverlay.classList.add('hidden');

const showConfirmModal = (message, onConfirm) => {
    confirmMessage.textContent = message;
    confirmModal.classList.remove('hidden');
    confirmModal.classList.add('flex');
    
    confirmCancel.onclick = () => {
        confirmModal.classList.add('hidden');
        tarefaParaExcluir = null;
    };
    
    confirmDelete.onclick = () => {
        confirmModal.classList.add('hidden');
        if (onConfirm) onConfirm();
        tarefaParaExcluir = null;
    };
};

const renderIcons = () => window.lucide && window.lucide.createIcons();

const formatarData = (dataISO) => {
    if (!dataISO) return 'N/A';
    
    let data = new Date(dataISO);
    if (isNaN(data.getTime())) {
        const partes = dataISO.split('-');
        if (partes.length === 3) {
            data = new Date(partes[0], partes[1] - 1, partes[2]);
        }
    }
    
    return data.toLocaleDateString('pt-BR');
};

// --- FUNÇÕES DE LOADING ---
function setButtonLoading(button, isLoading) {
    if (isLoading) {
        button.disabled = true;
        button.classList.add('btn-loading');
    } else {
        button.disabled = false;
        button.classList.remove('btn-loading');
    }
}

function mostrarLoadingTarefasAluno() {
    const container = document.getElementById('tarefas-aluno-container');
    if (!container) return;
    
    container.innerHTML = `
        <div class="space-y-4">
            <div class="tarefa-loading" style="height: 120px;"></div>
            <div class="tarefa-loading" style="height: 120px;"></div>
            <div class="tarefa-loading" style="height: 120px;"></div>
            <div class="loading-text">
                <div class="spinner"></div>
                Carregando tarefas...
            </div>
        </div>
    `;
}

function mostrarLoadingRelatorio() {
    const container = document.getElementById('relatorio-turma-container');
    if (!container) return;
    
    container.innerHTML = `
        <div class="loading-text py-8">
            <div class="spinner"></div>
            Carregando relatório...
        </div>
    `;
}

function mostrarConclusaoRelatorio() {
    const container = document.getElementById('relatorio-turma-container');
    if (!container) return;
    
    const mensagem = document.createElement('div');
    mensagem.className = 'text-green-600 text-center mt-4 p-3 bg-green-50 rounded border border-green-200';
    mensagem.innerHTML = '<strong>✓ Relatório carregado com sucesso!</strong>';
    
    container.appendChild(mensagem);
    
    setTimeout(() => {
        if (mensagem.parentNode) {
            mensagem.remove();
        }
    }, 3000);
}

// --- FUNÇÕES DE TEMPO ---
function calcularContadores(dataAula) {
    const agora = new Date();
    const dataAulaObj = new Date(dataAula);
    
    const parte1Liberacao = new Date(dataAulaObj);
    parte1Liberacao.setHours(0, 0, 0, 0);
    
    const parte2Liberacao = new Date(dataAulaObj);
    parte2Liberacao.setDate(parte2Liberacao.getDate() + 3);
    
    const parte3Liberacao = new Date(dataAulaObj);
    parte3Liberacao.setDate(parte3Liberacao.getDate() + 7);
    
    const parte4Liberacao = new Date(dataAulaObj);
    parte4Liberacao.setDate(parte4Liberacao.getDate() + 14);
    
    const parte1Limite = new Date(dataAulaObj);
    parte1Limite.setHours(18, 0, 0, 0);
    
    const parte2Limite = new Date(dataAulaObj);
    parte2Limite.setDate(parte2Limite.getDate() + 7);
    
    const parte3Limite = new Date(dataAulaObj);
    parte3Limite.setDate(parte3Limite.getDate() + 14);
    
    const parte4Limite = new Date(dataAulaObj);
    parte4Limite.setDate(parte4Limite.getDate() + 28);
    
    const calcularTempoRestante = (liberacao, limite) => {
        const diffLiberacao = liberacao - agora;
        const diffLimite = limite - agora;
        
        if (diffLiberacao > 0) {
            const dias = Math.floor(diffLiberacao / (1000 * 60 * 60 * 24));
            const horas = Math.floor((diffLiberacao % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutos = Math.floor((diffLiberacao % (1000 * 60 * 60)) / (1000 * 60));
            const segundos = Math.floor((diffLiberacao % (1000 * 60)) / 1000);
            
            let texto = '';
            if (dias > 0) {
                texto = `Libera em ${dias}d ${horas}h`;
            } else if (horas > 0) {
                texto = `Libera em ${horas}h ${minutos}m`;
            } else {
                texto = `Libera em ${minutos}m ${segundos}s`;
            }
            
            return { 
                texto, 
                classe: 'aguardando', 
                liberada: false,
                expirado: false
            };
        }
        
        if (diffLimite <= 0) {
            return { 
                texto: 'Expirado', 
                classe: 'expirado', 
                liberada: true,
                expirado: true
            };
        }
        
        const dias = Math.floor(diffLimite / (1000 * 60 * 60 * 24));
        const horas = Math.floor((diffLimite % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutos = Math.floor((diffLimite % (1000 * 60 * 60)) / (1000 * 60));
        const segundos = Math.floor((diffLimite % (1000 * 60)) / 1000);
        
        let texto = '';
        if (dias > 0) {
            texto = `${dias}d ${horas}h ${minutos}m`;
        } else if (horas > 0) {
            texto = `${horas}h ${minutos}m ${segundos}s`;
        } else {
            texto = `${minutos}m ${segundos}s`;
        }
        
        const classe = dias === 0 ? 'urgente' : 'disponivel';
        
        return { 
            texto, 
            classe, 
            liberada: true,
            expirado: false
        };
    };
    
    return {
        parte1: calcularTempoRestante(parte1Liberacao, parte1Limite),
        parte2: calcularTempoRestante(parte2Liberacao, parte2Limite),
        parte3: calcularTempoRestante(parte3Liberacao, parte3Limite),
        parte4: calcularTempoRestante(parte4Liberacao, parte4Limite)
    };
}

function iniciarAtualizacaoContadores() {
    contadoresAtivos.forEach(interval => clearInterval(interval));
    contadoresAtivos = [];
    
    const interval = setInterval(() => {
        if (usuarioLogado && usuarioLogado.Perfil === 'Aluno') {
            atualizarContadoresAluno();
        }
    }, 1000);
    
    contadoresAtivos.push(interval);
}

function atualizarContadoresAluno() {
    const containers = document.querySelectorAll('#tarefas-aluno-container > div');
    containers.forEach(container => {
        const tema = container.querySelector('h4')?.textContent;
        if (!tema) return;
        
        const tarefa = tarefas.find(t => t.Tema === tema);
        if (tarefa) {
            const contadores = calcularContadores(tarefa.DataAula);
            
            [1, 2, 3, 4].forEach(parte => {
                const contadorElement = container.querySelector(`.parte-${parte} .contador`);
                if (contadorElement) {
                    const contador = contadores[`parte${parte}`];
                    contadorElement.textContent = contador.texto;
                    contadorElement.className = `contador ${contador.classe}`;
                }
            });
        }
    });
}

// --- API REQUEST COM JSONP ---
function apiRequestJSONP(url, callback) {
    const callbackName = 'jsonp_callback_' + jsonpCallbackId++;
    
    window[callbackName] = function(data) {
        delete window[callbackName];
        document.body.removeChild(script);
        callback(null, data);
    };
    
    const script = document.createElement('script');
    script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;
    script.onerror = function() {
        delete window[callbackName];
        document.body.removeChild(script);
        callback(new Error('Falha ao carregar o script'));
    };
    
    document.body.appendChild(script);
}

async function apiGet(func, params = {}) {
    return new Promise((resolve, reject) => {
        let url = `${API_URL}?token=${SECURITY_TOKEN}`;
        
        if (func) {
            url += `&func=${func}`;
        }
        
        for (const key in params) {
            if (params[key] !== undefined && params[key] !== null) {
                url += `&${key}=${encodeURIComponent(params[key])}`;
            }
        }
        
        apiRequestJSONP(url, (error, data) => {
            if (error) {
                reject(error);
            } else if (data && data.success === false) {
                reject(new Error(data.error));
            } else {
                resolve(data);
            }
        });
    });
}

async function apiPost(action, dados) {
    return new Promise((resolve, reject) => {
        let url = `${API_URL}?token=${SECURITY_TOKEN}&action=${action}`;
        
        for (const key in dados) {
            if (dados[key] !== undefined && dados[key] !== null) {
                if (Array.isArray(dados[key])) {
                    url += `&${key}=${encodeURIComponent(JSON.stringify(dados[key]))}`;
                } else {
                    url += `&${key}=${encodeURIComponent(dados[key])}`;
                }
            }
        }
        
        apiRequestJSONP(url, (error, data) => {
            if (error) {
                reject(error);
            } else if (data && data.success === false) {
                reject(new Error(data.error));
            } else {
                resolve(data);
            }
        });
    });
}

// --- INICIALIZAÇÃO ---
async function init() {
    try {
        const response = await apiGet('getUsers');
        usuarios = response.data || [];
    } catch (error) {
        usuarios = [
            { 
                NomeCompleto: "Geovane Módena", 
                Email: "geovane.modena@portalsesisp.org.br", 
                RA: "9999", 
                Turma: "", 
                Perfil: "Professor" 
            }
        ];
    }
    
    renderLogin();
}

// --- FUNÇÕES DE AUTENTICAÇÃO ---
const renderLogin = () => {
    contentArea.innerHTML = `
        <div id="login" class="max-w-md mx-auto p-6">
            <h2 class="text-2xl font-bold text-center text-red-700 mb-6">Login</h2>
            <div id="loginErro" class="text-red-500 mb-4 hidden text-center font-semibold">Usuário ou RA incorretos!</div>

            <form id="login-form" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">E-mail</label>
                    <input type="email" id="email" name="email" required placeholder="seu.email@escola.com" class="w-full">
                </div>
                <div>
                    <label for="ra" class="block text-sm font-medium text-gray-700 mb-2">RA</label>
                    <input type="text" id="ra" name="ra" required placeholder="Apenas números" class="w-full">
                </div>
                <button type="submit" class="btn-primary" id="login-button">
                    <span id="login-text">Entrar</span>
                </button>
            </form>
        </div>
    `;

    document.getElementById('login-form').addEventListener('submit', login);
};

async function login(event) {
    event.preventDefault(); 
    const email = document.getElementById('email').value.trim();
    const ra = document.getElementById('ra').value.trim();
    
    const loginErro = document.getElementById('loginErro'); 
    const loginButton = document.getElementById('login-button');
    const loginText = document.getElementById('login-text');
    
    setButtonLoading(loginButton, true);
    loginText.textContent = "Entrando...";
    
    const user = usuarios.find(u => {
        const userEmail = u.Email.toLowerCase().trim();
        const userRA = String(u.RA).trim();
        const inputEmail = email.toLowerCase().trim();
        const inputRA = ra.trim();
        
        return userEmail === inputEmail && userRA === inputRA;
    });
    
    if (!user) {
        loginErro.style.display = 'block';
        setButtonLoading(loginButton, false);
        loginText.textContent = "Entrar";
        return;
    }
    
    usuarioLogado = user;
    loginErro.style.display = 'none';
    
    contentArea.innerHTML = `<div class="text-center text-gray-500 py-8">Carregando painel...</div>`;
    logoutBtn.classList.remove('hidden');
    relatorioBtn.classList.remove('hidden');
    
    if (user.Perfil === "Professor") {
        userInfoDisplay.innerHTML = `
            <div class="user-info-text">
                Logado como: <span class="user-info-name">${user.NomeCompleto} (${user.Perfil})</span> | Professor
            </div>
        `;
        relatorioBtn.onclick = mostrarRelatorioProfessor;
    } else {
        userInfoDisplay.innerHTML = `
            <div class="user-info-text">
                Logado como: <span class="user-info-name">${user.NomeCompleto} (${user.Perfil})</span> | Turma: ${user.Turma || 'N/A'}
            </div>
        `;
        relatorioBtn.onclick = mostrarRelatorioAluno;
    }

    try {
        const response = await apiGet('getTarefas');
        tarefas = response.data || [];
    } catch (error) {
        tarefas = [];
    }

    if (user.Perfil === "Professor") {
        await mostrarPainelProfessor();
    } else {
        await mostrarPainelAluno(); 
    }
}

function logout() {
    usuarioLogado = null;
    tarefaEditando = null;
    logoutBtn.classList.add('hidden');
    relatorioBtn.classList.add('hidden');
    userInfoDisplay.innerHTML = '';
    contadoresAtivos.forEach(interval => clearInterval(interval));
    contadoresAtivos = [];
    renderLogin(); 
}

// --- FUNÇÕES DE RELATÓRIO ---
async function mostrarRelatorioProfessor() {
    const turmas = ["1A", "1B", "2A", "2B", "3A", "3B"];
    
    let relatorioHTML = `
        <div class="card p-6">
            <h3 class="text-2xl font-bold text-red-700 mb-4">Relatório por Turma</h3>
            <div class="mb-4">
                <p class="block text-sm font-medium text-gray-700 mb-2">Selecione a Turma:</p>
                <div class="flex flex-wrap gap-2 mb-6" id="botoes-turma">
    `;
    
    turmas.forEach(turma => {
        relatorioHTML += `
            <button onclick="carregarRelatorioTurma('${turma}')" class="btn-turma">
                Turma ${turma}
            </button>
        `;
    });
    
    relatorioHTML += `
                </div>
            </div>
            <div id="relatorio-turma-container" class="mt-4">
                <p class="text-gray-500 text-center py-8">Selecione uma turma para visualizar o relatório</p>
            </div>
            <div class="mt-4 text-center">
                <button onclick="mostrarPainelProfessor()" class="btn-secondary">Voltar ao Painel</button>
            </div>
        </div>
    `;
    
    contentArea.innerHTML = relatorioHTML;
}

async function carregarRelatorioTurma(turmaSelecionada) {
    mostrarLoadingRelatorio();
    
    try {
        const usersResponse = await apiGet('getUsers');
        const alunosTurma = usersResponse.data.filter(user => user.Turma === turmaSelecionada && user.Perfil === 'Aluno');
        
        const tarefasResponse = await apiGet('getTarefasPorTurma', { turma: turmaSelecionada });
        const tarefasTurma = tarefasResponse.data || [];
        
        if (alunosTurma.length === 0) {
            document.getElementById('relatorio-turma-container').innerHTML = 
                `<p class="text-gray-500 text-center py-8">Nenhum aluno encontrado na turma ${turmaSelecionada}.</p>`;
            return;
        }
        
        if (tarefasTurma.length === 0) {
            document.getElementById('relatorio-turma-container').innerHTML = 
                `<p class="text-gray-500 text-center py-8">Nenhuma tarefa encontrada para a turma ${turmaSelecionada}.</p>`;
            return;
        }
        
        let relatorioTurmaHTML = `
            <h4 class="text-lg font-semibold mb-3 text-red-700">Relatório da Turma ${turmaSelecionada}</h4>
            <div class="overflow-x-auto border rounded-lg">
                <table class="min-w-full compact-table table-header-white">
                    <thead>
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold border-b">Aluno</th>
        `;
        
        tarefasTurma.forEach(tarefa => {
            relatorioTurmaHTML += `<th class="px-4 py-3 text-center font-semibold border-b">${tarefa.Tema}</th>`;
        });
        
        relatorioTurmaHTML += `
                            <th class="px-4 py-3 text-center font-semibold border-b">Média</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        for (const aluno of alunosTurma) {
            const entregasResponse = await apiGet('getEntregasAluno', { ra: aluno.RA });
            const entregasAluno = entregasResponse.data || [];
            
            let totalNotas = 0;
            let countNotas = 0;
            
            relatorioTurmaHTML += `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 font-medium text-gray-900 border-b">${aluno.NomeCompleto}</td>
            `;
            
            for (const tarefa of tarefasTurma) {
                const entrega = entregasAluno.find(e => e.ID_Tarefa === tarefa.ID);
                const nota = entrega && entrega.Nota ? parseFloat(entrega.Nota).toFixed(1) : '-';
                
                if (entrega && entrega.Nota) {
                    totalNotas += parseFloat(entrega.Nota);
                    countNotas++;
                }
                
                let classeNota = 'text-gray-600';
                if (entrega && entrega.Nota) {
                    const notaNum = parseFloat(entrega.Nota);
                    if (notaNum >= 7.5) {
                        classeNota = 'text-green-600 font-semibold';
                    } else {
                        classeNota = 'text-red-600';
                    }
                }
                
                relatorioTurmaHTML += `<td class="px-4 py-3 text-center border-b ${classeNota}">${nota}</td>`;
            }
            
            const media = countNotas > 0 ? (totalNotas / countNotas).toFixed(1) : '-';
            let classeMedia = 'text-gray-600';
            if (media !== '-') {
                const mediaNum = parseFloat(media);
                if (mediaNum >= 7.5) {
                    classeMedia = 'text-green-600 font-bold';
                } else {
                    classeMedia = 'text-red-600 font-semibold';
                }
            }
            
            relatorioTurmaHTML += `<td class="px-4 py-3 text-center border-b ${classeMedia}">${media}</td>`;
            relatorioTurmaHTML += `</tr>`;
        }
        
        relatorioTurmaHTML += `
                    </tbody>
                </table>
            </div>
            <div class="mt-4 text-sm text-gray-600">
                <p>Total de alunos: ${alunosTurma.length} | Total de tarefas: ${tarefasTurma.length}</p>
            </div>
        `;
        
        document.getElementById('relatorio-turma-container').innerHTML = relatorioTurmaHTML;
        mostrarConclusaoRelatorio();
        
    } catch (error) {
        document.getElementById('relatorio-turma-container').innerHTML = 
            `<p class="text-red-500 text-center py-4">Erro ao carregar relatório: ${error.message}</p>`;
    }
}

async function mostrarRelatorioAluno() {
    try {
        const entregasResponse = await apiGet('getEntregasAluno', { ra: usuarioLogado.RA });
        const entregas = entregasResponse.data || [];
        
        let relatorioHTML = `
            <div class="card p-6">
                <h3 class="text-2xl font-bold text-red-700 mb-4">Meu Relatório</h3>
        `;
        
        if (entregas.length === 0) {
            relatorioHTML += `
                <p class="text-gray-500 text-center py-4">Nenhuma entrega registrada.</p>
            `;
        } else {
            const tarefasResponse = await apiGet('getTarefas');
            const todasTarefas = tarefasResponse.data || [];
            
            let notaTotal = 0;
            let countEntregas = 0;
            
            relatorioHTML += `
                <div class="overflow-x-auto">
                    <table class="min-w-full compact-table">
                        <thead>
                            <tr>
                                <th>Tarefa</th>
                                <th>Links Entregues</th>
                                <th class="data-column">Data de Submissão</th>
                                <th class="data-column">Nota</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            entregas.forEach(entrega => {
                let tarefa = todasTarefas.find(t => t.ID === entrega.ID_Tarefa);
                const temaTarefa = tarefa ? tarefa.Tema : `Tarefa (ID: ${entrega.ID_Tarefa})`;
                
                const linksEntregues = [];
                if (entrega.Link1) linksEntregues.push('Parte 1');
                if (entrega.Link2) linksEntregues.push('Parte 2');
                if (entrega.Link3) linksEntregues.push('Parte 3');
                if (entrega.Link4) linksEntregues.push('Parte 4');
                
                const notaEntrega = parseFloat(entrega.Nota) || 0;
                if (notaEntrega > 0) {
                    notaTotal += notaEntrega;
                    countEntregas++;
                }
                
                relatorioHTML += `
                    <tr>
                        <td>${temaTarefa}</td>
                        <td>${linksEntregues.join(', ') || 'Nenhum'}</td>
                        <td class="data-column">${formatarData(entrega.DataSubmissao)}</td>
                        <td class="data-column font-semibold">${notaEntrega.toFixed(1)}</td>
                    </tr>
                `;
            });
            
            const media = countEntregas > 0 ? (notaTotal / countEntregas).toFixed(1) : '0.0';
            
            relatorioHTML += `
                        </tbody>
                    </table>
                    <div class="mt-4 p-3 bg-gray-50 rounded border">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold">Média Geral:</span>
                            <span class="text-lg font-bold ${parseFloat(media) >= 7.5 ? 'text-green-600' : 'text-red-600'}">${media}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        relatorioHTML += `
                <div class="mt-4 text-center">
                    <button onclick="mostrarPainelAluno()" class="btn-secondary">Voltar ao Painel</button>
                </div>
            </div>
        `;
        
        contentArea.innerHTML = relatorioHTML;
    } catch (error) {
        showModal('Erro', `Erro ao carregar relatório: ${error.message}`);
    }
}

// --- PAINEL DO PROFESSOR ---
async function mostrarPainelProfessor() {
    contentArea.innerHTML = `
        <div id="painelProfessor" class="space-y-6">
            <div class="card p-6 border-t-4 border-red-600">
                <h3 class="text-2xl font-bold mb-4 text-red-700" id="titulo-formulario">${tarefaEditando ? 'Editar Tarefa' : 'Criar Nova Tarefa'}</h3>
                
                <div class="form-row">
                    <label class="block text-sm font-medium text-gray-700">Turmas:</label>
                    <div class="checkbox-group" id="turmasCheckboxes"></div>
                </div>
                
                <div class="form-row">
                    <label for="tema" class="block text-sm font-medium text-gray-700">Tema da Tarefa</label>
                    <input type="text" id="tema" placeholder="Ex: Matemática - Frações" class="mt-1" required>
                </div>
                
                <div class="form-row">
                    <label for="dataAula" class="block text-sm font-medium text-gray-700">Data da Aula</label>
                    <input type="date" id="dataAula" class="mt-1" required>
                </div>
                
                <div class="mt-4 space-y-4">
                    <div>
                        <label for="parte1" class="block text-sm font-medium text-gray-700 mb-2">Parte 1 (até 18h do dia)</label>
                        <textarea id="parte1" placeholder="Descreva a parte 1 da tarefa" rows="3" required></textarea>
                    </div>
                    <div>
                        <label for="parte2" class="block text-sm font-medium text-gray-700 mb-2">Parte 2 (3º-7º dia)</label>
                        <textarea id="parte2" placeholder="Descreva a parte 2 da tarefa" rows="3" required></textarea>
                    </div>
                    <div>
                        <label for="parte3" class="block text-sm font-medium text-gray-700 mb-2">Parte 3 (8º-14º dia)</label>
                        <textarea id="parte3" placeholder="Descreva a parte 3 da tarefa" rows="3" required></textarea>
                    </div>
                    <div>
                        <label for="parte4" class="block text-sm font-medium text-gray-700 mb-2">Parte 4 (15º-28º dia)</label>
                        <textarea id="parte4" placeholder="Descreva a parte 4 da tarefa" rows="3" required></textarea>
                    </div>
                </div>
                
                <div class="mt-6 flex space-x-4">
                    <button onclick="${tarefaEditando ? 'atualizarTarefa()' : 'salvarTarefa()'}" class="btn-primary flex-1" id="btnSalvarTarefa">
                        ${tarefaEditando ? 'Atualizar Tarefa' : 'Salvar Tarefa'}
                    </button>
                    <button onclick="limparFormulario()" class="btn-secondary flex-1">
                        ${tarefaEditando ? 'Cancelar Edição' : 'Limpar'}
                    </button>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="text-2xl font-bold mb-4 text-red-700">Tarefas Criadas</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full compact-table">
                        <thead>
                            <tr>
                                <th class="turma-column">Turma</th>
                                <th>Tema e Partes</th>
                                <th class="data-column">Data</th>
                                <th class="acoes-column">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaTarefasBody">
                            <tr>
                                <td colspan="4" class="text-center py-4 text-gray-500">Carregando tarefas...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    const turmas = ["1A", "1B", "2A", "2B", "3A", "3B"];
    document.getElementById('turmasCheckboxes').innerHTML = turmas.map(t => `
        <div class="checkbox-item">
            <input type="checkbox" value="${t}" class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
            <label class="text-gray-700">${t}</label>
        </div>
    `).join("");

    if (tarefaEditando) {
        preencherFormularioEdicao();
    }

    await carregarTarefasProfessor();
}

function preencherFormularioEdicao() {
    if (!tarefaEditando) return;
    
    document.getElementById('titulo-formulario').textContent = 'Editar Tarefa';
    document.getElementById('tema').value = tarefaEditando.Tema;
    document.getElementById('dataAula').value = tarefaEditando.DataAula.split('T')[0];
    document.getElementById('parte1').value = tarefaEditando.Parte1 || '';
    document.getElementById('parte2').value = tarefaEditando.Parte2 || '';
    document.getElementById('parte3').value = tarefaEditando.Parte3 || '';
    document.getElementById('parte4').value = tarefaEditando.Parte4 || '';
    
    const checkboxes = document.querySelectorAll('#turmasCheckboxes input');
    checkboxes.forEach(checkbox => {
        checkbox.checked = checkbox.value === tarefaEditando.Turma;
    });
    
    window.scrollTo(0, 0);
}

// --- FUNÇÕES DO PROFESSOR ---
async function carregarTarefasProfessor() {
    try {
        const response = await apiGet('getTarefas');
        tarefas = response.data || [];
        renderizarTabelaTarefas();
    } catch (error) {
        document.getElementById('tabelaTarefasBody').innerHTML = 
            `<tr><td colspan="4" class="text-center py-4 text-red-500">Erro ao carregar tarefas: ${error.message}</td></tr>`;
    }
}

function renderizarTabelaTarefas() {
    const tbody = document.getElementById('tabelaTarefasBody');
    
    if (tarefas.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">Nenhuma tarefa criada</td></tr>`;
        return;
    }

    tbody.innerHTML = tarefas.map(tarefa => {
        const parte1 = tarefa.Parte1 || '';
        const parte2 = tarefa.Parte2 || '';
        const parte3 = tarefa.Parte3 || '';
        const parte4 = tarefa.Parte4 || '';

        return `
        <tr>
            <td class="turma-column">${tarefa.Turma}</td>
            <td class="px-4 py-2">
                <div class="font-semibold text-gray-800 mb-2">${tarefa.Tema}</div>
                ${parte1 ? `<div class="text-sm text-gray-600 mb-1"><span class="font-medium">Parte 1:</span> ${parte1}</div>` : ''}
                ${parte2 ? `<div class="text-sm text-gray-600 mb-1"><span class="font-medium">Parte 2:</span> ${parte2}</div>` : ''}
                ${parte3 ? `<div class="text-sm text-gray-600 mb-1"><span class="font-medium">Parte 3:</span> ${parte3}</div>` : ''}
                ${parte4 ? `<div class="text-sm text-gray-600"><span class="font-medium">Parte 4:</span> ${parte4}</div>` : ''}
            </td>
            <td class="data-column">${formatarData(tarefa.DataAula)}</td>
            <td class="acoes-column">
                <div class="flex justify-center space-x-2">
                    <button onclick="editarTarefa('${tarefa.ID}')" class="btn-editar">
                        Editar
                    </button>
                    <button onclick="solicitarExclusaoTarefa('${tarefa.ID}')" class="btn-excluir">
                        Excluir
                    </button>
                </div>
            </td>
        </tr>
        `;
    }).join('');
}

function solicitarExclusaoTarefa(idTarefa) {
    const tarefa = tarefas.find(t => t.ID === idTarefa);
    tarefaParaExcluir = idTarefa;
    showConfirmModal(`Tem certeza que deseja excluir a tarefa "${tarefa?.Tema}" da turma ${tarefa?.Turma}?`, () => {
        excluirTarefa(idTarefa);
    });
}

async function editarTarefa(idTarefa) {
    const tarefa = tarefas.find(t => t.ID === idTarefa);
    if (!tarefa) {
        showModal('Erro', 'Tarefa não encontrada.');
        return;
    }

    tarefaEditando = tarefa;
    await mostrarPainelProfessor();
    
    setTimeout(() => {
        if (document.getElementById('tema')) {
            document.getElementById('tema').value = tarefaEditando.Tema;
            document.getElementById('dataAula').value = tarefaEditando.DataAula.split('T')[0];
            document.getElementById('parte1').value = tarefaEditando.Parte1 || '';
            document.getElementById('parte2').value = tarefaEditando.Parte2 || '';
            document.getElementById('parte3').value = tarefaEditando.Parte3 || '';
            document.getElementById('parte4').value = tarefaEditando.Parte4 || '';
            
            const checkboxes = document.querySelectorAll('#turmasCheckboxes input');
            checkboxes.forEach(checkbox => {
                checkbox.checked = checkbox.value === tarefaEditando.Turma;
            });
            
            window.scrollTo(0, 0);
        }
    }, 100);
}

async function salvarTarefa() {
    const btnSalvar = document.getElementById('btnSalvarTarefa');
    
    try {
        setButtonLoading(btnSalvar, true);
        
        const turmasSelecionadas = Array.from(document.querySelectorAll('#turmasCheckboxes input:checked'))
            .map(c => c.value);
        
        if (turmasSelecionadas.length === 0) {
            showModal('Atenção', 'Selecione pelo menos uma turma.');
            return;
        }

        const tema = document.getElementById('tema').value.trim();
        const dataAula = document.getElementById('dataAula').value;

        if (!tema || !dataAula) {
            showModal('Atenção', 'Preencha o tema e a data da aula.');
            return;
        }

        const parte1 = document.getElementById('parte1').value.trim();
        const parte2 = document.getElementById('parte2').value.trim();
        const parte3 = document.getElementById('parte3').value.trim();
        const parte4 = document.getElementById('parte4').value.trim();

        if (!parte1 || !parte2 || !parte3 || !parte4) {
            showModal('Atenção', 'Todas as partes da tarefa devem ser preenchidas.');
            return;
        }

        const dados = {
            Turmas: turmasSelecionadas,
            Tema: tema,
            Parte1: parte1,
            Parte2: parte2,
            Parte3: parte3,
            Parte4: parte4,
            DataAula: dataAula,
            professor: usuarioLogado.NomeCompleto
        };

        const response = await apiPost('criarTarefa', dados);
        showModal('Sucesso', 'Tarefa criada com sucesso!');
        limparFormulario();
        await carregarTarefasProfessor();
    } catch (error) {
        showModal('Erro', `Erro ao criar tarefa: ${error.message}`);
    } finally {
        setButtonLoading(btnSalvar, false);
    }
}

async function atualizarTarefa() {
    const btnSalvar = document.getElementById('btnSalvarTarefa');
    
    try {
        setButtonLoading(btnSalvar, true);
        
        if (!tarefaEditando) {
            showModal('Erro', 'Nenhuma tarefa selecionada para edição.');
            return;
        }

        const tema = document.getElementById('tema').value.trim();
        const dataAula = document.getElementById('dataAula').value;
        const turmaSelecionada = Array.from(document.querySelectorAll('#turmasCheckboxes input:checked'))
            .map(c => c.value)[0];

        if (!tema || !dataAula || !turmaSelecionada) {
            showModal('Atenção', 'Preencha todos os campos obrigatórios.');
            return;
        }

        const parte1 = document.getElementById('parte1').value.trim();
        const parte2 = document.getElementById('parte2').value.trim();
        const parte3 = document.getElementById('parte3').value.trim();
        const parte4 = document.getElementById('parte4').value.trim();

        if (!parte1 || !parte2 || !parte3 || !parte4) {
            showModal('Atenção', 'Todas as partes da tarefa devem ser preenchidas.');
            return;
        }

        const dados = {
            ID: tarefaEditando.ID,
            Tema: tema,
            Parte1: parte1,
            Parte2: parte2,
            Parte3: parte3,
            Parte4: parte4,
            DataAula: dataAula
        };

        const response = await apiPost('editarTarefa', dados);
        showModal('Sucesso', 'Tarefa atualizada com sucesso!');
        
        tarefaEditando = null;
        limparFormulario();
        
    } catch (error) {
        showModal('Erro', `Erro ao atualizar tarefa: ${error.message}`);
    } finally {
        setButtonLoading(btnSalvar, false);
    }
}

async function excluirTarefa(idTarefa) {
    try {
        await apiPost('excluirTarefa', { ID: idTarefa });
        showModal('Sucesso', 'Tarefa excluída com sucesso.');
        await carregarTarefasProfessor();
    } catch (error) {
        showModal('Erro', `Erro ao excluir tarefa: ${error.message}`);
    }
}

function limparFormulario() {
    document.getElementById('tema').value = '';
    document.getElementById('dataAula').value = '';
    document.getElementById('parte1').value = '';
    document.getElementById('parte2').value = '';
    document.getElementById('parte3').value = '';
    document.getElementById('parte4').value = '';
    document.querySelectorAll('#turmasCheckboxes input:checked').forEach(c => c.checked = false);
    
    if (tarefaEditando) {
        tarefaEditando = null;
        document.getElementById('titulo-formulario').textContent = 'Criar Nova Tarefa';
        document.getElementById('btnSalvarTarefa').textContent = 'Salvar Tarefa';
        document.getElementById('btnSalvarTarefa').setAttribute('onclick', 'salvarTarefa()');
        
        setTimeout(() => {
            carregarTarefasProfessor();
        }, 100);
    }
}

// --- PAINEL DO ALUNO ---
async function mostrarPainelAluno() {
    contentArea.innerHTML = `
        <div id="painelAluno" class="space-y-6">
            <div class="card p-6">
                <h3 class="text-2xl font-bold text-red-700 mb-4">Minhas Tarefas - Turma ${usuarioLogado.Turma}</h3>
                <div id="tarefas-aluno-container">
                    <div class="text-center text-gray-500 py-8">Carregando tarefas...</div>
                </div>
            </div>
        </div>
    `;

    await carregarTarefasAluno();
    iniciarAtualizacaoContadores();
}

async function carregarTarefasAluno() {
    mostrarLoadingTarefasAluno();
    
    try {
        const response = await apiGet('getTarefasPorTurma', { turma: usuarioLogado.Turma });
        const container = document.getElementById('tarefas-aluno-container');
        
        if (!response.data || response.data.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-8">Nenhuma tarefa disponível para sua turma.</div>';
            return;
        }

        let entregas = [];
        try {
            const entregasResponse = await apiGet('getEntregasAluno', { ra: usuarioLogado.RA });
            entregas = entregasResponse.data || [];
        } catch (error) {
            console.error('Erro ao carregar entregas:', error);
        }

        container.innerHTML = '';
        
        for (let i = 0; i < response.data.length; i++) {
            const tarefa = response.data[i];
            
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const parte1 = tarefa.Parte1 || '';
            const parte2 = tarefa.Parte2 || '';
            const parte3 = tarefa.Parte3 || '';
            const parte4 = tarefa.Parte4 || '';
            
            const contadores = calcularContadores(tarefa.DataAula);
            const entrega = entregas.find(e => e.ID_Tarefa === tarefa.ID);

            const tarefaHTML = `
            <div class="border border-gray-200 rounded-lg p-4 mb-4">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h4 class="font-semibold text-lg text-gray-800">${tarefa.Tema}</h4>
                        <p class="text-sm text-gray-600 mt-1">Data da aula: ${formatarData(tarefa.DataAula)}</p>
                        ${entrega && entrega.Nota ? `<p class="text-sm font-semibold text-green-600 mt-1">Nota: ${entrega.Nota}</p>` : ''}
                        
                        ${parte1 ? renderParteTarefa(tarefa.ID, 1, parte1, contadores.parte1, entrega) : ''}
                        ${parte2 ? renderParteTarefa(tarefa.ID, 2, parte2, contadores.parte2, entrega) : ''}
                        ${parte3 ? renderParteTarefa(tarefa.ID, 3, parte3, contadores.parte3, entrega) : ''}
                        ${parte4 ? renderParteTarefa(tarefa.ID, 4, parte4, contadores.parte4, entrega) : ''}
                    </div>
                </div>
            </div>
            `;
            
            container.innerHTML += tarefaHTML;
            atualizarContadoresAluno();
        }
        
        const conclusao = document.createElement('div');
        conclusao.className = 'text-green-600 text-center mt-4 p-3 bg-green-50 rounded border border-green-200';
        conclusao.innerHTML = '<strong>✓ Todas as tarefas foram carregadas!</strong>';
        container.appendChild(conclusao);
        
        setTimeout(() => {
            if (conclusao.parentNode) {
                conclusao.remove();
            }
        }, 3000);
        
    } catch (error) {
        document.getElementById('tarefas-aluno-container').innerHTML = 
            `<div class="text-center text-red-500 py-8">Erro ao carregar tarefas: ${error.message}</div>`;
    }
}

function renderParteTarefa(idTarefa, numeroParte, conteudo, contador, entrega) {
    const linkSalvo = entrega ? entrega[`Link${numeroParte}`] : '';
    const inputId = `link-${idTarefa}-${numeroParte}`;
    const temLinkSalvo = linkSalvo && linkSalvo.trim() !== '';
    
    const disponivel = contador.liberada && !contador.expirado && !temLinkSalvo;
    const expirado = contador.expirado;

    return `
    <div class="mt-3 p-3 bg-gray-50 rounded border parte-${numeroParte}">
        <div class="flex justify-between items-center">
            <strong>Parte ${numeroParte}:</strong>
            <span class="contador ${contador.classe}">${contador.texto}</span>
        </div>
        <p class="mt-1">${conteudo}</p>
        <div class="link-container">
            <input type="text" 
                   class="link-input ${temLinkSalvo ? 'link-salvo' : ''}" 
                   placeholder="${!contador.liberada ? 'Aguardando liberação...' : (expirado ? 'Prazo expirado' : 'Cole o link da atividade aqui')}" 
                   id="${inputId}"
                   value="${linkSalvo || ''}"
                   ${!disponivel ? 'disabled' : ''}>
            <button class="btn-primary btn-link btn-salvar" 
                    onclick="salvarLink('${idTarefa}', ${numeroParte})"
                    ${!disponivel ? 'disabled' : ''}>
                Salvar
            </button>
            <button class="btn-secondary btn-link btn-excluir" 
                    onclick="excluirLink('${idTarefa}', ${numeroParte})"
                    ${!temLinkSalvo || expirado ? 'disabled' : ''}>
                Excluir
            </button>
        </div>
        ${temLinkSalvo ? '<p class="text-green-600 text-sm mt-1">✓ Link salvo com sucesso</p>' : ''}
    </div>`;
}

async function salvarLink(idTarefa, parte) {
    const input = document.getElementById(`link-${idTarefa}-${parte}`);
    const link = input.value.trim();

    if (!link) {
        showModal('Atenção', 'Por favor, cole um link válido.');
        return;
    }

    try {
        await apiPost('entregarTarefa', {
            ID_Tarefa: idTarefa,
            RA_Aluno: usuarioLogado.RA,
            NomeAluno: usuarioLogado.NomeCompleto,
            Turma: usuarioLogado.Turma,
            Parte: parte,
            [`Link${parte}`]: link
        });
        
        showModal('Sucesso', `Link da parte ${parte} salvo com sucesso!`);
        await carregarTarefasAluno();
    } catch (error) {
        showModal('Erro', `Erro ao salvar link: ${error.message}`);
    }
}

async function excluirLink(idTarefa, parte) {
    try {
        await apiPost('excluirEntrega', {
            ID_Tarefa: idTarefa,
            RA_Aluno: usuarioLogado.RA,
            Parte: parte
        });
        
        showModal('Sucesso', `Link da parte ${parte} excluído com sucesso!`);
        await carregarTarefasAluno();
    } catch (error) {
        showModal('Erro', `Erro ao excluir link: ${error.message}`);
    }
}

// --- INICIALIZAÇÃO ---
init();

// --- FUNÇÕES GLOBAIS ---
window.login = login;
window.logout = logout;
window.mostrarPainelProfessor = mostrarPainelProfessor;
window.mostrarPainelAluno = mostrarPainelAluno;
window.mostrarRelatorioProfessor = mostrarRelatorioProfessor;
window.mostrarRelatorioAluno = mostrarRelatorioAluno;
window.carregarRelatorioTurma = carregarRelatorioTurma;
window.salvarTarefa = salvarTarefa;
window.atualizarTarefa = atualizarTarefa;
window.excluirTarefa = excluirTarefa;
window.solicitarExclusaoTarefa = solicitarExclusaoTarefa;
window.editarTarefa = editarTarefa;
window.limparFormulario = limparFormulario;
window.closeModal = closeModal;
window.salvarLink = salvarLink;
window.excluirLink = excluirLink;
</script>
</body>
</html>
