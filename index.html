<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Tarefas Escolar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca de Ícones Lucide -->
    <script src="https://cdn.jsdelivr.net/npm/lucide-static@latest/dist/lucide.min.js"></script>
    
    <!-- Base de dados de utilizadores -->
    <script src="users.js"></script> 
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.2); }
        /* Design Primário: Vermelho SESI */
        .btn-primary { background-color: #CC0000; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; transition: background-color 0.2s; cursor: pointer; }
        .btn-primary:hover { background-color: #A00000; }
        .btn-secondary { background-color: #d1d5db; color: #1e1e1e; padding: 10px 20px; border-radius: 8px; font-weight: 600; transition: background-color 0.2s; cursor: pointer; }
        .btn-secondary:hover { background-color: #9ca3af; }
        input[type="email"], input[type="text"], input[type="url"], input[type="date"], textarea, select {
            border: 1px solid #d1d5db; padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box;
            transition: border-color 0.2s; margin-top: 4px; margin-bottom: 8px;
        }
        input:focus, textarea:focus, select:focus { border-color: #CC0000; outline: none; }
        [data-lucide] {
            width: 24px;
            height: 24px;
            display: inline-block;
        }
        /* Estilo da Tabela */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #CC0000; color: white; }
        tbody tr:nth-child(even) { background-color: #f9f9f9; }
        .hidden { display: none; }
        
        /* Checkboxes */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        .checkbox-group label {
            font-weight: normal;
            display: flex;
            align-items: center;
        }
        .checkbox-group input {
            width: auto;
            margin: 0 5px 0 0;
        }
        
        /* Status badges */
        .status-entregue { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .status-pendente { background-color: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .status-atrasada { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .status-avaliada { background-color: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        
        /* Loading */
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #CC0000; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 sm:p-8">

<div id="app-container" class="w-full max-w-6xl bg-white shadow-xl rounded-2xl p-6 sm:p-10 transition-all duration-300">
    <!-- Cabeçalho centralizado e botão posicionado -->
    <header class="mb-8 border-b pb-4 relative">
        <h1 class="text-3xl font-extrabold text-red-700 text-center">
            Gestão de Tarefas Escolar
        </h1>
        <div id="user-info" class="text-center text-sm text-gray-600 mt-2"></div>
        <button onclick="logout()" id="logoutBtn" class="btn-secondary hidden absolute top-0 right-0">Sair</button>
    </header>

    <!-- Conteúdo da Aplicação -->
    <div id="content-area">
        <!-- Tela de Login (Estado Inicial) -->
    </div>

    <footer class="mt-8 pt-4 border-t text-xs text-gray-500 text-center">
        Desenvolvido por Geovane Modena | Versão 3.5
    </footer>
</div>

<!-- Modal Customizado para Avisos -->
<div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full shadow-2xl">
        <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-600"></h3>
        <p id="modal-message" class="text-gray-700 mb-4 whitespace-pre-wrap"></p>
        <button onclick="closeModal()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition">
            OK
        </button>
    </div>
</div>

<!-- Modal de Entrega -->
<div id="modal-entrega" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <h3 class="text-xl font-bold mb-4">Entregar Tarefa: <span id="titulo-tarefa-entrega"></span></h3>
        <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <p class="text-sm text-yellow-700"><strong>Importante:</strong> Cada link entregue vale 2.5 pontos</p>
            <p class="text-xs text-yellow-600 mt-1">Parte 1: até 18h do dia da aula | Parte 2: 3º-7º dia | Parte 3: 8º-14º dia | Parte 4: 15º-28º dia</p>
        </div>
        <form id="form-entrega" class="space-y-4">
            <input type="hidden" id="tarefa-entrega-id">
            <input type="hidden" id="tarefa-entrega-data">
            <div id="campos-links" class="space-y-4">
                <!-- Campos dinâmicos para links -->
            </div>
            <div class="flex space-x-4">
                <button type="submit" class="btn-primary flex-1">Enviar Entrega</button>
                <button type="button" onclick="fecharModalEntrega()" class="btn-secondary flex-1">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Avaliação -->
<div id="modal-avaliacao" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <h3 class="text-xl font-bold mb-4">Avaliar Entrega</h3>
        <form id="form-avaliacao" class="space-y-4">
            <input type="hidden" id="avaliacao-id-entrega">
            <input type="hidden" id="avaliacao-ra-aluno">
            <input type="hidden" id="avaliacao-id-tarefa">
            
            <div>
                <label class="block text-sm font-medium text-gray-700">Aluno:</label>
                <p id="avaliacao-nome-aluno" class="font-semibold"></p>
            </div>
            
            <div id="links-entregues" class="space-y-2 p-4 bg-gray-50 rounded-lg"></div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                    <label for="avaliacao-parte1" class="block text-sm font-medium text-gray-700">Parte 1 (0-1)</label>
                    <input type="number" id="avaliacao-parte1" min="0" max="1" step="0.1" class="mt-1" value="0" onchange="calcularNotaTotal()">
                </div>
                <div>
                    <label for="avaliacao-parte2" class="block text-sm font-medium text-gray-700">Parte 2 (0-1)</label>
                    <input type="number" id="avaliacao-parte2" min="0" max="1" step="0.1" class="mt-1" value="0" onchange="calcularNotaTotal()">
                </div>
                <div>
                    <label for="avaliacao-parte3" class="block text-sm font-medium text-gray-700">Parte 3 (0-1)</label>
                    <input type="number" id="avaliacao-parte3" min="0" max="1" step="0.1" class="mt-1" value="0" onchange="calcularNotaTotal()">
                </div>
                <div>
                    <label for="avaliacao-parte4" class="block text-sm font-medium text-gray-700">Parte 4 (0-1)</label>
                    <input type="number" id="avaliacao-parte4" min="0" max="1" step="0.1" class="mt-1" value="0" onchange="calcularNotaTotal()">
                </div>
            </div>
            
            <div class="bg-blue-50 p-3 rounded border border-blue-200">
                <p class="text-sm text-blue-700"><strong>Nota Total Calculada:</strong> <span id="nota-total-calculada">0.0</span> pontos</p>
                <p class="text-xs text-blue-600">Cada parte entregue vale 2.5 pontos (1 × 2.5)</p>
            </div>
            
            <div class="flex space-x-4">
                <button type="submit" class="btn-primary flex-1">Salvar Avaliação</button>
                <button type="button" onclick="fecharModalAvaliacao()" class="btn-secondary flex-1">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<script>
// --- CONFIGURAÇÃO ---
const API_URL = "https://script.google.com/macros/s/AKfycbzKymbA3QgIdhBw7AfUJQveK3l3gbzT-2eccOJpF1K4E-HrEc51pefiJFWCEnDWZm4V/exec";
const API_CONFIG = {
    token: 'SESI_EDUCATION_2024'
};

// --- ESTADO DA APLICAÇÃO ---
let usuarios = window.listaDeUsuarios || []; 
let usuarioLogado = null;
let tarefas = [];
let entregas = [];

// --- ELEMENTOS DOM ---
const contentArea = document.getElementById('content-area');
const userInfoDisplay = document.getElementById('user-info');
const logoutBtn = document.getElementById('logoutBtn');
const modalOverlay = document.getElementById('modal-overlay');
const modalTitle = document.getElementById('modal-title');
const modalMessage = document.getElementById('modal-message');

// --- FUNÇÕES UTILITÁRIAS ---
const showModal = (title, message) => {
    modalTitle.textContent = title;
    modalMessage.textContent = message;
    modalOverlay.classList.remove('hidden');
    modalOverlay.classList.add('flex');
};

const closeModal = () => {
    modalOverlay.classList.add('hidden');
};
window.closeModal = closeModal;

const renderIcons = () => {
    if (window.lucide) {
        window.lucide.createIcons();
    }
};

const toggleLoading = (isLoading, elementId = 'loading-indicator') => {
    const indicator = document.getElementById(elementId);
    if (indicator) {
        indicator.classList.toggle('hidden', !isLoading);
    }
};

const formatarData = (dataISO) => {
    if (!dataISO) return 'N/A';
    return new Date(dataISO).toLocaleDateString('pt-BR');
};

const formatarDataHora = (dataISO) => {
    if (!dataISO) return 'N/A';
    return new Date(dataISO).toLocaleDateString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
};

// --- API REQUEST SEGURO ---
async function apiRequest(url, options = {}) {
    const config = {
        method: options.method || 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    };

    // Para requisições POST, adiciona o token
    if (config.method === 'POST' && options.body) {
        config.body = JSON.stringify({
            ...options.body,
            token: API_CONFIG.token
        });
    }

    try {
        console.log('Fazendo requisição para:', url, config);
        const response = await fetch(url, config);
        
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Resposta recebida:', data);
        
        if (data.status === 'error') {
            throw new Error(data.message);
        }
        
        return data;
    } catch (error) {
        console.error('Erro na requisição:', error);
        showModal('Erro de Conexão', 
            `Não foi possível conectar ao servidor.\n\nDetalhes: ${error.message}\n\nVerifique:\n• Se o Apps Script está publicado\n• Se a URL está correta\n• Sua conexão com internet`);
        throw error;
    }
}

// --- INICIALIZAÇÃO ---
async function init() {
    renderLogin();
}

// --- FUNÇÕES DE AUTENTICAÇÃO ---
const renderLogin = () => {
    contentArea.innerHTML = `
        <div id="login" class="max-w-md mx-auto p-6">
            <h2 class="text-2xl font-bold text-center text-red-700 mb-6">Login</h2>
            <div id="loading-message" class="text-center text-gray-500 mb-4"></div>
            <div id="loginErro" class="text-red-500 mb-4 hidden text-center font-semibold">Usuário ou RA incorretos!</div>

            <form id="login-form" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">E-mail</label>
                    <input type="email" id="email" name="email" required placeholder="seu.email@escola.com" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                </div>
                <div>
                    <label for="ra" class="block text-sm font-medium text-gray-700">RA (Registro Acadêmico)</label>
                    <input type="text" id="ra" name="ra" required placeholder="Apenas números" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                </div>
                <button type="submit" id="login-button" class="w-full flex justify-center items-center py-2 px-4 btn-primary transition-colors disabled:opacity-50" disabled>
                    <i data-lucide="log-in" class="mr-2"></i> Entrar
                </button>
            </form>
        </div>
    `;

    const loadingMessage = document.getElementById('loading-message');
    const loginButton = document.getElementById('login-button');

    if (usuarios.length > 0) {
        loadingMessage.textContent = "Pronto para o login.";
        loginButton.disabled = false;
    } else {
        loadingMessage.textContent = "Erro: Ficheiro 'users.js' não encontrado ou vazio.";
        showModal('Erro Crítico', 'Não foi possível ler o ficheiro local de utilizadores (users.js).');
    }

    document.getElementById('login-form').addEventListener('submit', login);
    renderIcons();
};

async function login(event) {
    event.preventDefault(); 
    const email = document.getElementById('email').value.trim();
    const ra = document.getElementById('ra').value.trim();
    
    const loginErro = document.getElementById('loginErro'); 
    const user = usuarios.find(u => u.Email.toLowerCase() === email.toLowerCase() && String(u.RA) === ra);
    
    if (!user) {
        loginErro.style.display = 'block';
        return;
    }
    
    usuarioLogado = user;
    loginErro.style.display = 'none';
    
    contentArea.innerHTML = `<div class="text-center text-gray-500 py-8">Carregando painel...</div>`;
    
    logoutBtn.classList.remove('hidden');
    userInfoDisplay.innerHTML = `Logado como: <span class="font-semibold text-red-700">${user.NomeCompleto} (${user.Perfil})</span> | Turma: ${user.Turma || 'N/A'}`;

    if (user.Perfil === "Professor") {
        await mostrarPainelProfessor();
    } else {
        await mostrarPainelAluno(); 
    }
    
    renderIcons(); 
}

function logout() {
    usuarioLogado = null;
    logoutBtn.classList.add('hidden');
    userInfoDisplay.innerHTML = '';
    renderLogin(); 
}

// --- PAINEL DO PROFESSOR ---
async function mostrarPainelProfessor() {
    contentArea.innerHTML = `
        <div id="painelProfessor" class="space-y-6">
            <!-- Gestão de Tarefas -->
            <div class="card p-6 border-t-4 border-red-600">
                <h3 class="text-2xl font-bold mb-4 text-red-700">Criar Nova Tarefa</h3>
                <input type="hidden" id="tarefaId" value="">

                <div>
                    <label class="block text-sm font-medium text-gray-700">Selecione as turmas:</label>
                    <div class="checkbox-group" id="turmasCheckboxes"></div>
                </div>
                
                <div class="mt-4">
                    <label for="tema" class="block text-sm font-medium text-gray-700">Tema da Tarefa *</label>
                    <input type="text" id="tema" placeholder="Ex: Matemática - Frações" class="mt-1" required>
                </div>
                
                <div class="mt-4">
                    <label for="dataAula" class="block text-sm font-medium text-gray-700">Data da Aula *</label>
                    <input type="date" id="dataAula" class="mt-1" required>
                </div>

                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Parte 1 (até 18h do dia)</label>
                        <textarea id="parte1" placeholder="Instruções para a primeira parte..." rows="3" class="mt-1"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Parte 2 (3º-7º dia)</label>
                        <textarea id="parte2" placeholder="Instruções para a segunda parte..." rows="3" class="mt-1"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Parte 3 (8º-14º dia)</label>
                        <textarea id="parte3" placeholder="Instruções para a terceira parte..." rows="3" class="mt-1"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Parte 4 (15º-28º dia)</label>
                        <textarea id="parte4" placeholder="Instruções para a quarta parte..." rows="3" class="mt-1"></textarea>
                    </div>
                </div>

                <div class="mt-6 bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <p class="text-sm text-blue-700"><strong>Importante:</strong> Cada parte entregue vale 2.5 pontos (total 10 pontos)</p>
                </div>

                <div class="mt-6 flex space-x-4">
                    <button onclick="salvarTarefa()" id="btnSalvar" class="btn-primary flex-1">
                        <i data-lucide="check-circle" class="mr-2"></i> Salvar Tarefa
                    </button>
                    <button onclick="limparFormulario()" class="btn-secondary flex-1">
                        <i data-lucide="x-circle" class="mr-2"></i> Limpar
                    </button>
                </div>
            </div>

            <!-- Avaliação de Entregas -->
            <div class="card p-6">
                <h3 class="text-2xl font-bold mb-4 text-red-700">Avaliar Entregas</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Selecionar Tarefa:</label>
                    <select id="selecionar-tarefa-avaliacao" onchange="carregarEntregasParaAvaliacao()" class="mt-1">
                        <option value="">Carregando tarefas...</option>
                    </select>
                </div>
                <div id="lista-entregas-avaliacao" class="space-y-4">
                    <div class="text-center text-gray-500">Selecione uma tarefa para ver as entregas</div>
                </div>
            </div>

            <!-- Lista de Tarefas -->
            <div class="card p-6">
                <h3 class="text-2xl font-bold mb-4 text-red-700">Tarefas Criadas</h3>
                <div class="overflow-x-auto">
                    <table id="tabelaTarefas">
                        <thead>
                            <tr>
                                <th>Turma</th>
                                <th>Tema</th>
                                <th>Data</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaTarefasBody">
                            <tr><td colspan="4" class="text-center py-4 text-gray-500">Carregando tarefas...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    // Popula checkboxes de turma
    const turmas = ["1A", "1B", "2A", "2B", "3A", "3B"];
    const checkboxes = turmas.map(t => `
        <label class="flex items-center">
            <input type="checkbox" value="${t}" class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
            <span class="ml-2 text-gray-700">${t}</span>
        </label>
    `).join("");
    document.getElementById('turmasCheckboxes').innerHTML = checkboxes;

    await carregarTarefasProfessor();
    await carregarTarefasParaAvaliacao();
    renderIcons();
}

// --- FUNÇÕES DO PROFESSOR ---
async function carregarTarefasProfessor() {
    try {
        const data = await apiRequest(`${API_URL}?func=getTarefas`);
        tarefas = data.data || [];
        renderizarTabelaTarefas();
    } catch (error) {
        document.getElementById('tabelaTarefasBody').innerHTML = 
            `<tr><td colspan="4" class="text-center py-4 text-red-500">Erro ao carregar tarefas</td></tr>`;
    }
}

async function carregarTarefasParaAvaliacao() {
    try {
        const data = await apiRequest(`${API_URL}?func=getTarefas`);
        const select = document.getElementById('selecionar-tarefa-avaliacao');
        
        select.innerHTML = '<option value="">Selecione uma tarefa...</option>' +
            data.data.map(tarefa => 
                `<option value="${tarefa.ID}">${tarefa.Turma} - ${tarefa.Tema}</option>`
            ).join('');
    } catch (error) {
        console.error('Erro ao carregar tarefas para avaliação:', error);
    }
}

async function carregarEntregasParaAvaliacao() {
    const tarefaId = document.getElementById('selecionar-tarefa-avaliacao').value;
    if (!tarefaId) return;

    try {
        const data = await apiRequest(`${API_URL}?func=getEntregasPorTarefa&idTarefa=${tarefaId}`);
        const container = document.getElementById('lista-entregas-avaliacao');
        
        if (!data.data || data.data.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-4">Nenhuma entrega para esta tarefa.</div>';
            return;
        }

        container.innerHTML = data.data.map(entrega => `
            <div class="border border-gray-200 rounded-lg p-4">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h4 class="font-semibold">${entrega.NomeCompleto}</h4>
                        <p class="text-sm text-gray-600">RA: ${entrega.RA_Aluno} | Turma: ${entrega.Turma}</p>
                        <p class="text-sm text-gray-500">Entregue em: ${formatarDataHora(entrega.DataSubmissao)}</p>
                        
                        ${entrega.Link1 ? `<p class="text-sm mt-2"><strong>Parte 1:</strong> <a href="${entrega.Link1}" target="_blank" class="text-blue-600 hover:underline">${entrega.Link1}</a></p>` : ''}
                        ${entrega.Link2 ? `<p class="text-sm"><strong>Parte 2:</strong> <a href="${entrega.Link2}" target="_blank" class="text-blue-600 hover:underline">${entrega.Link2}</a></p>` : ''}
                        ${entrega.Link3 ? `<p class="text-sm"><strong>Parte 3:</strong> <a href="${entrega.Link3}" target="_blank" class="text-blue-600 hover:underline">${entrega.Link3}</a></p>` : ''}
                        ${entrega.Link4 ? `<p class="text-sm"><strong>Parte 4:</strong> <a href="${entrega.Link4}" target="_blank" class="text-blue-600 hover:underline">${entrega.Link4}</a></p>` : ''}
                        
                        ${entrega.Nota ? `<p class="text-sm font-semibold mt-2 text-green-600">Nota: ${entrega.Nota}</p>` : ''}
                    </div>
                    
                    <div class="ml-4">
                        ${!entrega.Nota ? `
                            <button onclick="abrirModalAvaliacao('${entrega.ID_Entrega}', '${entrega.RA_Aluno}', '${entrega.NomeCompleto}', '${tarefaId}')" 
                                    class="btn-primary whitespace-nowrap">
                                <i data-lucide="star" class="mr-2"></i>
                                Avaliar
                            </button>
                        ` : `
                            <span class="inline-block px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">
                                Avaliada
                            </span>
                        `}
                    </div>
                </div>
            </div>
        `).join('');
        
        renderIcons();
    } catch (error) {
        document.getElementById('lista-entregas-avaliacao').innerHTML = 
            '<div class="text-center text-red-500 py-4">Erro ao carregar entregas.</div>';
    }
}

function renderizarTabelaTarefas() {
    const tbody = document.getElementById('tabelaTarefasBody');
    
    if (tarefas.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">Nenhuma tarefa criada</td></tr>`;
        return;
    }

    tbody.innerHTML = tarefas.map(tarefa => `
        <tr>
            <td class="py-3">${tarefa.Turma}</td>
            <td class="py-3">
                <div class="font-semibold">${tarefa.Tema}</div>
                ${tarefa.Parte1 ? `<div class="text-xs text-gray-600 mt-1">Parte 1: ${tarefa.Parte1.substring(0, 50)}...</div>` : ''}
            </td>
            <td class="py-3">${formatarData(tarefa.DataAula)}</td>
            <td class="py-3">
                <button onclick="editarTarefa('${tarefa.ID}')" class="text-blue-600 hover:text-blue-800 mr-3" title="Editar">
                    <i data-lucide="edit" class="w-4 h-4"></i>
                </button>
                <button onclick="excluirTarefa('${tarefa.ID}')" class="text-red-600 hover:text-red-800" title="Excluir">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </td>
        </tr>
    `).join('');
    
    renderIcons();
}

async function salvarTarefa() {
    const turmasSelecionadas = Array.from(document.querySelectorAll('#turmasCheckboxes input:checked'))
        .map(c => c.value);
    
    if (turmasSelecionadas.length === 0) {
        showModal('Atenção', 'Selecione pelo menos uma turma.');
        return;
    }

    const tema = document.getElementById('tema').value.trim();
    const dataAula = document.getElementById('dataAula').value;

    if (!tema || !dataAula) {
        showModal('Atenção', 'Preencha o tema e a data da aula.');
        return;
    }

    const dados = {
        Turmas: turmasSelecionadas,
        Tema: tema,
        Parte1: document.getElementById('parte1').value.trim(),
        Parte2: document.getElementById('parte2').value.trim(),
        Parte3: document.getElementById('parte3').value.trim(),
        Parte4: document.getElementById('parte4').value.trim(),
        DataAula: dataAula
    };

    try {
        await apiRequest(API_URL, {
            method: 'POST',
            body: {
                action: 'criarTarefa',
                ...dados
            }
        });
        
        showModal('Sucesso', 'Tarefa criada com sucesso!');
        limparFormulario();
        await carregarTarefasProfessor();
        await carregarTarefasParaAvaliacao();
    } catch (error) {
        // Erro já tratado na apiRequest
    }
}

async function excluirTarefa(idTarefa) {
    if (!confirm("Tem certeza que deseja excluir esta tarefa?")) return;
    
    try {
        await apiRequest(API_URL, {
            method: 'POST',
            body: {
                action: 'excluirTarefa',
                ID: idTarefa
            }
        });
        
        showModal('Sucesso', 'Tarefa excluída com sucesso.');
        await carregarTarefasProfessor();
        await carregarTarefasParaAvaliacao();
    } catch (error) {
        // Erro já tratado na apiRequest
    }
}

function editarTarefa(idTarefa) {
    showModal('Funcionalidade em Desenvolvimento', 'A edição de tarefas será implementada em breve!');
}

function limparFormulario() {
    document.getElementById('tarefaId').value = '';
    document.getElementById('tema').value = '';
    document.getElementById('dataAula').value = '';
    document.getElementById('parte1').value = '';
    document.getElementById('parte2').value = '';
    document.getElementById('parte3').value = '';
    document.getElementById('parte4').value = '';
    
    document.querySelectorAll('#turmasCheckboxes input:checked').forEach(c => c.checked = false);
}

// --- SISTEMA DE AVALIAÇÃO ---
function abrirModalAvaliacao(idEntrega, raAluno, nomeAluno, idTarefa) {
    document.getElementById('avaliacao-id-entrega').value = idEntrega;
    document.getElementById('avaliacao-ra-aluno').value = raAluno;
    document.getElementById('avaliacao-nome-aluno').textContent = nomeAluno;
    document.getElementById('avaliacao-id-tarefa').value = idTarefa;
    
    // Limpar campos de nota
    document.getElementById('avaliacao-parte1').value = 0;
    document.getElementById('avaliacao-parte2').value = 0;
    document.getElementById('avaliacao-parte3').value = 0;
    document.getElementById('avaliacao-parte4').value = 0;
    document.getElementById('nota-total-calculada').textContent = '0.0';
    
    document.getElementById('modal-avaliacao').classList.remove('hidden');
    document.getElementById('modal-avaliacao').classList.add('flex');
}

function fecharModalAvaliacao() {
    document.getElementById('modal-avaliacao').classList.add('hidden');
}

function calcularNotaTotal() {
    const parte1 = parseFloat(document.getElementById('avaliacao-parte1').value) || 0;
    const parte2 = parseFloat(document.getElementById('avaliacao-parte2').value) || 0;
    const parte3 = parseFloat(document.getElementById('avaliacao-parte3').value) || 0;
    const parte4 = parseFloat(document.getElementById('avaliacao-parte4').value) || 0;
    
    const notaTotal = (parte1 + parte2 + parte3 + parte4) * 2.5;
    document.getElementById('nota-total-calculada').textContent = notaTotal.toFixed(1);
}

async function salvarAvaliacao(event) {
    event.preventDefault();
    
    const idEntrega = document.getElementById('avaliacao-id-entrega').value;
    const raAluno = document.getElementById('avaliacao-ra-aluno').value;
    
    const dados = {
        ID_Entrega: idEntrega,
        RA_Aluno: raAluno,
        NotaParte1: parseFloat(document.getElementById('avaliacao-parte1').value) || 0,
        NotaParte2: parseFloat(document.getElementById('avaliacao-parte2').value) || 0,
        NotaParte3: parseFloat(document.getElementById('avaliacao-parte3').value) || 0,
        NotaParte4: parseFloat(document.getElementById('avaliacao-parte4').value) || 0
    };

    try {
        await apiRequest(API_URL, {
            method: 'POST',
            body: {
                action: 'avaliarEntrega',
                ...dados
            }
        });
        
        showModal('Sucesso', 'Avaliação salva com sucesso!');
        fecharModalAvaliacao();
        await carregarEntregasParaAvaliacao();
    } catch (error) {
        // Erro já tratado na apiRequest
    }
}

// --- PAINEL DO ALUNO ---
async function mostrarPainelAluno() {
    contentArea.innerHTML = `
        <div id="painelAluno" class="space-y-6">
            <!-- Cabeçalho -->
            <div class="card p-6">
                <h3 class="text-2xl font-bold text-red-700 mb-2">Minhas Tarefas</h3>
                <p class="text-gray-600">Turma: ${usuarioLogado.Turma} | RA: ${usuarioLogado.RA}</p>
            </div>

            <!-- Lista de Tarefas Pendentes -->
            <div class="card p-6">
                <h4 class="text-xl font-semibold mb-4 text-gray-800">Tarefas Disponíveis</h4>
                <div id="lista-tarefas-aluno" class="space-y-4">
                    <div class="text-center text-gray-500 py-8">Carregando tarefas...</div>
                </div>
            </div>

            <!-- Histórico de Entregas -->
            <div class="card p-6">
                <h4 class="text-xl font-semibold mb-4 text-gray-800">Minhas Entregas</h4>
                <div id="historico-entregas">
                    <div class="text-center text-gray-500 py-8">Carregando histórico...</div>
                </div>
            </div>
        </div>
    `;

    await carregarTarefasAluno();
    await carregarHistoricoEntregas();
}

// --- FUNÇÕES DO ALUNO ---
async function carregarTarefasAluno() {
    try {
        const data = await apiRequest(`${API_URL}?func=getTarefasPorTurma&turma=${usuarioLogado.Turma}`);
        const container = document.getElementById('lista-tarefas-aluno');
        
        if (!data.data || data.data.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-8">Nenhuma tarefa disponível para sua turma.</div>';
            return;
        }

        // Carregar entregas do aluno para verificar status
        const entregasAluno = await carregarEntregasAluno();

        container.innerHTML = data.data.map(tarefa => {
            const entrega = entregasAluno.find(e => e.ID_Tarefa === tarefa.ID);
            const prazo = new Date(tarefa.DataAula);
            const hoje = new Date();
            const atrasada = prazo < hoje;
            
            return `
                <div class="border rounded-lg p-4 ${atrasada && !entrega ? 'border-red-300 bg-red-50' : 'border-gray-200'}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h5 class="font-semibold text-lg">${tarefa.Tema}</h5>
                            <p class="text-sm text-gray-600 mt-1">Data da Aula: ${formatarData(tarefa.DataAula)}</p>
                            ${tarefa.Parte1 ? `<p class="text-sm mt-2"><strong>Parte 1:</strong> ${tarefa.Parte1}</p>` : ''}
                            ${tarefa.Parte2 ? `<p class="text-sm"><strong>Parte 2:</strong> ${tarefa.Parte2}</p>` : ''}
                            ${tarefa.Parte3 ? `<p class="text-sm"><strong>Parte 3:</strong> ${tarefa.Parte3}</p>` : ''}
                            ${tarefa.Parte4 ? `<p class="text-sm"><strong>Parte 4:</strong> ${tarefa.Parte4}</p>` : ''}
                        </div>
                        <div class="text-right ml-4">
                            ${entrega ? `
                                <span class="inline-block px-3 py-1 status-avaliada rounded-full text-sm">
                                    <i data-lucide="check-circle" class="w-4 h-4 inline mr-1"></i>
                                    ${entrega.Nota ? `Avaliada: ${entrega.Nota}` : 'Entregue'}
                                </span>
                            ` : `
                                <button onclick="abrirModalEntrega('${tarefa.ID}', '${tarefa.Tema}', '${tarefa.DataAula}')" 
                                        class="btn-primary ${atrasada ? 'bg-orange-600 hover:bg-orange-700' : ''}">
                                    <i data-lucide="upload" class="mr-2"></i>
                                    ${atrasada ? 'Entregar com Atraso' : 'Entregar Tarefa'}
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        renderIcons();
    } catch (error) {
        document.getElementById('lista-tarefas-aluno').innerHTML = 
            '<div class="text-center text-red-500 py-8">Erro ao carregar tarefas.</div>';
    }
}

async function carregarEntregasAluno() {
    try {
        const data = await apiRequest(`${API_URL}?func=getEntregasAluno&ra=${usuarioLogado.RA}`);
        return data.data || [];
    } catch (error) {
        return [];
    }
}

async function carregarHistoricoEntregas() {
    try {
        const entregas = await carregarEntregasAluno();
        const container = document.getElementById('historico-entregas');
        
        if (entregas.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-8">Nenhuma entrega registrada.</div>';
            return;
        }

        container.innerHTML = entregas.map(entrega => {
            const tarefa = tarefas.find(t => t.ID === entrega.ID_Tarefa);
            return `
                <div class="border border-gray-200 rounded-lg p-4 mb-4">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h5 class="font-semibold">${tarefa ? tarefa.Tema : 'Tarefa não encontrada'}</h5>
                            <p class="text-sm text-gray-600">Entregue em: ${formatarDataHora(entrega.DataSubmissao)}</p>
                            
                            ${entrega.Link1 ? `<p class="text-sm mt-2"><strong>Parte 1:</strong> <a href="${entrega.Link1}" target="_blank" class="text-blue-600 hover:underline">${entrega.Link1}</a></p>` : ''}
                            ${entrega.Link2 ? `<p class="text-sm"><strong>Parte 2:</strong> <a href="${entrega.Link2}" target="_blank" class="text-blue-600 hover:underline">${entrega.Link2}</a></p>` : ''}
                            ${entrega.Link3 ? `<p class="text-sm"><strong>Parte 3:</strong> <a href="${entrega.Link3}" target="_blank" class="text-blue-600 hover:underline">${entrega.Link3}</a></p>` : ''}
                            ${entrega.Link4 ? `<p class="text-sm"><strong>Parte 4:</strong> <a href="${entrega.Link4}" target="_blank" class="text-blue-600 hover:underline">${entrega.Link4}</a></p>` : ''}
                            
                            ${entrega.Nota ? `<p class="text-sm font-semibold mt-2 text-green-600">Nota: ${entrega.Nota}</p>` : '<p class="text-sm text-gray-500 mt-2">Aguardando avaliação</p>'}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        renderIcons();
    } catch (error) {
        document.getElementById('historico-entregas').innerHTML = 
            '<div class="text-center text-red-500 py-8">Erro ao carregar histórico.</div>';
    }
}

// --- SISTEMA DE ENTREGAS ---
function abrirModalEntrega(idTarefa, temaTarefa, dataAula) {
    document.getElementById('tarefa-entrega-id').value = idTarefa;
    document.getElementById('tarefa-entrega-data').value = dataAula;
    document.getElementById('titulo-tarefa-entrega').textContent = temaTarefa;
    
    // Criar campos dinâmicos para links
    const camposLinks = document.getElementById('campos-links');
    camposLinks.innerHTML = `
        <div>
            <label class="block text-sm font-medium text-gray-700">Link da Parte 1 (até 18h do dia da aula)</label>
            <input type="url" id="link-parte1" placeholder="https://..." class="mt-1">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">Link da Parte 2 (3º-7º dia)</label>
            <input type="url" id="link-parte2" placeholder="https://..." class="mt-1">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">Link da Parte 3 (8º-14º dia)</label>
            <input type="url" id="link-parte3" placeholder="https://..." class="mt-1">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700">Link da Parte 4 (15º-28º dia)</label>
            <input type="url" id="link-parte4" placeholder="https://..." class="mt-1">
        </div>
    `;
    
    document.getElementById('modal-entrega').classList.remove('hidden');
    document.getElementById('modal-entrega').classList.add('flex');
}

function fecharModalEntrega() {
    document.getElementById('modal-entrega').classList.add('hidden');
}

async function entregarTarefa(event) {
    event.preventDefault();
    
    const idTarefa = document.getElementById('tarefa-entrega-id').value;
    const temaTarefa = document.getElementById('titulo-tarefa-entrega').textContent;
    
    const dados = {
        ID_Tarefa: idTarefa,
        TemaTarefa: temaTarefa,
        RA_Aluno: usuarioLogado.RA,
        NomeAluno: usuarioLogado.NomeCompleto,
        Turma: usuarioLogado.Turma,
        Link1: document.getElementById('link-parte1').value.trim(),
        Link2: document.getElementById('link-parte2').value.trim(),
        Link3: document.getElementById('link-parte3').value.trim(),
        Link4: document.getElementById('link-parte4').value.trim()
    };

    // Verificar se pelo menos um link foi preenchido
    if (!dados.Link1 && !dados.Link2 && !dados.Link3 && !dados.Link4) {
        showModal('Atenção', 'Preencha pelo menos um link de entrega.');
        return;
    }

    try {
        await apiRequest(API_URL, {
            method: 'POST',
            body: {
                action: 'entregarTarefa',
                ...dados
            }
        });
        
        showModal('Sucesso', 'Entrega registrada com sucesso!');
        fecharModalEntrega();
        await carregarTarefasAluno();
        await carregarHistoricoEntregas();
    } catch (error) {
        // Erro já tratado na apiRequest
    }
}

// Configurar evento de submit para o formulário de entrega
document.addEventListener('DOMContentLoaded', function() {
    // Esta função será chamada quando o modal for adicionado ao DOM
    setTimeout(() => {
        const formEntrega = document.getElementById('form-entrega');
        if (formEntrega) {
            formEntrega.addEventListener('submit', entregarTarefa);
        }
    }, 1000);
});

// --- INICIALIZAÇÃO ---
init();

// --- FUNÇÕES GLOBAIS ---
window.login = login;
window.logout = logout;
window.mostrarPainelProfessor = mostrarPainelProfessor;
window.salvarTarefa = salvarTarefa;
window.excluirTarefa = excluirTarefa;
window.editarTarefa = editarTarefa;
window.limparFormulario = limparFormulario;
window.mostrarPainelAluno = mostrarPainelAluno;
window.abrirModalEntrega = abrirModalEntrega;
window.fecharModalEntrega = fecharModalEntrega;
window.entregarTarefa = entregarTarefa;
window.carregarEntregasParaAvaliacao = carregarEntregasParaAvaliacao;
window.abrirModalAvaliacao = abrirModalAvaliacao;
window.fecharModalAvaliacao = fecharModalAvaliacao;
window.calcularNotaTotal = calcularNotaTotal;
window.salvarAvaliacao = salvarAvaliacao;
window.closeModal = closeModal;
</script>
</body>
</html>
