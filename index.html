<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Tarefas Escolar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide-static@latest/dist/lucide.min.js"></script>
    
    <!-- Base de dados de utilizadores -->
    <script src="users.js"></script> 
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.2); }
        .btn-primary { background-color: #CC0000; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; transition: background-color 0.2s; cursor: pointer; }
        .btn-primary:hover { background-color: #A00000; }
        .btn-secondary { background-color: #d1d5db; color: #1e1e1e; padding: 10px 20px; border-radius: 8px; font-weight: 600; transition: background-color 0.2s; cursor: pointer; }
        .btn-secondary:hover { background-color: #9ca3af; }
        input, textarea, select {
            border: 1px solid #d1d5db; padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box;
            transition: border-color 0.2s; margin-top: 4px; margin-bottom: 8px;
        }
        input:focus, textarea:focus, select:focus { border-color: #CC0000; outline: none; }
        [data-lucide] { width: 24px; height: 24px; display: inline-block; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #CC0000; color: white; }
        tbody tr:nth-child(even) { background-color: #f9f9f9; }
        .hidden { display: none; }
        
        .checkbox-group {
            display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; padding: 10px;
            background-color: #f9f9f9; border-radius: 8px;
        }
        .checkbox-group label { font-weight: normal; display: flex; align-items: center; }
        .checkbox-group input { width: auto; margin: 0 5px 0 0; }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 sm:p-8">

<div id="app-container" class="w-full max-w-6xl bg-white shadow-xl rounded-2xl p-6 sm:p-10 transition-all duration-300">
    <header class="mb-8 border-b pb-4 relative">
        <h1 class="text-3xl font-extrabold text-red-700 text-center">Gestão de Tarefas Escolar</h1>
        <div id="user-info" class="text-center text-sm text-gray-600 mt-2"></div>
        <button onclick="logout()" id="logoutBtn" class="btn-secondary hidden absolute top-0 right-0">Sair</button>
    </header>

    <div id="content-area"></div>

    <footer class="mt-8 pt-4 border-t text-xs text-gray-500 text-center">
        Desenvolvido por Geovane Modena | Versão 4.2
    </footer>
</div>

<!-- Modal para mensagens -->
<div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full shadow-2xl">
        <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-600"></h3>
        <p id="modal-message" class="text-gray-700 mb-4 whitespace-pre-wrap"></p>
        <button onclick="closeModal()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition">OK</button>
    </div>
</div>

<script>
// --- CONFIGURAÇÃO ---
const API_URL = "https://script.google.com/macros/s/AKfycbzKymbA3QgIdhBw7AfUJQveK3l3gbzT-2eccOJpF1K4E-HrEc51pefiJFWCEnDWZm4V/exec";
const API_CONFIG = { token: 'SESI_EDUCATION_2024' };

// --- ESTADO DA APLICAÇÃO ---
let usuarios = window.listaDeUsuarios || []; 
let usuarioLogado = null;
let tarefas = [];
let jsonpCallbackId = 0;

// --- ELEMENTOS DOM ---
const contentArea = document.getElementById('content-area');
const userInfoDisplay = document.getElementById('user-info');
const logoutBtn = document.getElementById('logoutBtn');
const modalOverlay = document.getElementById('modal-overlay');
const modalTitle = document.getElementById('modal-title');
const modalMessage = document.getElementById('modal-message');

// --- FUNÇÕES UTILITÁRIAS ---
const showModal = (title, message) => {
    modalTitle.textContent = title;
    modalMessage.textContent = message;
    modalOverlay.classList.remove('hidden');
    modalOverlay.classList.add('flex');
};

const closeModal = () => modalOverlay.classList.add('hidden');

const renderIcons = () => window.lucide && window.lucide.createIcons();

const formatarData = (dataISO) => {
    if (!dataISO) return 'N/A';
    return new Date(dataISO).toLocaleDateString('pt-BR');
};

// --- API REQUEST COM JSONP (SOLUÇÃO DEFINITIVA) ---
function apiRequestJSONP(url, callback) {
    const callbackName = 'jsonp_callback_' + jsonpCallbackId++;
    
    window[callbackName] = function(data) {
        delete window[callbackName];
        document.body.removeChild(script);
        callback(null, data);
    };
    
    const script = document.createElement('script');
    script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;
    script.onerror = function() {
        delete window[callbackName];
        document.body.removeChild(script);
        callback(new Error('Falha ao carregar o script'));
    };
    
    document.body.appendChild(script);
}

// Função para requisições GET
async function apiGet(func, params = {}) {
    return new Promise((resolve, reject) => {
        let url = `${API_URL}?func=${func}`;
        
        // Adiciona parâmetros extras
        for (const key in params) {
            if (params[key]) {
                url += `&${key}=${encodeURIComponent(params[key])}`;
            }
        }
        
        console.log('Fazendo requisição JSONP para:', url);
        
        apiRequestJSONP(url, (error, data) => {
            if (error) {
                reject(error);
            } else if (data && data.status === 'error') {
                reject(new Error(data.message));
            } else {
                resolve(data);
            }
        });
    });
}

// Função para requisições POST (usando Google Forms como proxy)
async function apiPost(action, dados) {
    return new Promise((resolve, reject) => {
        // Cria um formulário invisível para enviar os dados
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = API_URL;
        form.style.display = 'none';
        
        // Adiciona os dados como campos hidden
        const addField = (name, value) => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            input.value = typeof value === 'object' ? JSON.stringify(value) : value;
            form.appendChild(input);
        };
        
        addField('action', action);
        addField('token', API_CONFIG.token);
        
        // Adiciona outros dados
        for (const key in dados) {
            if (dados[key] !== undefined && dados[key] !== null) {
                addField(key, dados[key]);
            }
        }
        
        document.body.appendChild(form);
        
        // Cria um iframe para receber a resposta
        const iframe = document.createElement('iframe');
        iframe.name = 'post_target_' + Date.now();
        iframe.style.display = 'none';
        
        iframe.onload = function() {
            try {
                // Tenta ler a resposta do iframe
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const responseText = iframeDoc.body.innerText;
                
                if (responseText) {
                    const data = JSON.parse(responseText);
                    if (data.status === 'success') {
                        resolve(data);
                    } else {
                        reject(new Error(data.message || 'Erro desconhecido'));
                    }
                } else {
                    // Assume sucesso se não há resposta (comum em Google Apps Script)
                    resolve({ status: 'success', message: 'Ação realizada com sucesso' });
                }
            } catch (error) {
                // Se não conseguiu ler resposta, assume sucesso
                resolve({ status: 'success', message: 'Ação realizada com sucesso' });
            } finally {
                // Limpa
                setTimeout(() => {
                    document.body.removeChild(form);
                    document.body.removeChild(iframe);
                }, 1000);
            }
        };
        
        iframe.onerror = function() {
            document.body.removeChild(form);
            document.body.removeChild(iframe);
            reject(new Error('Erro ao enviar formulário'));
        };
        
        document.body.appendChild(iframe);
        form.target = iframe.name;
        form.submit();
    });
}

// --- INICIALIZAÇÃO ---
async function init() {
    renderLogin();
}

// --- FUNÇÕES DE AUTENTICAÇÃO ---
const renderLogin = () => {
    contentArea.innerHTML = `
        <div id="login" class="max-w-md mx-auto p-6">
            <h2 class="text-2xl font-bold text-center text-red-700 mb-6">Login</h2>
            <div id="loading-message" class="text-center text-gray-500 mb-4">
                ${usuarios.length > 0 ? "Pronto para o login." : "Erro: users.js não carregado"}
            </div>
            <div id="loginErro" class="text-red-500 mb-4 hidden text-center font-semibold">Usuário ou RA incorretos!</div>

            <form id="login-form" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">E-mail</label>
                    <input type="email" id="email" name="email" required placeholder="seu.email@escola.com" class="mt-1">
                </div>
                <div>
                    <label for="ra" class="block text-sm font-medium text-gray-700">RA (Registro Acadêmico)</label>
                    <input type="text" id="ra" name="ra" required placeholder="Apenas números" class="mt-1">
                </div>
                <button type="submit" class="w-full flex justify-center items-center py-2 px-4 btn-primary">
                    <i data-lucide="log-in" class="mr-2"></i> Entrar
                </button>
            </form>
        </div>
    `;

    document.getElementById('login-form').addEventListener('submit', login);
    renderIcons();
};

async function login(event) {
    event.preventDefault(); 
    const email = document.getElementById('email').value.trim();
    const ra = document.getElementById('ra').value.trim();
    
    const loginErro = document.getElementById('loginErro'); 
    const user = usuarios.find(u => u.Email.toLowerCase() === email.toLowerCase() && String(u.RA) === ra);
    
    if (!user) {
        loginErro.style.display = 'block';
        return;
    }
    
    usuarioLogado = user;
    loginErro.style.display = 'none';
    
    contentArea.innerHTML = `<div class="text-center text-gray-500 py-8">Carregando painel...</div>`;
    logoutBtn.classList.remove('hidden');
    userInfoDisplay.innerHTML = `Logado como: <span class="font-semibold text-red-700">${user.NomeCompleto} (${user.Perfil})</span> | Turma: ${user.Turma || 'N/A'}`;

    if (user.Perfil === "Professor") {
        await mostrarPainelProfessor();
    } else {
        await mostrarPainelAluno(); 
    }
    
    renderIcons(); 
}

function logout() {
    usuarioLogado = null;
    logoutBtn.classList.add('hidden');
    userInfoDisplay.innerHTML = '';
    renderLogin(); 
}

// --- PAINEL DO PROFESSOR ---
async function mostrarPainelProfessor() {
    contentArea.innerHTML = `
        <div id="painelProfessor" class="space-y-6">
            <div class="card p-6 border-t-4 border-red-600">
                <h3 class="text-2xl font-bold mb-4 text-red-700">Criar Nova Tarefa</h3>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Selecione as turmas:</label>
                    <div class="checkbox-group" id="turmasCheckboxes"></div>
                </div>
                <div class="mt-4">
                    <label for="tema" class="block text-sm font-medium text-gray-700">Tema da Tarefa *</label>
                    <input type="text" id="tema" placeholder="Ex: Matemática - Frações" class="mt-1" required>
                </div>
                <div class="mt-4">
                    <label for="dataAula" class="block text-sm font-medium text-gray-700">Data da Aula *</label>
                    <input type="date" id="dataAula" class="mt-1" required>
                </div>
                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <textarea id="parte1" placeholder="Parte 1 (até 18h do dia)" rows="3"></textarea>
                    <textarea id="parte2" placeholder="Parte 2 (3º-7º dia)" rows="3"></textarea>
                    <textarea id="parte3" placeholder="Parte 3 (8º-14º dia)" rows="3"></textarea>
                    <textarea id="parte4" placeholder="Parte 4 (15º-28º dia)" rows="3"></textarea>
                </div>
                <div class="mt-6 flex space-x-4">
                    <button onclick="salvarTarefa()" class="btn-primary flex-1">
                        <i data-lucide="check-circle" class="mr-2"></i> Salvar Tarefa
                    </button>
                    <button onclick="limparFormulario()" class="btn-secondary flex-1">
                        <i data-lucide="x-circle" class="mr-2"></i> Limpar
                    </button>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="text-2xl font-bold mb-4 text-red-700">Tarefas Criadas</h3>
                <div class="overflow-x-auto">
                    <table>
                        <thead>
                            <tr><th>Turma</th><th>Tema</th><th>Data</th><th>Ações</th></tr>
                        </thead>
                        <tbody id="tabelaTarefasBody">
                            <tr><td colspan="4" class="text-center py-4 text-gray-500">Carregando tarefas...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

    // Popula checkboxes de turma
    const turmas = ["1A", "1B", "2A", "2B", "3A", "3B"];
    document.getElementById('turmasCheckboxes').innerHTML = turmas.map(t => `
        <label class="flex items-center">
            <input type="checkbox" value="${t}" class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
            <span class="ml-2 text-gray-700">${t}</span>
        </label>
    `).join("");

    await carregarTarefasProfessor();
    renderIcons();
}

// --- FUNÇÕES DO PROFESSOR ---
async function carregarTarefasProfessor() {
    try {
        const data = await apiGet('getTarefas');
        tarefas = data.data || [];
        renderizarTabelaTarefas();
    } catch (error) {
        console.error('Erro ao carregar tarefas:', error);
        document.getElementById('tabelaTarefasBody').innerHTML = 
            `<tr><td colspan="4" class="text-center py-4 text-red-500">Erro ao carregar tarefas: ${error.message}</td></tr>`;
    }
}

function renderizarTabelaTarefas() {
    const tbody = document.getElementById('tabelaTarefasBody');
    
    if (tarefas.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">Nenhuma tarefa criada</td></tr>`;
        return;
    }

    tbody.innerHTML = tarefas.map(tarefa => `
        <tr>
            <td class="py-3">${tarefa.Turma}</td>
            <td class="py-3">
                <div class="font-semibold">${tarefa.Tema}</div>
                ${tarefa.Parte1 ? `<div class="text-xs text-gray-600 mt-1">Parte 1: ${tarefa.Parte1.substring(0, 50)}...</div>` : ''}
            </td>
            <td class="py-3">${formatarData(tarefa.DataAula)}</td>
            <td class="py-3">
                <button onclick="excluirTarefa('${tarefa.ID}')" class="text-red-600 hover:text-red-800" title="Excluir">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </td>
        </tr>
    `).join('');
    
    renderIcons();
}

async function salvarTarefa() {
    const turmasSelecionadas = Array.from(document.querySelectorAll('#turmasCheckboxes input:checked'))
        .map(c => c.value);
    
    if (turmasSelecionadas.length === 0) {
        showModal('Atenção', 'Selecione pelo menos uma turma.');
        return;
    }

    const tema = document.getElementById('tema').value.trim();
    const dataAula = document.getElementById('dataAula').value;

    if (!tema || !dataAula) {
        showModal('Atenção', 'Preencha o tema e a data da aula.');
        return;
    }

    const dados = {
        Turmas: turmasSelecionadas,
        Tema: tema,
        Parte1: document.getElementById('parte1').value.trim(),
        Parte2: document.getElementById('parte2').value.trim(),
        Parte3: document.getElementById('parte3').value.trim(),
        Parte4: document.getElementById('parte4').value.trim(),
        DataAula: dataAula
    };

    try {
        await apiPost('criarTarefa', dados);
        showModal('Sucesso', 'Tarefa criada com sucesso!');
        limparFormulario();
        await carregarTarefasProfessor();
    } catch (error) {
        showModal('Erro', `Erro ao criar tarefa: ${error.message}`);
    }
}

async function excluirTarefa(idTarefa) {
    if (!confirm("Tem certeza que deseja excluir esta tarefa?")) return;
    
    try {
        await apiPost('excluirTarefa', { ID: idTarefa });
        showModal('Sucesso', 'Tarefa excluída com sucesso.');
        await carregarTarefasProfessor();
    } catch (error) {
        showModal('Erro', `Erro ao excluir tarefa: ${error.message}`);
    }
}

function limparFormulario() {
    document.getElementById('tema').value = '';
    document.getElementById('dataAula').value = '';
    document.getElementById('parte1').value = '';
    document.getElementById('parte2').value = '';
    document.getElementById('parte3').value = '';
    document.getElementById('parte4').value = '';
    document.querySelectorAll('#turmasCheckboxes input:checked').forEach(c => c.checked = false);
}

// --- PAINEL DO ALUNO ---
async function mostrarPainelAluno() {
    contentArea.innerHTML = `
        <div id="painelAluno" class="space-y-6">
            <div class="card p-6">
                <h3 class="text-2xl font-bold text-red-700 mb-4">Minhas Tarefas - Turma ${usuarioLogado.Turma}</h3>
                <div id="tarefas-aluno-container">
                    <div class="text-center text-gray-500 py-8">Carregando tarefas...</div>
                </div>
            </div>
        </div>
    `;

    await carregarTarefasAluno();
}

async function carregarTarefasAluno() {
    try {
        const data = await apiGet('getTarefasPorTurma', { turma: usuarioLogado.Turma });
        const container = document.getElementById('tarefas-aluno-container');
        
        if (!data.data || data.data.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-8">Nenhuma tarefa disponível para sua turma.</div>';
            return;
        }

        container.innerHTML = data.data.map(tarefa => `
            <div class="border border-gray-200 rounded-lg p-4 mb-4">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h4 class="font-semibold text-lg text-gray-800">${tarefa.Tema}</h4>
                        <p class="text-sm text-gray-600 mt-1">Data da aula: ${formatarData(tarefa.DataAula)}</p>
                        ${tarefa.Parte1 ? `<div class="mt-3 p-3 bg-gray-50 rounded border"><strong>Parte 1:</strong> ${tarefa.Parte1}</div>` : ''}
                        ${tarefa.Parte2 ? `<div class="mt-2 p-3 bg-gray-50 rounded border"><strong>Parte 2:</strong> ${tarefa.Parte2}</div>` : ''}
                        ${tarefa.Parte3 ? `<div class="mt-2 p-3 bg-gray-50 rounded border"><strong>Parte 3:</strong> ${tarefa.Parte3}</div>` : ''}
                        ${tarefa.Parte4 ? `<div class="mt-2 p-3 bg-gray-50 rounded border"><strong>Parte 4:</strong> ${tarefa.Parte4}</div>` : ''}
                    </div>
                </div>
            </div>
        `).join('');
        
        renderIcons();
    } catch (error) {
        console.error('Erro ao carregar tarefas:', error);
        document.getElementById('tarefas-aluno-container').innerHTML = 
            `<div class="text-center text-red-500 py-8">Erro ao carregar tarefas: ${error.message}</div>`;
    }
}

// --- INICIALIZAÇÃO ---
init();

// --- FUNÇÕES GLOBAIS ---
window.login = login;
window.logout = logout;
window.mostrarPainelProfessor = mostrarPainelProfessor;
window.salvarTarefa = salvarTarefa;
window.excluirTarefa = excluirTarefa;
window.limparFormulario = limparFormulario;
window.mostrarPainelAluno = mostrarPainelAluno;
window.closeModal = closeModal;
</script>
</body>
</html>
