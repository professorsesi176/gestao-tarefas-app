<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o de Tarefas Escolar</title>
    
    <!-- Otimiza√ß√µes de Performance -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://script.google.com">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        :root {
            --cor-primaria: #CC0000;
            --cor-secundaria: #A00000;
            --cor-sucesso: #10b981;
            --cor-erro: #ef4444;
            --cor-aviso: #f59e0b;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f4f7f9;
            margin: 0;
            padding: 0;
        }
        
        .card { 
            background-color: white; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.2); 
        }
        
        .btn-primario { 
            background-color: var(--cor-primaria); 
            color: white; 
            padding: 10px 20px; 
            border-radius: 8px; 
            font-weight: 600; 
            transition: all 0.2s; 
            cursor: pointer; 
            font-size: 14px;
            border: none;
        }
        
        .btn-primario:hover { 
            background-color: var(--cor-secundaria); 
            transform: translateY(-1px);
        }
        
        .btn-secundario { 
            background-color: #d1d5db; 
            color: #1e1e1e; 
            padding: 8px 16px; 
            border-radius: 8px; 
            font-weight: 600; 
            transition: background-color 0.2s; 
            cursor: pointer; 
            border: none;
        }
        
        .btn-secundario:hover { 
            background-color: #9ca3af; 
        }
        
        input, textarea, select {
            border: 1px solid #d1d5db; 
            padding: 12px; 
            border-radius: 8px; 
            width: 100%; 
            transition: border-color 0.2s; 
            margin-top: 4px; 
            margin-bottom: 8px;
            font-family: inherit;
        }
        
        input:focus, textarea:focus, select:focus { 
            border-color: var(--cor-primaria); 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(204, 0, 0, 0.1);
        }
        
        .hidden { 
            display: none; 
        }
        
        .loading-skeleton {
            background: linear-gradient(90deg, #f9fafb 25%, #f3f4f6 50%, #f9fafb 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 6px;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .spinner {
            border: 2px solid #f3f3f3;
            border-radius: 50%;
            border-top: 2px solid var(--cor-primaria);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Componentes Reutiliz√°veis */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }
        
        .table-responsive {
            overflow-x: auto;
        }
        
        .compact-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .compact-table th, 
        .compact-table td {
            padding: 12px 8px;
            border: 1px solid #e5e7eb;
        }
        
        .compact-table th {
            background-color: var(--cor-primaria);
            color: white;
            font-weight: 600;
        }
        
        .compact-table tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        
        /* Utilit√°rios de Layout */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .space-x-2 > * + * { margin-left: 0.5rem; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        
        /* Componentes Espec√≠ficos */
        .contador {
            display: inline-block;
            padding: 4px 8px;
            background-color: #f3f4f6;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 8px;
            min-width: 80px;
            text-align: center;
        }
        
        .contador.disponivel {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .contador.expirado {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .contador.aguardando {
            background-color: #e5e7eb;
            color: #374151;
        }
        
        .turma-column {
            width: 80px;
            text-align: center;
        }
        
        .data-column {
            width: 120px;
            text-align: center;
        }
        
        .acoes-column {
            width: 200px;
            text-align: center;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        /* Cards de Diagn√≥stico */
        .diagnostico-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .diagnostico-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            background-color: white;
        }
        
        .test-result {
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .test-success {
            background-color: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }
        
        .test-error {
            background-color: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }
        
        .test-warning {
            background-color: #fef3c7;
            border: 1px solid #fde68a;
            color: #92400e;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .diagnostico-grid {
                grid-template-columns: 1fr;
            }
            
            .compact-table {
                font-size: 0.875rem;
            }
            
            .acoes-column {
                width: 150px;
            }
        }

        /* Estilos espec√≠ficos para login */
        .email-container {
            display: flex;
            width: 100%;
        }
        
        .email-prefix {
            flex: 1;
        }
        
        .email-suffix {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            border-left: none;
            border-radius: 0 8px 8px 0;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            color: #6b7280;
            font-weight: 500;
        }
        
        .email-prefix input {
            border-radius: 8px 0 0 8px !important;
            border-right: none;
        }
        
        .password-container {
            position: relative;
            width: 100%;
        }
        
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #6b7280;
            z-index: 10;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        
        .password-toggle:hover {
            color: #374151;
        }
        
        .password-toggle:focus {
            outline: none;
        }
        
        .password-container input {
            padding-right: 40px;
        }

        /* Estilos para tarefas e formul√°rios */
        .checkbox-group {
            display: flex;
            flex-wrap: nowrap;
            gap: 0;
            margin-top: 10px;
            padding: 2px;
            background-color: #f9f9f9;
            border-radius: 8px;
            overflow-x: hidden;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 1px;
            white-space: nowrap;
            margin-right: 4px;
        }
        
        .checkbox-item:last-child {
            margin-right: 0;
        }
        
        .checkbox-item input[type="checkbox"] {
            margin: 0;
            transform: scale(0.8);
        }
        
        .checkbox-item label {
            margin-bottom: 0;
            font-size: 0.75rem;
            white-space: nowrap;
            padding-right: 4px;
        }
        
        .turma-checkbox {
            width: 14px;
            height: 14px;
            accent-color: #CC0000;
            cursor: pointer;
            margin: 0;
        }
        
        .form-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .form-row label {
            margin-bottom: 0;
            min-width: 120px;
        }
        
        .form-row input, .form-row textarea {
            flex: 1;
            margin-top: 0;
        }
        
        .link-container {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            align-items: center;
        }
        
        .link-input {
            flex: 1;
            padding: 8px;
            font-size: 0.875rem;
        }
        
        .btn-link {
            padding: 8px 12px;
            font-size: 0.8rem;
        }
        
        .btn-link:disabled {
            background-color: #9ca3af !important;
            color: #6b7280 !important;
            cursor: not-allowed !important;
            opacity: 0.6;
        }
        
        .link-salvo {
            background-color: #f3f4f6 !important;
            color: #6b7280 !important;
            cursor: not-allowed !important;
            border: 1px solid #d1d5db;
        }
        
        .conteudo-formatado {
            white-space: pre-line;
            line-height: 1.6;
            margin-top: 8px;
        }
        
        .instrucoes-box {
            background-color: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .fundamento-cientifico {
            background-color: #fefce8;
            border: 1px solid #fef08a;
            border-radius: 8px;
            padding: 12px;
            margin-top: 20px;
            cursor: pointer;
        }
        
        .fundamento-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #92400e;
        }
        
        .fundamento-content {
            margin-top: 12px;
            display: none;
        }
        
        .fundamento-content.expandido {
            display: block;
        }
        
        .expand-icon {
            transition: transform 0.2s;
        }
        
        .expand-icon.expandido {
            transform: rotate(180deg);
        }
        
        .retencao-aviso {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .retencao-50 {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .retencao-25 {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .retencao-15 {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .retencao-10 {
            background-color: #e0e7ff;
            color: #3730a3;
        }
        
        .horario-info {
            font-size: 0.75rem;
            margin-top: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            text-align: center;
        }
        
        .horario-maxima {
            background-color: #d1fae5;
            color: #065f46;
            font-weight: 600;
        }
        
        .horario-fora {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .conteudo-bloqueado {
            color: #6b7280;
            font-style: italic;
            padding: 8px;
            background-color: #f9fafb;
            border-radius: 4px;
            margin-top: 8px;
        }
        
        .btn-editar {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .btn-editar:hover {
            background-color: #2563eb;
        }
        
        .btn-excluir {
            background-color: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .btn-excluir:hover {
            background-color: #dc2626;
        }
        
        .btn-exportar {
            background-color: #059669;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
            margin-left: 10px;
        }
        
        .btn-exportar:hover {
            background-color: #047857;
        }
        
        .turmas-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .turmas-buttons {
            display: flex;
            gap: 0;
            flex-wrap: wrap;
        }
        
        .btn-turma-compact {
            background-color: #CC0000;
            color: white;
            padding: 8px 12px;
            border-radius: 0;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
            min-width: 40px;
            text-align: center;
            border-right: 1px solid white;
        }
        
        .btn-turma-compact:first-child {
            border-radius: 6px 0 0 6px;
        }
        
        .btn-turma-compact:last-child {
            border-radius: 0 6px 6px 0;
            border-right: none;
        }
        
        .btn-turma-compact:hover {
            background-color: #A00000;
        }
        
        .btn-turma-compact.active {
            background-color: #A00000;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #CC0000;
        }
        
        .export-buttons-container {
            display: flex;
            gap: 10px;
        }
        
        .numero-coluna {
            width: 50px;
            text-align: center;
        }
        
        .media-coluna {
            width: 100px;
            text-align: center;
            font-weight: bold;
        }
        
        .parte-column {
            width: 60px;
            text-align: center;
            font-size: 0.75rem;
        }
        
        .media-tarefa-column {
            width: 70px;
            text-align: center;
            font-weight: bold;
        }
        
        .header-tarefa {
            background-color: #CC0000;
            color: white;
            text-align: center;
            font-weight: bold;
        }
        
        .subheader-tarefa {
            background-color: #e53e3e;
            color: white;
            text-align: center;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .tarefa-group {
            border-right: 2px solid #c53030;
        }
        
        .tarefa-group:last-child {
            border-right: none;
        }
        
        .btn-formatacao {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .btn-formatacao:hover {
            background-color: #e5e7eb;
        }
        
        .btn-loading {
            position: relative;
            color: transparent;
        }
        
        .btn-loading::after {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }
        
        .tarefa-atualizada {
            animation: highlight 2s ease;
        }
        
        @keyframes highlight {
            0% { background-color: #d1fae5; }
            100% { background-color: transparent; }
        }

        /* Informa√ß√µes do sistema */
        .system-info {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .system-good {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .system-warning {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .system-info-blue {
            background-color: #dbeafe;
            color: #1e40af;
        }

        /* Novos estilos para a vers√£o 10.0 */
        .aluno-relatorio-card {
            background-color: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .aluno-relatorio-card:hover {
            border-color: #CC0000;
            background-color: #fef2f2;
        }
        
        .aluno-relatorio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .aluno-relatorio-content {
            margin-top: 12px;
            display: none;
        }
        
        .aluno-relatorio-content.expandido {
            display: block;
        }
        
        .tarefa-expand-button {
            background: none;
            border: none;
            color: #CC0000;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 4px 8px;
        }
        
        .tarefa-expand-content {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #f9fafb;
            border-radius: 6px;
        }
        
        .tarefa-expand-content.expandido {
            display: block;
        }
        
        /* Para melhorar a responsividade em telas menores */
        @media (max-width: 640px) {
            .checkbox-group {
                gap: 0;
            }
            
            .checkbox-item {
                margin-right: 3px;
            }
            
            .checkbox-item label {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 sm:p-8">
    <div id="app-container" class="w-full max-w-6xl bg-white shadow-xl rounded-2xl p-6 sm:p-8 transition-all duration-300">
        <header class="mb-8 border-b pb-4">
            <div class="header-content">
                <h1 class="text-3xl font-extrabold text-red-700 text-center">Sistema de Gest√£o de Tarefas</h1>
                <div id="user-info" class="user-info-container text-center mt-2 text-gray-600"></div>
                <div class="absolute top-0 right-0 flex space-x-2">
                    <button id="diagnosticoBtn" class="btn-primario hidden">Diagn√≥stico</button>
                    <button id="relatorioBtn" class="btn-primario hidden" style="background-color: #10b981;">Relat√≥rio</button>
                    <button onclick="logout()" id="logoutBtn" class="btn-secundario hidden">Sair</button>
                </div>
            </div>
        </header>

        <div id="content-area"></div>

        <footer class="mt-8 pt-4 border-t text-xs text-gray-500 text-center">
            Desenvolvido por Geovane Modena | Vers√£o 10.0
        </footer>
    </div>

    <!-- Modal para mensagens -->
    <div id="modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-600"></h3>
            <p id="modal-message" class="text-gray-700 mb-4 whitespace-pre-wrap"></p>
            <button onclick="closeModal()" class="btn-primario w-full">OK</button>
        </div>
    </div>

    <!-- Modal de confirma√ß√£o -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-3 text-red-600">Confirmar Exclus√£o</h3>
            <p id="confirm-message" class="text-gray-700 mb-4"></p>
            <div class="flex space-x-4">
                <button id="confirm-cancel" class="btn-secundario flex-1">Cancelar</button>
                <button id="confirm-delete" class="btn-primario flex-1">Excluir</button>
            </div>
        </div>
    </div>

    <script>
    // ==================== CONFIGURA√á√ÉO E CONSTANTES ====================
    const CONFIG = {
        API_URL: "https://script.google.com/macros/s/AKfycbzKymbA3QgIdhBw7AfUJQveK3l3gbzT-2eccOJpF1K4E-HrEc51pefiJFWCEnDWZm4V/exec",
        CACHE_TTL: 5 * 60 * 1000, // 5 minutos
        MAX_TEMA_LEN: 200,
        MAX_PARTE_LEN: 4000,
        TURMAS: ["1A", "1B", "2A", "2B", "3A", "3B"],
        RATE_LIMIT_INFO: {
            login: "5 tentativas por minuto",
            criar_tarefa: "3 tarefas por minuto", 
            entregas: "10 entregas por minuto",
            relatorios: "5 relat√≥rios por minuto",
            geral: "30 requisi√ß√µes por minuto"
        }
    };

    // ==================== ESTADO GLOBAL ====================
    const STATE = {
        usuarios: [],
        usuarioLogado: null,
        tarefas: [],
        tarefaEditando: null,
        tarefaParaExcluir: null,
        contadoresAtivos: [],
        jsonpCallbackId: 0,
        rmVisible: false,
        relatorioAlunoVisivel: false,
        performanceMetrics: {
            apiCalls: 0,
            cacheHits: 0,
            cacheMisses: 0,
            startTime: performance.now()
        }
    };

    // ==================== SISTEMA DE CACHE ====================
    const CacheManager = {
        get: (key) => {
            try {
                const item = localStorage.getItem(`task_${key}`);
                if (item) {
                    const { data, expiry } = JSON.parse(item);
                    if (Date.now() > expiry) {
                        localStorage.removeItem(`task_${key}`);
                        STATE.performanceMetrics.cacheMisses++;
                        return null;
                    }
                    STATE.performanceMetrics.cacheHits++;
                    return data;
                }
            } catch (e) {
                console.warn('Erro ao acessar cache:', e);
            }
            STATE.performanceMetrics.cacheMisses++;
            return null;
        },
        
        set: (key, data, ttl = CONFIG.CACHE_TTL) => {
            try {
                const item = {
                    data,
                    expiry: Date.now() + ttl
                };
                localStorage.setItem(`task_${key}`, JSON.stringify(item));
                return true;
            } catch (e) {
                console.warn('Erro ao salvar no cache:', e);
                return false;
            }
        },
        
        remove: (key) => {
            try {
                localStorage.removeItem(key.startsWith('task_') ? key : `task_${key}`);
            } catch (e) {
                console.warn('Erro ao remover do cache:', e);
            }
        },
        
        clear: () => {
            try {
                const keys = Object.keys(localStorage).filter(k => k.startsWith('task_'));
                keys.forEach(k => localStorage.removeItem(k));
            } catch (e) {
                console.warn('Erro ao limpar cache:', e);
            }
        },
        
        getStats: () => {
            let count = 0;
            let size = 0;
            
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('task_')) {
                        count++;
                        size += localStorage.getItem(key).length;
                    }
                }
            } catch (e) {
                console.warn('Erro ao calcular estat√≠sticas do cache:', e);
            }
            
            return {
                count,
                size: (size / 1024).toFixed(2) + ' KB',
                efficiency: STATE.performanceMetrics.cacheHits + STATE.performanceMetrics.cacheMisses > 0 
                    ? ((STATE.performanceMetrics.cacheHits / (STATE.performanceMetrics.cacheHits + STATE.performanceMetrics.cacheMisses)) * 100).toFixed(1) + '%'
                    : '0%'
            };
        }
    };

    // ==================== UTILIT√ÅRIOS ====================
    const Utils = {
        debounce: (func, wait, immediate = false) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    timeout = null;
                    if (!immediate) func(...args);
                };
                const callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                if (callNow) func(...args);
            };
        },

        formatarData: (dataISO) => {
            if (!dataISO) return 'N/A';
            const data = new Date(dataISO);
            return isNaN(data.getTime()) ? 'N/A' : data.toLocaleDateString('pt-BR');
        },

        escapeHTML: (texto) => {
            if (!texto) return '';
            return String(texto)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        },

        sanitizeForSheet: (str) => {
            if (!str) return '';
            const s = String(str);
            const trimmed = s.trimStart();
            return /^[=+\-@]/.test(trimmed) ? "'" + s : s;
        },

        setButtonLoading: (button, isLoading) => {
            if (!button) return;
            if (isLoading) {
                button.disabled = true;
                button.classList.add('btn-loading');
            } else {
                button.disabled = false;
                button.classList.remove('btn-loading');
            }
        },

        formatarConteudoParaExibicao: (texto) => {
            if (!texto) return '';
            const textoStr = String(texto);
            return textoStr
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
    };

    // ==================== SISTEMA DE PERFORMANCE ====================
    const PerformanceMonitor = {
        metrics: {
            pageLoad: 0,
            apiCalls: 0,
            cacheHits: 0,
            cacheMisses: 0,
            startTime: performance.now()
        },

        recordApiCall: (duration) => {
            PerformanceMonitor.metrics.apiCalls++;
            console.log(`API Call: ${duration}ms`);
        },

        getMetrics: () => {
            const cacheStats = CacheManager.getStats();
            const memory = performance.memory ? {
                used: (performance.memory.usedJSHeapSize / 1048576).toFixed(2) + ' MB',
                total: (performance.memory.totalJSHeapSize / 1048576).toFixed(2) + ' MB'
            } : null;

            return {
                ...PerformanceMonitor.metrics,
                cache: cacheStats,
                memory: memory,
                totalTime: (performance.now() - PerformanceMonitor.metrics.startTime).toFixed(2) + 'ms'
            };
        },

        testApiPerformance: () => {
            return new Promise((resolve) => {
                const start = performance.now();
                
                apiGet('getUsers', {}, true)
                    .then(() => {
                        const tempo = performance.now() - start;
                        resolve({
                            tempo: tempo.toFixed(2) + 'ms',
                            status: tempo < 1000 ? '√ìtimo' : tempo < 3000 ? 'Bom' : 'Lento'
                        });
                    })
                    .catch(() => {
                        resolve({
                            tempo: 'Falha',
                            status: 'Erro'
                        });
                    });
            });
        }
    };

    // ==================== GERENCIADOR DE API ====================
    const ApiManager = {
        jsonpCallbackId: 0,

        requestJSONP: (url, callback) => {
            const callbackName = 'jsonp_callback_' + ApiManager.jsonpCallbackId++;
            
            const timeout = setTimeout(() => {
                if (window[callbackName]) {
                    delete window[callbackName];
                    callback(new Error('Timeout: A requisi√ß√£o demorou muito para responder'));
                }
            }, 15000);
            
            window[callbackName] = function(data) {
                clearTimeout(timeout);
                delete window[callbackName];
                if (script.parentNode) {
                    document.body.removeChild(script);
                }
                callback(null, data);
            };
            
            const script = document.createElement('script');
            script.src = url + (url.indexOf('?') >= 0 ? '&' : '?') + 'callback=' + callbackName;
            script.onerror = function() {
                clearTimeout(timeout);
                delete window[callbackName];
                if (script.parentNode) {
                    document.body.removeChild(script);
                }
                callback(new Error('Falha ao carregar o script. Verifique sua conex√£o.'));
            };
            
            document.body.appendChild(script);
        },

        get: async (func, params = {}, forceRefresh = false) => {
            const cacheKey = `api_${func}_${JSON.stringify(params)}`;
            
            if (!forceRefresh) {
                const cached = CacheManager.get(cacheKey);
                if (cached) {
                    return cached;
                }
            }
            
            return new Promise((resolve, reject) => {
                const startTime = performance.now();
                let url = `${CONFIG.API_URL}?`;
                
                if (func) {
                    url += `func=${func}`;
                }
                
                for (const key in params) {
                    if (params[key] !== undefined && params[key] !== null) {
                        url += `&${key}=${encodeURIComponent(params[key])}`;
                    }
                }
                
                if (forceRefresh) {
                    url += `&_=${Date.now()}`;
                }
                
                console.log('Fazendo requisi√ß√£o para:', url.replace(/(rm|senha)=[^&]*/g, '$1=***'));
                
                ApiManager.requestJSONP(url, (error, data) => {
                    const duration = performance.now() - startTime;
                    PerformanceMonitor.recordApiCall(duration);
                    
                    if (error) {
                        reject(error);
                    } else if (data && data.success === false) {
                        reject(new Error(data.error));
                    } else {
                        CacheManager.set(cacheKey, data, 2 * 60 * 1000);
                        resolve(data);
                    }
                });
            });
        },

        post: async (action, dados) => {
            return new Promise((resolve, reject) => {
                const startTime = performance.now();
                let url = `${CONFIG.API_URL}?action=${action}`;
                
                for (const key in dados) {
                    if (dados[key] !== undefined && dados[key] !== null) {
                        if (Array.isArray(dados[key])) {
                            url += `&${key}=${encodeURIComponent(JSON.stringify(dados[key]))}`;
                        } else {
                            url += `&${key}=${encodeURIComponent(dados[key])}`;
                        }
                    }
                }
                
                console.log('Fazendo POST para:', url.replace(/(rm|senha)=[^&]*/g, '$1=***'));
                
                ApiManager.requestJSONP(url, (error, data) => {
                    const duration = performance.now() - startTime;
                    PerformanceMonitor.recordApiCall(duration);
                    
                    if (error) {
                        reject(error);
                    } else if (data && data.success === false) {
                        reject(new Error(data.error));
                    } else {
                        resolve(data);
                    }
                });
            });
        }
    };

    // Aliases para compatibilidade
    const apiGet = ApiManager.get;
    const apiPost = ApiManager.post;

    // ==================== GERENCIADOR DE INTERFACE ====================
    const UIManager = {
        elements: {
            contentArea: document.getElementById('content-area'),
            userInfo: document.getElementById('user-info'),
            logoutBtn: document.getElementById('logoutBtn'),
            relatorioBtn: document.getElementById('relatorioBtn'),
            diagnosticoBtn: document.getElementById('diagnosticoBtn'),
            modalOverlay: document.getElementById('modal-overlay'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmMessage: document.getElementById('confirm-message'),
            confirmCancel: document.getElementById('confirm-cancel'),
            confirmDelete: document.getElementById('confirm-delete')
        },

        showModal: (title, message) => {
            UIManager.elements.modalTitle.textContent = title;
            UIManager.elements.modalMessage.textContent = message;
            UIManager.elements.modalOverlay.classList.remove('hidden');
        },

        closeModal: () => {
            UIManager.elements.modalOverlay.classList.add('hidden');
        },

        showConfirmModal: (message, onConfirm) => {
            UIManager.elements.confirmMessage.textContent = message;
            UIManager.elements.confirmModal.classList.remove('hidden');
            
            UIManager.elements.confirmCancel.onclick = () => {
                UIManager.elements.confirmModal.classList.add('hidden');
                STATE.tarefaParaExcluir = null;
            };
            
            UIManager.elements.confirmDelete.onclick = () => {
                UIManager.elements.confirmModal.classList.add('hidden');
                if (onConfirm) onConfirm();
                STATE.tarefaParaExcluir = null;
            };
        },

        renderLoading: (message = 'Carregando...') => {
            return `
                <div class="text-center py-8">
                    <div class="spinner"></div>
                    <p class="mt-4 text-gray-600">${message}</p>
                </div>
            `;
        },

        renderError: (message) => {
            return `
                <div class="text-center py-8">
                    <p class="text-red-500 mb-4">${Utils.escapeHTML(message)}</p>
                    <button onclick="location.reload()" class="btn-primario">Tentar Novamente</button>
                </div>
            `;
        }
    };

    // ==================== SISTEMA DE AUTENTICA√á√ÉO ====================
    const AuthManager = {
        async login(credenciais) {
            const { email, senha } = credenciais;
            
            console.log('Tentando login com:', { email, senha: '***' });

            // Se n√£o temos usu√°rios, tentar recarregar
            if (STATE.usuarios.length === 0) {
                try {
                    console.log('Recarregando lista de usu√°rios...');
                    const response = await apiGet('getUsers', {}, true);
                    STATE.usuarios = response.data || response;
                    console.log('Usu√°rios recarregados:', STATE.usuarios.length);
                } catch (error) {
                    console.error('Erro ao recarregar usu√°rios:', error);
                    throw new Error('Erro ao carregar lista de usu√°rios. Tente novamente.');
                }
            }

            // Verificar se o e-mail existe
            const userByEmail = STATE.usuarios.find(u => {
                const userEmail = String(u.Email || '').toLowerCase().trim();
                const inputEmail = email.toLowerCase().trim();
                return userEmail === inputEmail;
            });

            if (!userByEmail) {
                console.log('E-mail n√£o encontrado:', email);
                throw new Error('E-mail n√£o encontrado!');
            }

            // Verificar se o RM corresponde
            const user = STATE.usuarios.find(u => {
                const userEmail = String(u.Email || '').toLowerCase().trim();
                const userRM = String(u.RM || '').trim();
                const inputEmail = email.toLowerCase().trim();
                const inputRM = senha.trim();
                
                return userEmail === inputEmail && userRM === inputRM;
            });
            
            if (!user) {
                console.log('Senha incorreta para:', email);
                throw new Error('Senha incorreta para este e-mail!');
            }
            
            console.log('Usu√°rio logado com sucesso:', user.NomeCompleto);
            return user;
        },

        logout() {
            STATE.usuarioLogado = null;
            STATE.tarefaEditando = null;
            STATE.relatorioAlunoVisivel = false;
            UIManager.elements.logoutBtn.classList.add('hidden');
            UIManager.elements.relatorioBtn.classList.add('hidden');
            UIManager.elements.diagnosticoBtn.classList.add('hidden');
            UIManager.elements.userInfo.innerHTML = '';
            STATE.contadoresAtivos.forEach(interval => clearInterval(interval));
            STATE.contadoresAtivos = [];
            CacheManager.clear();
            renderLogin();
        },

        updateUserInfo() {
            if (!STATE.usuarioLogado) return;
            
            const user = STATE.usuarioLogado;
            if (user.Perfil === "Professor") {
                UIManager.elements.userInfo.innerHTML = `
                    <div class="user-info-text">
                        Logado como: <span class="font-semibold text-red-700">${Utils.escapeHTML(user.NomeCompleto)} (${user.Perfil})</span>
                    </div>
                `;
                UIManager.elements.relatorioBtn.onclick = mostrarRelatorioProfessor;
                UIManager.elements.relatorioBtn.classList.remove('hidden');
                UIManager.elements.diagnosticoBtn.classList.remove('hidden');
                UIManager.elements.diagnosticoBtn.onclick = mostrarPainelDiagnostico;
            } else {
                UIManager.elements.userInfo.innerHTML = `
                    <div class="user-info-text">
                        Logado como: <span class="font-semibold text-red-700">${Utils.escapeHTML(user.NomeCompleto)} (${user.Perfil})</span> | 
                        Turma: ${Utils.escapeHTML(user.Turma || 'N/A')} | 
                        N¬∫: ${Utils.escapeHTML(user.Numero || 'N/A')}
                    </div>
                `;
                UIManager.elements.relatorioBtn.classList.add('hidden');
                UIManager.elements.diagnosticoBtn.classList.add('hidden');
            }
            
            UIManager.elements.logoutBtn.classList.remove('hidden');
        }
    };

    // ==================== SISTEMA DE TEMPO E PRAZOS ====================
    const TimeManager = {
        calcularStatusParteDiaUnico(dataAula, diasOffset) {
            const agora = new Date();
            const base = new Date(dataAula);

            if (isNaN(base.getTime())) {
                return {
                    texto: 'Data inv√°lida',
                    classe: 'aguardando',
                    liberada: false,
                    expirado: false,
                    dentroHorarioEntrega: false
                };
            }

            base.setHours(0, 0, 0, 0);
            const diaEntrega = new Date(base);
            diaEntrega.setDate(diaEntrega.getDate() + diasOffset);

            const inicio = new Date(diaEntrega);
            inicio.setHours(13, 0, 0, 0);

            const fim = new Date(diaEntrega);
            fim.setHours(22, 0, 0, 0);

            if (agora < inicio) {
                const diff = inicio - agora;
                const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
                const horas = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutos = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                let texto = '';
                if (dias > 0) texto = `Libera em ${dias}d ${horas}h`;
                else if (horas > 0) texto = `Libera em ${horas}h ${minutos}m`;
                else texto = `Libera em ${minutos}m`;

                return {
                    texto,
                    classe: 'aguardando',
                    liberada: false,
                    expirado: false,
                    dentroHorarioEntrega: false
                };
            }

            if (agora > fim) {
                return {
                    texto: 'Expirado',
                    classe: 'expirado',
                    liberada: false,
                    expirado: true,
                    dentroHorarioEntrega: false
                };
            }

            // Dentro do √∫nico dia de entrega (13h‚Äì22h)
            const diffFim = fim - agora;
            const horasFim = Math.floor(diffFim / (1000 * 60 * 60));
            const minutosFim = Math.floor((diffFim % (1000 * 60 * 60)) / (1000 * 60));
            let texto = '';
            if (horasFim > 0) texto = `Termina em ${horasFim}h ${minutosFim}m`;
            else texto = `Termina em ${minutosFim}m`;

            return {
                texto,
                classe: 'disponivel',
                liberada: true,
                expirado: false,
                dentroHorarioEntrega: true
            };
        },

        calcularContadoresOtimizado(dataAula) {
            return {
                parte1: TimeManager.calcularStatusParteDiaUnico(dataAula, 0),
                parte2: TimeManager.calcularStatusParteDiaUnico(dataAula, 7),
                parte3: TimeManager.calcularStatusParteDiaUnico(dataAula, 14),
                parte4: TimeManager.calcularStatusParteDiaUnico(dataAula, 28)
            };
        },

        iniciarAtualizacaoContadores() {
            STATE.contadoresAtivos.forEach(interval => clearInterval(interval));
            STATE.contadoresAtivos = [];
            
            const interval = setInterval(() => {
                if (STATE.usuarioLogado && STATE.usuarioLogado.Perfil === 'Aluno') {
                    atualizarContadoresAluno();
                }
            }, 1000);
            
            STATE.contadoresAtivos.push(interval);
        }
    };

    // ==================== COMPONENTES DE INTERFACE ====================
    const Components = {
        loginForm: () => {
            return `
                <div id="login" class="max-w-md mx-auto p-6">
                    <h2 class="text-2xl font-bold text-center text-red-700 mb-6">Login</h2>
                    <div id="loginErro" class="text-red-500 mb-4 hidden text-center font-semibold"></div>

                    <form id="login-form" class="space-y-4">
                        <div class="form-group">
                            <label for="email" class="form-label">E-mail</label>
                            <div class="email-container">
                                <div class="email-prefix">
                                    <input type="text" id="email" name="email" required placeholder="nome.sobrenome" 
                                           class="w-full p-3 border rounded-lg rounded-r-none">
                                </div>
                                <div class="email-suffix">
                                    @portalsesisp.org.br
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="senha" class="form-label">Senha</label>
                            <div class="password-container">
                                <input type="password" id="senha" name="senha" required placeholder="" 
                                       class="w-full p-3 border rounded-lg pr-10">
                                <button type="button" class="password-toggle" id="toggleSenha">
                                    ${STATE.rmVisible ? 'üôà' : 'üëÅÔ∏è'}
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="btn-primario w-full py-3" id="login-button">
                            <span id="login-text">Entrar</span>
                        </button>
                    </form>
                </div>
            `;
        },

        metricasPerformance: () => {
            return `
                <div class="diagnostico-card">
                    <h4 class="font-semibold mb-3">M√©tricas de Performance</h4>
                    <button onclick="mostrarMetricasPerformance()" class="btn-primario w-full mb-3">Coletar M√©tricas</button>
                    <div id="metricas-performance">
                        <p class="text-gray-500 text-center text-sm">Clique para coletar m√©tricas</p>
                    </div>
                </div>
            `;
        }
    };

    // ==================== FUN√á√ïES PRINCIPAIS ====================

    // Fun√ß√£o de inicializa√ß√£o
    async function init() {
        try {
            console.log('Inicializando sistema v10.0...');
            const response = await apiGet('getUsers', {}, true);
            STATE.usuarios = response.data || response;
            console.log('Usu√°rios carregados:', STATE.usuarios.length);
        } catch (error) {
            console.error('Erro ao carregar usu√°rios:', error);
            STATE.usuarios = [];
            UIManager.showModal('Aviso', 'N√£o foi poss√≠vel carregar a lista de usu√°rios. Verifique sua conex√£o.');
        }
        
        renderLogin();
    }

    // Renderizar tela de login
    function renderLogin() {
        UIManager.elements.contentArea.innerHTML = Components.loginForm();

        // Configurar evento de toggle de senha
        document.getElementById('toggleSenha').addEventListener('click', toggleRmVisibility);

        // Configurar evento de submit do formul√°rio
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await handleLogin(e);
        });
    }

    // Toggle visibilidade da senha - CORRIGIDO
    function toggleRmVisibility() {
        const senhaInput = document.getElementById('senha');
        const toggleButton = document.getElementById('toggleSenha');
        
        STATE.rmVisible = !STATE.rmVisible;
        senhaInput.type = STATE.rmVisible ? 'text' : 'password';
        // CORRE√á√ÉO: Invertemos a l√≥gica dos emojis
        toggleButton.textContent = STATE.rmVisible ? 'üôà' : 'üëÅÔ∏è';
    }

    // Manipular login
    async function handleLogin(event) {
        event.preventDefault();
        const emailPrefix = document.getElementById('email').value.trim();
        const senha = document.getElementById('senha').value.trim();
        const email = `${emailPrefix}@portalsesisp.org.br`;
        
        const loginErro = document.getElementById('loginErro');
        const loginButton = document.getElementById('login-button');
        const loginText = document.getElementById('login-text');
        
        Utils.setButtonLoading(loginButton, true);
        loginText.textContent = "Entrando...";
        
        try {
            const user = await AuthManager.login({ email, senha });
            STATE.usuarioLogado = user;
            loginErro.style.display = 'none';
            
            UIManager.elements.contentArea.innerHTML = UIManager.renderLoading('Carregando painel...');
            
            // Carregar tarefas
            try {
                const response = await apiGet('getTarefas', {}, true);
                STATE.tarefas = response.data || response;
                console.log('Tarefas carregadas:', STATE.tarefas.length);
            } catch (error) {
                console.error('Erro ao carregar tarefas:', error);
                STATE.tarefas = [];
                UIManager.showModal('Aviso', 'Algumas funcionalidades podem estar limitadas devido a problemas de conex√£o.');
            }

            AuthManager.updateUserInfo();

            // Redirecionar para o painel apropriado
            if (user.Perfil === "Professor") {
                await mostrarPainelProfessor();
            } else {
                await mostrarPainelAluno();
            }
            
        } catch (error) {
            loginErro.textContent = error.message;
            loginErro.style.display = 'block';
            console.error('Erro no login:', error);
        } finally {
            Utils.setButtonLoading(loginButton, false);
            loginText.textContent = "Entrar";
        }
    }

    // ==================== PAINEL DO PROFESSOR ====================
    async function mostrarPainelProfessor() {
        const cacheKey = 'painel_professor';
        const cached = CacheManager.get(cacheKey);
        
        if (cached && !STATE.tarefaEditando) {
            UIManager.elements.contentArea.innerHTML = cached;
            await carregarTarefasProfessor();
            return;
        }
        
        UIManager.elements.contentArea.innerHTML = `
            <div id="painelProfessor" class="space-y-6">
                <div class="card p-6 border-t-4 border-red-600">
                    <h3 class="text-2xl font-bold mb-4 text-red-700" id="titulo-formulario">${STATE.tarefaEditando ? 'Editar Tarefa' : 'Criar Nova Tarefa'}</h3>
                    
                    <div class="form-row">
                        <label class="block text-sm font-medium text-gray-700">Turmas:</label>
                        <div class="checkbox-group" id="turmasCheckboxes"></div>
                    </div>
                    
                    <div class="form-row">
                        <label for="tema" class="block text-sm font-medium text-gray-700">Tema da Tarefa</label>
                        <input type="text" id="tema" placeholder="Ex: Matem√°tica - Fra√ß√µes" class="mt-1" required maxlength="${CONFIG.MAX_TEMA_LEN}">
                    </div>
                    
                    <div class="form-row">
                        <label for="dataAula" class="block text-sm font-medium text-gray-700">Data da Aula</label>
                        <input type="date" id="dataAula" class="mt-1" required>
                    </div>
                    
                    <div class="mt-4 space-y-4">
                        <div>
                            <label for="parte1" class="block text-sm font-medium text-gray-700 mb-2">Parte 1 (dia da aula, 13h‚Äì22h) <span class="retencao-aviso retencao-50">50% reten√ß√£o</span></label>
                            <textarea id="parte1" placeholder="Descreva a parte 1 da tarefa. Use Enter para criar par√°grafos." rows="4" required maxlength="${CONFIG.MAX_PARTE_LEN}"></textarea>
                        </div>
                        <div>
                            <label for="parte2" class="block text-sm font-medium text-gray-700 mb-2">Parte 2 (7¬∫ dia, 13h‚Äì22h) <span class="retencao-aviso retencao-25">25% reten√ß√£o</span></label>
                            <textarea id="parte2" placeholder="Descreva a parte 2 da tarefa. Use Enter para criar par√°grafos." rows="4" required maxlength="${CONFIG.MAX_PARTE_LEN}"></textarea>
                        </div>
                        <div>
                            <label for="parte3" class="block text-sm font-medium text-gray-700 mb-2">Parte 3 (14¬∫ dia, 13h‚Äì22h) <span class="retencao-aviso retencao-15">15% reten√ß√£o</span></label>
                            <textarea id="parte3" placeholder="Descreva a parte 3 da tarefa. Use Enter para criar par√°grafos." rows="4" required maxlength="${CONFIG.MAX_PARTE_LEN}"></textarea>
                        </div>
                        <div>
                            <label for="parte4" class="block text-sm font-medium text-gray-700 mb-2">Parte 4 (28¬∫ dia, 13h‚Äì22h) <span class="retencao-aviso retencao-10">9.99% reten√ß√£o</span></label>
                            <textarea id="parte4" placeholder="Descreva a parte 4 da tarefa. Use Enter para criar par√°grafos." rows="4" required maxlength="${CONFIG.MAX_PARTE_LEN}"></textarea>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex space-x-4">
                        <button onclick="${STATE.tarefaEditando ? 'atualizarTarefa()' : 'salvarTarefa()'}" class="btn-primario flex-1" id="btnSalvarTarefa">
                            ${STATE.tarefaEditando ? 'Atualizar Tarefa' : 'Salvar Tarefa'}
                        </button>
                        <button onclick="limparFormulario()" class="btn-secundario flex-1">
                            ${STATE.tarefaEditando ? 'Cancelar Edi√ß√£o' : 'Limpar'}
                        </button>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-2xl font-bold mb-4 text-red-700">Tarefas Criadas</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full compact-table">
                            <thead>
                                <tr>
                                    <th class="turma-column">Turma</th>
                                    <th>Tema</th>
                                    <th class="data-column">Data</th>
                                    <th class="acoes-column">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaTarefasBody">
                                <tr>
                                    <td colspan="4" class="text-center py-4 text-gray-500">Carregando tarefas...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;

        // Configurar checkboxes de turmas - VERS√ÉO 10.0: Checkboxes compactos em linha √∫nica
        document.getElementById('turmasCheckboxes').innerHTML = CONFIG.TURMAS.map(t => `
            <div class="checkbox-item">
                <input type="checkbox" value="${t}" class="turma-checkbox">
                <label>${t}</label>
            </div>
        `).join("");

        if (STATE.tarefaEditando) {
            preencherFormularioEdicao();
        }

        await carregarTarefasProfessor();
        
        CacheManager.set(cacheKey, UIManager.elements.contentArea.innerHTML, 2 * 60 * 1000);
    }

    function preencherFormularioEdicao() {
        if (!STATE.tarefaEditando) return;
        
        document.getElementById('titulo-formulario').textContent = 'Editar Tarefa';
        document.getElementById('tema').value = STATE.tarefaEditando.Tema;
        document.getElementById('dataAula').value = String(STATE.tarefaEditando.DataAula).split('T')[0];
        document.getElementById('parte1').value = STATE.tarefaEditando.Parte1 || '';
        document.getElementById('parte2').value = STATE.tarefaEditando.Parte2 || '';
        document.getElementById('parte3').value = STATE.tarefaEditando.Parte3 || '';
        document.getElementById('parte4').value = STATE.tarefaEditando.Parte4 || '';
        
        const checkboxes = document.querySelectorAll('#turmasCheckboxes input');
        checkboxes.forEach(checkbox => {
            checkbox.checked = checkbox.value === STATE.tarefaEditando.Turma;
        });
        
        window.scrollTo(0, 0);
    }

    async function carregarTarefasProfessor() {
        const tbody = document.getElementById('tabelaTarefasBody');
        
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center py-4 text-gray-500">
                    <div class="spinner"></div>
                    Carregando tarefas...
                </td>
            </tr>
        `;
        
        try {
            const response = await apiGet('getTarefas', {}, true);
            STATE.tarefas = response.data || [];
            CacheManager.remove('tarefas_professor_lista');
            CacheManager.set('tarefas_professor_lista', STATE.tarefas, 2 * 60 * 1000);
            renderizarTabelaTarefas();
        } catch (error) {
            tbody.innerHTML = 
                `<tr><td colspan="4" class="text-center py-4 text-red-500">Erro ao carregar tarefas: ${Utils.escapeHTML(error.message || String(error))}</td></tr>`;
        }
    }

    function renderizarTabelaTarefas() {
        const tbody = document.getElementById('tabelaTarefasBody');
        
        if (!STATE.tarefas || STATE.tarefas.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">Nenhuma tarefa criada</td></tr>`;
            return;
        }

        tbody.innerHTML = STATE.tarefas.map(tarefa => {
            return `
            <tr class="tarefa-item">
                <td class="turma-column">${Utils.escapeHTML(tarefa.Turma)}</td>
                <td class="px-4 py-2">
                    <div class="font-semibold text-gray-800 mb-2">${Utils.escapeHTML(tarefa.Tema)}</div>
                    <button class="tarefa-expand-button" onclick="togglePartesTarefa('${tarefa.ID}')">
                        Ver Partes
                    </button>
                    <div id="partes-${tarefa.ID}" class="tarefa-expand-content">
                        ${tarefa.Parte1 ? `<div class="text-sm text-gray-600 mb-1"><span class="font-medium">Parte 1:</span> <span class="conteudo-formatado">${Utils.formatarConteudoParaExibicao(String(tarefa.Parte1).substring(0, 100))}${String(tarefa.Parte1).length > 100 ? '...' : ''}</span></div>` : ''}
                        ${tarefa.Parte2 ? `<div class="text-sm text-gray-600 mb-1"><span class="font-medium">Parte 2:</span> <span class="conteudo-formatado">${Utils.formatarConteudoParaExibicao(String(tarefa.Parte2).substring(0, 100))}${String(tarefa.Parte2).length > 100 ? '...' : ''}</span></div>` : ''}
                        ${tarefa.Parte3 ? `<div class="text-sm text-gray-600 mb-1"><span class="font-medium">Parte 3:</span> <span class="conteudo-formatado">${Utils.formatarConteudoParaExibicao(String(tarefa.Parte3).substring(0, 100))}${String(tarefa.Parte3).length > 100 ? '...' : ''}</span></div>` : ''}
                        ${tarefa.Parte4 ? `<div class="text-sm text-gray-600"><span class="font-medium">Parte 4:</span> <span class="conteudo-formatado">${Utils.formatarConteudoParaExibicao(String(tarefa.Parte4).substring(0, 100))}${String(tarefa.Parte4).length > 100 ? '...' : ''}</span></div>` : ''}
                    </div>
                </td>
                <td class="data-column">${Utils.formatarData(tarefa.DataAula)}</td>
                <td class="acoes-column">
                    <div class="flex justify-center space-x-2">
                        <button onclick="editarTarefa('${tarefa.ID}')" class="btn-editar">
                            Editar
                        </button>
                        <button onclick="solicitarExclusaoTarefa('${tarefa.ID}')" class="btn-excluir">
                            Excluir
                        </button>
                    </div>
                </td>
            </tr>
            `;
        }).join('');
    }

    function togglePartesTarefa(idTarefa) {
        const elemento = document.getElementById(`partes-${idTarefa}`);
        elemento.classList.toggle('expandido');
    }

    const salvarTarefa = Utils.debounce(async function() {
        const btnSalvar = document.getElementById('btnSalvarTarefa');
        
        try {
            Utils.setButtonLoading(btnSalvar, true);
            
            const turmasSelecionadas = Array.from(document.querySelectorAll('#turmasCheckboxes input:checked'))
                .map(c => c.value);
            
            if (turmasSelecionadas.length === 0) {
                UIManager.showModal('Aten√ß√£o', 'Selecione pelo menos uma turma.');
                return;
            }

            const tema = document.getElementById('tema').value.trim();
            const dataAula = document.getElementById('dataAula').value;

            if (!tema || !dataAula) {
                UIManager.showModal('Aten√ß√£o', 'Preencha o tema e a data da aula.');
                return;
            }

            if (tema.length > CONFIG.MAX_TEMA_LEN) {
                UIManager.showModal('Aten√ß√£o', `O tema deve ter no m√°ximo ${CONFIG.MAX_TEMA_LEN} caracteres.`);
                return;
            }

            const parte1 = document.getElementById('parte1').value.trim();
            const parte2 = document.getElementById('parte2').value.trim();
            const parte3 = document.getElementById('parte3').value.trim();
            const parte4 = document.getElementById('parte4').value.trim();

            if (!parte1 || !parte2 || !parte3 || !parte4) {
                UIManager.showModal('Aten√ß√£o', 'Todas as partes da tarefa devem ser preenchidas.');
                return;
            }

            if ([parte1, parte2, parte3, parte4].some(p => p.length > CONFIG.MAX_PARTE_LEN)) {
                UIManager.showModal('Aten√ß√£o', `Cada parte deve ter no m√°ximo ${CONFIG.MAX_PARTE_LEN} caracteres.`);
                return;
            }

            const dados = {
                Turmas: turmasSelecionadas,
                Tema: Utils.sanitizeForSheet(tema),
                Parte1: Utils.sanitizeForSheet(parte1),
                Parte2: Utils.sanitizeForSheet(parte2),
                Parte3: Utils.sanitizeForSheet(parte3),
                Parte4: Utils.sanitizeForSheet(parte4),
                DataAula: dataAula,
                professor: Utils.sanitizeForSheet(STATE.usuarioLogado.NomeCompleto)
            };

            await apiPost('criarTarefa', dados);
            UIManager.showModal('Sucesso', 'Tarefa criada com sucesso!');
            
            CacheManager.remove('painel_professor');
            CacheManager.remove('tarefas_professor_lista');
            turmasSelecionadas.forEach(turma => {
                CacheManager.remove(`api_getTarefasPorTurma_${JSON.stringify({turma: turma})}`);
                CacheManager.remove(`relatorio_${turma}`);
            });
            
            limparFormulario();
            await carregarTarefasProfessor();
            
            document.querySelectorAll('.tarefa-item').forEach(item => {
                item.classList.add('tarefa-atualizada');
            });
            
        } catch (error) {
            UIManager.showModal('Erro', `Erro ao criar tarefa: ${error.message}`);
        } finally {
            Utils.setButtonLoading(btnSalvar, false);
        }
    }, 500);

    const atualizarTarefa = Utils.debounce(async function() {
        const btnSalvar = document.getElementById('btnSalvarTarefa');
        
        try {
            Utils.setButtonLoading(btnSalvar, true);
            
            if (!STATE.tarefaEditando) {
                UIManager.showModal('Erro', 'Nenhuma tarefa selecionada para edi√ß√£o.');
                return;
            }

            const tema = document.getElementById('tema').value.trim();
            const dataAula = document.getElementById('dataAula').value;
            const turmaSelecionada = Array.from(document.querySelectorAll('#turmasCheckboxes input:checked'))
                .map(c => c.value)[0];

            if (!tema || !dataAula || !turmaSelecionada) {
                UIManager.showModal('Aten√ß√£o', 'Preencha todos os campos obrigat√≥rios.');
                return;
            }

            if (tema.length > CONFIG.MAX_TEMA_LEN) {
                UIManager.showModal('Aten√ß√£o', `O tema deve ter no m√°ximo ${CONFIG.MAX_TEMA_LEN} caracteres.`);
                return;
            }

            const parte1 = document.getElementById('parte1').value.trim();
            const parte2 = document.getElementById('parte2').value.trim();
            const parte3 = document.getElementById('parte3').value.trim();
            const parte4 = document.getElementById('parte4').value.trim();

            if (!parte1 || !parte2 || !parte3 || !parte4) {
                UIManager.showModal('Aten√ß√£o', 'Todas as partes da tarefa devem ser preenchidas.');
                return;
            }

            if ([parte1, parte2, parte3, parte4].some(p => p.length > CONFIG.MAX_PARTE_LEN)) {
                UIManager.showModal('Aten√ß√£o', `Cada parte deve ter no m√°ximo ${CONFIG.MAX_PARTE_LEN} caracteres.`);
                return;
            }

            const dados = {
                ID: STATE.tarefaEditando.ID,
                Tema: Utils.sanitizeForSheet(tema),
                Parte1: Utils.sanitizeForSheet(parte1),
                Parte2: Utils.sanitizeForSheet(parte2),
                Parte3: Utils.sanitizeForSheet(parte3),
                Parte4: Utils.sanitizeForSheet(parte4),
                DataAula: dataAula
            };

            await apiPost('editarTarefa', dados);
            UIManager.showModal('Sucesso', 'Tarefa atualizada com sucesso!');
            
            CacheManager.remove('painel_professor');
            CacheManager.remove('tarefas_professor_lista');
            CacheManager.remove(`api_getTarefasPorTurma_${JSON.stringify({turma: turmaSelecionada})}`);
            CacheManager.remove(`relatorio_${turmaSelecionada}`);
            
            STATE.tarefaEditando = null;
            limparFormulario();
            await carregarTarefasProfessor();
            
        } catch (error) {
            UIManager.showModal('Erro', `Erro ao atualizar tarefa: ${error.message}`);
        } finally {
            Utils.setButtonLoading(btnSalvar, false);
        }
    }, 500);

    function solicitarExclusaoTarefa(idTarefa) {
        const tarefa = STATE.tarefas.find(t => t.ID === idTarefa);
        STATE.tarefaParaExcluir = idTarefa;
        UIManager.showConfirmModal(`Tem certeza que deseja excluir a tarefa "${tarefa?.Tema}" da turma ${tarefa?.Turma}?`, () => {
            excluirTarefa(idTarefa);
        });
    }

    async function editarTarefa(idTarefa) {
        const tarefa = STATE.tarefas.find(t => t.ID === idTarefa);
        if (!tarefa) {
            UIManager.showModal('Erro', 'Tarefa n√£o encontrada.');
            return;
        }

        STATE.tarefaEditando = tarefa;
        CacheManager.remove('painel_professor');
        CacheManager.remove('tarefas_professor_lista');
        await mostrarPainelProfessor();
    }

    async function excluirTarefa(idTarefa) {
        try {
            await apiPost('excluirTarefa', { ID: idTarefa });
            UIManager.showModal('Sucesso', 'Tarefa exclu√≠da com sucesso.');
            
            CacheManager.remove('painel_professor');
            CacheManager.remove('tarefas_professor_lista');
            CONFIG.TURMAS.forEach(turma => {
                CacheManager.remove(`api_getTarefasPorTurma_${JSON.stringify({turma: turma})}`);
                CacheManager.remove(`relatorio_${turma}`);
            });
            
            await carregarTarefasProfessor();
        } catch (error) {
            UIManager.showModal('Erro', `Erro ao excluir tarefa: ${error.message}`);
        }
    }

    function limparFormulario() {
        const temaEl = document.getElementById('tema');
        const dataEl = document.getElementById('dataAula');
        const p1 = document.getElementById('parte1');
        const p2 = document.getElementById('parte2');
        const p3 = document.getElementById('parte3');
        const p4 = document.getElementById('parte4');
        if (temaEl) temaEl.value = '';
        if (dataEl) dataEl.value = '';
        if (p1) p1.value = '';
        if (p2) p2.value = '';
        if (p3) p3.value = '';
        if (p4) p4.value = '';
        document.querySelectorAll('#turmasCheckboxes input:checked').forEach(c => c.checked = false);
        
        if (STATE.tarefaEditando) {
            STATE.tarefaEditando = null;
            document.getElementById('titulo-formulario').textContent = 'Criar Nova Tarefa';
            const btn = document.getElementById('btnSalvarTarefa');
            btn.textContent = 'Salvar Tarefa';
            btn.setAttribute('onclick', 'salvarTarefa()');
        }
    }

    // ==================== PAINEL DO ALUNO ====================
    async function mostrarPainelAluno() {
        const cacheKey = `painel_aluno_${STATE.usuarioLogado.RM}`;
        const cached = CacheManager.get(cacheKey);
        
        if (cached) {
            UIManager.elements.contentArea.innerHTML = cached;
            TimeManager.iniciarAtualizacaoContadores();
            return;
        }
        
        UIManager.elements.contentArea.innerHTML = `
            <div id="painelAluno" class="space-y-6">
                <div class="card p-6">
                    <h3 class="text-2xl font-bold text-red-700 mb-4">Minhas Tarefas</h3>
                    
                    <div class="instrucoes-box">
                        <div class="instrucoes-title">Instru√ß√µes para entrega:</div>
                        <ol class="instrucoes-list">
                            <li>Realize as atividades em folhas e as guarde com cuidado para serem entregues futuramente.</li>
                            <li>Tire uma foto, converta o arquivo em PDF, suba no seu OneDrive com o e-mail do SESI, compartilhe o link publicamente e o copie.</li>
                            <li>Cole no espa√ßo indicado dentro do prazo estabelecido e salve para validar sua nota.</li>
                        </ol>
                    </div>
                    
                    <div id="tarefas-aluno-container">
                        <div class="text-center py-8">
                            <div class="spinner"></div>
                            <p class="mt-4 text-gray-600">Carregando tarefas...</p>
                        </div>
                    </div>
                    
                    <div class="aluno-relatorio-card" onclick="toggleRelatorioAluno()">
                        <div class="aluno-relatorio-header">
                            <h4 class="font-semibold text-red-700">Meu Desempenho</h4>
                            <svg class="expand-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="m6 9 6 6 6-6"/>
                            </svg>
                        </div>
                        <div class="aluno-relatorio-content" id="relatorio-aluno-content">
                            <div class="text-center py-4">
                                <div class="spinner"></div>
                                <p class="mt-2 text-gray-600">Carregando relat√≥rio...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fundamento-cientifico">
                        <div class="fundamento-title" onclick="toggleFundamentoCientifico()">
                            <span>Fundamentos Cient√≠ficos da Aprendizagem</span>
                            <svg class="expand-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="m6 9 6 6 6-6"/>
                            </svg>
                        </div>
                        <div class="fundamento-content" id="conteudo-fundamento">
                            <p class="mb-4">A curva de esquecimento de Ebbinghaus e os estudos modernos de neuroaprendizagem mostram que:</p>
                            <ol class="fundamento-list">
                                <li>O c√©rebro consolida melhor a mem√≥ria entre 6h e 9h ap√≥s o aprendizado inicial.</li>
                                <li>O sono tem papel essencial ‚Äî √© durante o sono que ocorre a consolida√ß√£o sin√°ptica (transformar mem√≥rias de curto em longo prazo).</li>
                                <li>A aten√ß√£o sustentada √© m√°xima no per√≠odo entre 8h e 11h da manh√£ e tem uma segunda faixa √≥tima entre 17h e 20h.</li>
                                <li>√Ä noite, atividades reflexivas e criativas t√™m melhor rendimento, porque o c√≥rtex pr√©-frontal est√° menos sobrecarregado de est√≠mulos novos.</li>
                                <li>Sono de 7h a 9h por noite.</li>
                                <li>Evitar telas nos 30 min antes de dormir.</li>
                                <li>Fazer revis√£o leve antes do sono.</li>
                            </ol>
                            
                            <div class="flex justify-center my-4">
                                <img src="https://blog-static.infra.grancursosonline.com.br/wp-content/uploads/2017/01/curva-do-esquecimento-1.png" 
                                     alt="Curva do Esquecimento de Ebbinghaus" 
                                     class="imagem-curva">
                            </div>
                            
                            <div class="referencias">
                                <div class="referencias-title">Refer√™ncias:</div>
                                <ul class="referencias-list">
                                    <li>EBBINGHAUS, Hermann. Memory: A Contribution to Experimental Psychology. 1913.</li>
                                    <li>DUNLOSKY, John et al. Improving Students' Learning with Effective Learning Techniques. 2013.</li>
                                    <li>WALKER, Matthew. Why We Sleep. 2018.</li>
                                    <li>BLOOM, Benjamin S. Taxonomy of Educational Objectives. 1956.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        await carregarTarefasAluno();
        TimeManager.iniciarAtualizacaoContadores();
        
        CacheManager.set(cacheKey, UIManager.elements.contentArea.innerHTML, 2 * 60 * 1000);
    }

    function toggleRelatorioAluno() {
        const conteudo = document.getElementById('relatorio-aluno-content');
        const icon = document.querySelector('.aluno-relatorio-card .expand-icon');
        
        conteudo.classList.toggle('expandido');
        icon.classList.toggle('expandido');
        
        if (conteudo.classList.contains('expandido')) {
            carregarRelatorioAluno();
        }
    }

    function toggleFundamentoCientifico() {
        const conteudo = document.getElementById('conteudo-fundamento');
        const icon = document.querySelector('.fundamento-cientifico .expand-icon');
        
        conteudo.classList.toggle('expandido');
        icon.classList.toggle('expandido');
    }

    async function carregarTarefasAluno() {
        const cacheKey = `tarefas_aluno_${STATE.usuarioLogado.RM}_dados`;
        const cached = CacheManager.get(cacheKey);
        
        if (cached) {
            renderTarefasAlunoFromCache(cached.tarefas, cached.entregas);
            return;
        }

        mostrarLoadingTarefasAluno();
        
        try {
            const response = await apiGet('getTarefasPorTurma', { turma: STATE.usuarioLogado.Turma }, true);
            const container = document.getElementById('tarefas-aluno-container');
            
            if (!response.data || response.data.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">Nenhuma tarefa dispon√≠vel para sua turma.</div>';
                CacheManager.set(cacheKey, {tarefas: [], entregas: []}, 2 * 60 * 1000);
                return;
            }

            let entregas = [];
            try {
                const entregasResponse = await apiGet('getEntregasAluno', { rm: STATE.usuarioLogado.RM }, true);
                entregas = entregasResponse.data || [];
            } catch (error) {
                console.warn('Erro ao carregar entregas do aluno (n√£o cr√≠tico):', error);
            }

            CacheManager.set(cacheKey, {tarefas: response.data, entregas: entregas}, 2 * 60 * 1000);
            
            renderTarefasAlunoGradualmente(response.data, entregas, container);
            
        } catch (error) {
            document.getElementById('tarefas-aluno-container').innerHTML = 
                `<div class="text-center text-red-500 py-8">Erro ao carregar tarefas: ${Utils.escapeHTML(error.message || String(error))}</div>`;
        }
    }

    function mostrarLoadingTarefasAluno() {
        const container = document.getElementById('tarefas-aluno-container');
        if (!container) return;
        
        container.innerHTML = `
            <div class="text-center py-8">
                <div class="spinner"></div>
                <p class="mt-4 text-gray-600">Carregando tarefas...</p>
            </div>
        `;
    }

    function renderTarefasAlunoFromCache(tarefasLocal, entregas) {
        const container = document.getElementById('tarefas-aluno-container');
        container.innerHTML = '';
        
        if (!tarefasLocal || tarefasLocal.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-8">Nenhuma tarefa dispon√≠vel para sua turma.</div>';
            return;
        }

        container.innerHTML = tarefasLocal.map(tarefa => {
            const contadores = TimeManager.calcularContadoresOtimizado(tarefa.DataAula);
            const entrega = entregas.find(e => e.ID_Tarefa === tarefa.ID);

            return renderTarefaItem(tarefa, entrega, contadores);
        }).join('');
    }

    async function renderTarefasAlunoGradualmente(tarefasLocal, entregas, container) {
        container.innerHTML = '';
        
        for (let i = 0; i < tarefasLocal.length; i++) {
            if (i % 2 === 0 && i > 0) {
                await new Promise(resolve => setTimeout(resolve, 0));
            }
            
            const tarefa = tarefasLocal[i];
            const entrega = entregas.find(e => e.ID_Tarefa === tarefa.ID);
            const contadores = TimeManager.calcularContadoresOtimizado(tarefa.DataAula);
            
            const tarefaHTML = renderTarefaItem(tarefa, entrega, contadores);
            container.innerHTML += tarefaHTML;
        }
        
        atualizarContadoresAluno();
    }

    function renderTarefaItem(tarefa, entrega, contadores) {
        const parte1 = tarefa.Parte1 || '';
        const parte2 = tarefa.Parte2 || '';
        const parte3 = tarefa.Parte3 || '';
        const parte4 = tarefa.Parte4 || '';

        return `
        <div class="border border-gray-200 rounded-lg p-4 mb-4">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h4 class="font-semibold text-lg text-gray-800">${Utils.escapeHTML(tarefa.Tema)}</h4>
                    <p class="text-sm text-gray-600 mt-1">Data da aula: ${Utils.formatarData(tarefa.DataAula)}</p>
                    ${entrega && entrega.Nota ? `<p class="text-sm font-semibold text-green-600 mt-1">Nota: ${entrega.Nota}</p>` : ''}
                    
                    ${parte1 ? renderParteTarefa(tarefa.ID, 1, parte1, contadores.parte1, entrega) : ''}
                    ${parte2 ? renderParteTarefa(tarefa.ID, 2, parte2, contadores.parte2, entrega) : ''}
                    ${parte3 ? renderParteTarefa(tarefa.ID, 3, parte3, contadores.parte3, entrega) : ''}
                    ${parte4 ? renderParteTarefa(tarefa.ID, 4, parte4, contadores.parte4, entrega) : ''}
                </div>
            </div>
        </div>
        `;
    }

    function renderParteTarefa(idTarefa, numeroParte, conteudo, contador, entrega) {
        const linkSalvo = entrega ? entrega[`Link${numeroParte}`] : '';
        const inputId = `link-${idTarefa}-${numeroParte}`;
        const temLinkSalvo = linkSalvo && String(linkSalvo).trim() !== '';
        
        const disponivel = contador.liberada && !contador.expirado && !temLinkSalvo;
        const expirado = contador.expirado;
        
        let retencaoAviso = '';
        if (numeroParte === 1) retencaoAviso = '<span class="retencao-aviso retencao-50">50% reten√ß√£o</span>';
        else if (numeroParte === 2) retencaoAviso = '<span class="retencao-aviso retencao-25">25% reten√ß√£o</span>';
        else if (numeroParte === 3) retencaoAviso = '<span class="retencao-aviso retencao-15">15% reten√ß√£o</span>';
        else if (numeroParte === 4) retencaoAviso = '<span class="retencao-aviso retencao-10">9.99% reten√ß√£o</span>';

        let horarioInfo = '';
        if (contador.liberada && !expirado) {
            horarioInfo = '<div class="horario-info horario-maxima">Entrega dispon√≠vel hoje das 13h √†s 22h.</div>';
        } else if (!contador.liberada && !expirado) {
            horarioInfo = '<div class="horario-info horario-fora">Conte√∫do e entrega dispon√≠veis apenas em seu dia espec√≠fico, das 13h √†s 22h.</div>';
        } else if (expirado) {
            horarioInfo = '<div class="horario-info horario-fora">Prazo de entrega desta parte j√° expirou.</div>';
        }

        if (!contador.liberada && !expirado) {
            return `
            <div class="mt-3 p-3 bg-gray-50 rounded border parte-${numeroParte}">
                <div class="flex justify-between items-center">
                    <strong>Parte ${numeroParte}: ${retencaoAviso}</strong>
                    <span class="contador ${contador.classe}">${contador.texto}</span>
                </div>
                ${horarioInfo}
            </div>`;
        }

        const conteudoFormatado = Utils.formatarConteudoParaExibicao(conteudo);
        
        const mostrarLinkSalvo = temLinkSalvo;
        
        return `
        <div class="mt-3 p-3 bg-gray-50 rounded border parte-${numeroParte}">
            <div class="flex justify-between items-center">
                <strong>Parte ${numeroParte}: ${retencaoAviso}</strong>
                <span class="contador ${contador.classe}">${contador.texto}</span>
            </div>
            <div class="conteudo-formatado">${conteudoFormatado}</div>
            ${horarioInfo}
            <div class="link-container">
                <input type="text" 
                       class="link-input ${mostrarLinkSalvo ? 'link-salvo' : ''}" 
                       placeholder="${!contador.liberada ? 'Atividade n√£o enviada' : (expirado ? 'Prazo expirado' : 'Cole o link da atividade aqui')}" 
                       id="${inputId}"
                       value="${linkSalvo || ''}"
                       ${mostrarLinkSalvo || !disponivel ? 'disabled' : ''}>
                ${!mostrarLinkSalvo ? `
                    <button class="btn-primario btn-link btn-salvar" 
                            onclick="salvarLink('${idTarefa}', ${numeroParte})"
                            ${!disponivel ? 'disabled' : ''}>
                        Salvar
                    </button>
                ` : ''}
                <button class="btn-secundario btn-link btn-excluir" 
                        onclick="excluirLink('${idTarefa}', ${numeroParte})"
                        ${!mostrarLinkSalvo ? 'disabled' : ''}>
                    Excluir
                </button>
            </div>
            ${mostrarLinkSalvo ? '<p class="text-green-600 text-sm mt-1">‚úì Link salvo com sucesso</p>' : ''}
        </div>`;
    }

    const salvarLink = Utils.debounce(async function(idTarefa, parte) {
        const input = document.getElementById(`link-${idTarefa}-${parte}`);
        const link = input ? input.value.trim() : '';
        const btnSalvar = document.querySelector(`button[onclick="salvarLink('${idTarefa}', ${parte})"]`);

        if (!link) {
            UIManager.showModal('Aten√ß√£o', 'Por favor, cole um link v√°lido.');
            return;
        }

        try {
            // Adicionar loading ao bot√£o
            if (btnSalvar) {
                Utils.setButtonLoading(btnSalvar, true);
            }

            await apiPost('entregarTarefa', {
                ID_Tarefa: idTarefa,
                RM_Aluno: STATE.usuarioLogado.RM,
                NomeAluno: Utils.sanitizeForSheet(STATE.usuarioLogado.NomeCompleto),
                Turma: STATE.usuarioLogado.Turma,
                Parte: parte,
                [`Link${parte}`]: Utils.sanitizeForSheet(link)
            });
            
            UIManager.showModal('Sucesso', `Link da parte ${parte} salvo com sucesso!`);
            
            CacheManager.remove(`painel_aluno_${STATE.usuarioLogado.RM}`);
            CacheManager.remove(`tarefas_aluno_${STATE.usuarioLogado.RM}_dados`);
            CacheManager.remove(`relatorio_aluno_${STATE.usuarioLogado.RM}`);
            CacheManager.remove(`api_getEntregasAluno_${JSON.stringify({rm: STATE.usuarioLogado.RM})}`);
            CacheManager.remove(`relatorio_${STATE.usuarioLogado.Turma}`);
            
            await carregarTarefasAluno();
        } catch (error) {
            const msg = error.message || String(error);
            if (msg.includes('Fora do per√≠odo de entrega')) {
                UIManager.showModal(
                    'Fora do hor√°rio de entrega',
                    'Essa parte s√≥ pode ser entregue no dia espec√≠fico dela, entre 13h e 22h. Verifique o cronograma na descri√ß√£o da tarefa.'
                );
            } else if (msg.includes('Muitas')) {
                UIManager.showModal(
                    'Limite de requisi√ß√µes excedido',
                    'Voc√™ fez muitas entregas em pouco tempo. Aguarde alguns minutos e tente novamente.'
                );
            } else {
                UIManager.showModal('Erro', `Erro ao salvar link: ${msg}`);
            }
        } finally {
            // Remover loading do bot√£o
            if (btnSalvar) {
                Utils.setButtonLoading(btnSalvar, false);
            }
        }
    }, 500);

    const excluirLink = Utils.debounce(async function(idTarefa, parte) {
        const btnExcluir = document.querySelector(`button[onclick="excluirLink('${idTarefa}', ${parte})"]`);
        
        try {
            // Adicionar loading ao bot√£o
            if (btnExcluir) {
                Utils.setButtonLoading(btnExcluir, true);
            }
            
            await apiPost('excluirEntrega', {
                ID_Tarefa: idTarefa,
                RM_Aluno: STATE.usuarioLogado.RM,
                Parte: parte
            });
            
            UIManager.showModal('Sucesso', `Link da parte ${parte} exclu√≠do com sucesso! A nota desta parte foi zerada.`);
            
            CacheManager.remove(`painel_aluno_${STATE.usuarioLogado.RM}`);
            CacheManager.remove(`tarefas_aluno_${STATE.usuarioLogado.RM}_dados`);
            CacheManager.remove(`relatorio_aluno_${STATE.usuarioLogado.RM}`);
            CacheManager.remove(`api_getEntregasAluno_${JSON.stringify({rm: STATE.usuarioLogado.RM})}`);
            CacheManager.remove(`relatorio_${STATE.usuarioLogado.Turma}`);
            
            // Recarregar as tarefas para habilitar o campo novamente
            await carregarTarefasAluno();
        } catch (error) {
            UIManager.showModal('Erro', `Erro ao excluir link: ${error.message}`);
        } finally {
            // Remover loading do bot√£o
            if (btnExcluir) {
                Utils.setButtonLoading(btnExcluir, false);
            }
        }
    }, 500);

    function atualizarContadoresAluno() {
        const containers = document.querySelectorAll('#tarefas-aluno-container > div');
        
        containers.forEach(container => {
            const tema = container.querySelector('h4')?.textContent;
            if (!tema) return;
            
            const tarefa = STATE.tarefas.find(t => t.Tema === tema);
            if (tarefa) {
                const contadores = TimeManager.calcularContadoresOtimizado(tarefa.DataAula);
                
                [1, 2, 3, 4].forEach(parte => {
                    const contadorElement = container.querySelector(`.parte-${parte} .contador`);
                    if (contadorElement) {
                        const contador = contadores[`parte${parte}`];
                        if (contadorElement.textContent !== contador.texto) {
                            contadorElement.textContent = contador.texto;
                            contadorElement.className = `contador ${contador.classe}`;
                        }
                    }
                });
            }
        });
    }

    // ==================== RELAT√ìRIOS ====================
    async function carregarRelatorioAluno() {
        const container = document.getElementById('relatorio-aluno-content');
        
        try {
            const entregasResponse = await apiGet('getEntregasAluno', { rm: STATE.usuarioLogado.RM }, true);
            const entregas = entregasResponse.data || [];
            
            let relatorioHTML = '';
            
            if (entregas.length === 0) {
                relatorioHTML = `
                    <p class="text-gray-500 text-center py-4">Nenhuma entrega registrada.</p>
                `;
            } else {
                const tarefasResponse = await apiGet('getTarefas', {}, true);
                const todasTarefas = tarefasResponse.data || [];
                
                let notaTotal = 0;
                let countEntregas = 0;
                
                relatorioHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full compact-table">
                            <thead>
                                <tr>
                                    <th>Tarefa</th>
                                    <th>Links Entregues</th>
                                    <th class="data-column">Data de Submiss√£o</th>
                                    <th class="data-column">Nota</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                entregas.forEach(entrega => {
                    let tarefa = todasTarefas.find(t => t.ID === entrega.ID_Tarefa);
                    const temaTarefa = tarefa ? tarefa.Tema : `Tarefa (ID: ${entrega.ID_Tarefa})`;
                    
                    const linksEntregues = [];
                    if (entrega.Link1) linksEntregues.push('Parte 1');
                    if (entrega.Link2) linksEntregues.push('Parte 2');
                    if (entrega.Link3) linksEntregues.push('Parte 3');
                    if (entrega.Link4) linksEntregues.push('Parte 4');
                    
                    const notaEntrega = parseFloat(entrega.Nota) || 0;
                    if (notaEntrega > 0) {
                        notaTotal += notaEntrega;
                        countEntregas++;
                    }
                    
                    relatorioHTML += `
                        <tr>
                            <td>${Utils.escapeHTML(temaTarefa)}</td>
                            <td>${linksEntregues.join(', ') || 'Nenhum'}</td>
                            <td class="data-column">${Utils.formatarData(entrega.DataSubmissao)}</td>
                            <td class="data-column font-semibold">${notaEntrega.toFixed(1)}</td>
                        </tr>
                    `;
                });
                
                const media = countEntregas > 0 ? (notaTotal / countEntregas).toFixed(1) : '0.0';
                
                relatorioHTML += `
                            </tbody>
                        </table>
                        <div class="mt-4 p-3 bg-gray-50 rounded border">
                            <div class="flex justify-between items-center">
                                <span class="font-semibold">M√©dia Geral:</span>
                                <span class="text-lg font-bold ${parseFloat(media) >= 7.5 ? 'text-green-600' : 'text-red-600'}">${media}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = relatorioHTML;
        } catch (error) {
            container.innerHTML = `<p class="text-red-500 text-center py-4">Erro ao carregar relat√≥rio: ${Utils.escapeHTML(error.message)}</p>`;
        }
    }

    async function mostrarRelatorioProfessor() {
        UIManager.elements.contentArea.innerHTML = `
            <div class="card p-6">
                <h3 class="text-2xl font-bold text-red-700 mb-4">Relat√≥rio por Turma</h3>
                <div class="turmas-container">
                    <div class="turmas-buttons">
                        ${CONFIG.TURMAS.map(turma => `
                            <button onclick="carregarRelatorioTurma('${turma}')" class="btn-turma-compact" id="btn-turma-${turma}">
                                ${turma}
                            </button>
                        `).join('')}
                    </div>
                    <div class="export-buttons-container">
                        <button onclick="exportarParaExcel(window.turmaSelecionada)" class="btn-exportar" id="btn-excel">
                            Exportar Excel
                        </button>
                        <button onclick="exportarParaPDF(window.turmaSelecionada)" class="btn-exportar" id="btn-pdf">
                            Exportar PDF
                        </button>
                    </div>
                </div>
                <div id="relatorio-turma-container" class="mt-4">
                    <p class="text-gray-500 text-center py-8">Selecione uma turma para visualizar o relat√≥rio</p>
                </div>
                <div class="mt-4 text-center">
                    <button onclick="mostrarPainelProfessor()" class="btn-secundario">Voltar ao Painel</button>
                </div>
            </div>
        `;
        
        window.turmaSelecionada = null;
    }

    async function carregarRelatorioTurma(turma) {
        document.querySelectorAll('.btn-turma-compact').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(`btn-turma-${turma}`).classList.add('active');
        
        window.turmaSelecionada = turma;
        
        CacheManager.remove(`relatorio_${turma}`);
        
        document.getElementById('relatorio-turma-container').innerHTML = `
            <div class="text-center py-8">
                <div class="spinner"></div>
                <p class="mt-4 text-gray-600">Carregando relat√≥rio da turma ${Utils.escapeHTML(turma)}...</p>
            </div>
        `;
        
        try {
            const [usersResponse, tarefasResponse] = await Promise.all([
                apiGet('getUsers', {}, true),
                apiGet('getTarefasPorTurma', { turma: turma }, true)
            ]);
            
            const alunosTurma = (usersResponse.data || usersResponse).filter(user => 
                user.Turma === turma && user.Perfil === 'Aluno'
            ).sort((a, b) => {
                const numA = parseInt(a.Numero) || 999;
                const numB = parseInt(b.Numero) || 999;
                return numA - numB;
            });
            
            const tarefasTurma = tarefasResponse.data || [];
            
            const todasEntregas = await apiGet('getEntregas', {}, true);
            const entregasTurma = (todasEntregas.data || todasEntregas).filter(entrega => 
                entrega.Turma === turma
            );
            
            let relatorioTurmaHTML = `
                <div class="relatorio-header">
                    <h4 class="text-lg font-semibold text-red-700">Relat√≥rio da Turma ${Utils.escapeHTML(turma)}</h4>
                </div>
                <div class="relatorio-status" id="carregamento-status">
                    <div class="spinner"></div>
                    Carregando dados da turma...
                </div>
                <div class="relatorio-info">
                    Total de alunos: ${alunosTurma.length} | Total de tarefas: ${tarefasTurma.length} | Total de entregas: ${entregasTurma.length} | √öltima atualiza√ß√£o em ${new Date().toLocaleDateString()} √†s ${new Date().toLocaleTimeString()}
                </div>
            `;
            
            if (alunosTurma.length === 0) {
                relatorioTurmaHTML += `
                    <div class="text-center py-8">
                        <p class="text-gray-500 mb-4">Nenhum aluno encontrado na turma ${Utils.escapeHTML(turma)}.</p>
                        <p class="text-sm text-gray-400">Verifique se a turma est√° correta e se os alunos est√£o cadastrados na planilha USERS.</p>
                    </div>
                `;
            } else if (tarefasTurma.length === 0) {
                relatorioTurmaHTML += `
                    <div class="text-center py-8">
                        <p class="text-gray-500 mb-4">Nenhuma tarefa encontrada para a turma ${Utils.escapeHTML(turma)}.</p>
                        <p class="text-sm text-gray-400">Crie tarefas para esta turma no painel principal.</p>
                    </div>
                `;
            } else {
                relatorioTurmaHTML += `
                    <div class="overflow-x-auto border rounded-lg mt-4">
                        <table class="min-w-full compact-table table-header-white" id="tabela-relatorio">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 text-center font-semibold border-b numero-coluna" rowspan="2">N¬∫</th>
                                    <th class="px-4 py-3 text-left font-semibold border-b" rowspan="2">Aluno</th>
                                    <th class="px-4 py-3 text-center font-semibold border-b media-coluna" rowspan="2">M√©dia</th>
                `;
                
                tarefasTurma.forEach(tarefa => {
                    relatorioTurmaHTML += `
                        <th class="px-2 py-3 text-center font-semibold border-b header-tarefa tarefa-group" colspan="5">
                            ${Utils.escapeHTML(tarefa.Tema)}
                        </th>
                    `;
                });
                
                relatorioTurmaHTML += `</tr><tr>`;
                
                tarefasTurma.forEach(() => {
                    relatorioTurmaHTML += `
                        <th class="px-1 py-2 text-center border-b subheader-tarefa parte-column">P1</th>
                        <th class="px-1 py-2 text-center border-b subheader-tarefa parte-column">P2</th>
                        <th class="px-1 py-2 text-center border-b subheader-tarefa parte-column">P3</th>
                        <th class="px-1 py-2 text-center border-b subheader-tarefa parte-column">P4</th>
                        <th class="px-1 py-2 text-center border-b subheader-tarefa media-tarefa-column">Total</th>
                    `;
                });
                
                relatorioTurmaHTML += `
                                </tr>
                            </thead>
                            <tbody id="relatorio-tbody">
                `;
                
                alunosTurma.forEach((aluno, index) => {
                    relatorioTurmaHTML += `
                        <tr class="aluno-loading">
                            <td class="px-4 py-3 text-center border-b numero-coluna">${aluno.Numero || (index + 1)}</td>
                            <td class="px-4 py-3 font-medium text-gray-900 border-b">${Utils.escapeHTML(aluno.NomeCompleto)}</td>
                            <td class="px-4 py-3 text-center border-b media-coluna"><div class="nota-loading"></div></td>
                    `;
                    
                    tarefasTurma.forEach(() => {
                        for (let i = 0; i < 5; i++) {
                            relatorioTurmaHTML += `<td class="px-1 py-3 text-center border-b"><div class="nota-loading"></div></td>`;
                        }
                    });
                    
                    relatorioTurmaHTML += `</tr>`;
                });
                
                relatorioTurmaHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            document.getElementById('relatorio-turma-container').innerHTML = relatorioTurmaHTML;
            
            if (alunosTurma.length === 0 || tarefasTurma.length === 0) {
                document.getElementById('carregamento-status').innerHTML = 'Relat√≥rio completo!';
                document.getElementById('carregamento-status').className = 'relatorio-status bg-green-50 text-green-700 border-l-green-500';
                return;
            }
            
            const carregamentoStatus = document.getElementById('carregamento-status');
            const tbody = document.getElementById('relatorio-tbody');
            
            let alunosProcessados = 0;
            
            for (let i = 0; i < alunosTurma.length; i++) {
                const aluno = alunosTurma[i];
                const linha = tbody.rows[i];
                
                if (linha) {
                    let totalNotasTodasTarefas = 0;
                    let countNotasTodasTarefas = 0;
                    
                    for (let j = 0; j < tarefasTurma.length; j++) {
                        const tarefa = tarefasTurma[j];
                        const entrega = entregasTurma.find(e => 
                            e.RM_Aluno === aluno.RM && e.ID_Tarefa === tarefa.ID
                        );
                        
                        let totalNotasTarefa = 0;
                        let countNotasTarefa = 0;
                        
                        for (let parte = 1; parte <= 4; parte++) {
                            // CORRE√á√ÉO VERS√ÉO 10.0: Buscar nota da parte espec√≠fica corretamente
                            let notaParte = 0;
                            if (entrega) {
                                // Acessar diretamente a propriedade NotaParteX
                                const notaProp = `NotaParte${parte}`;
                                notaParte = parseFloat(entrega[notaProp]) || 0;
                                
                                // Se n√£o h√° nota espec√≠fica mas h√° link, considerar 2.5 (nota padr√£o para entrega sem corre√ß√£o)
                                if (notaParte === 0 && entrega[`Link${parte}`]) {
                                    notaParte = 2.5;
                                }
                            }
                            
                            const colunaParte = 3 + (j * 5) + (parte - 1);
                            
                            let classeNota = 'text-gray-600';
                            if (notaParte > 0) {
                                if (notaParte >= 2.5) {
                                    classeNota = 'text-green-600 font-semibold';
                                } else {
                                    classeNota = 'text-red-600';
                                }
                            }
                            
                            linha.cells[colunaParte].innerHTML = `<span class="${classeNota}">${notaParte > 0 ? notaParte.toFixed(1) : '-'}</span>`;
                            
                            if (notaParte > 0) {
                                totalNotasTarefa += notaParte;
                                countNotasTarefa++;
                                totalNotasTodasTarefas += notaParte;
                                countNotasTodasTarefas++;
                            }
                        }
                        
                        const totalTarefa = countNotasTarefa > 0 ? totalNotasTarefa.toFixed(1) : '-';
                        const colunaTotalTarefa = 3 + (j * 5) + 4;
                        
                        let classeTotalTarefa = 'text-gray-600';
                        if (totalTarefa !== '-') {
                            const totalNum = parseFloat(totalTarefa);
                            if (totalNum >= 7.5) {
                                classeTotalTarefa = 'text-green-600 font-bold';
                            } else if (totalNum > 0) {
                                classeTotalTarefa = 'text-red-600 font-semibold';
                            }
                        }
                        
                        linha.cells[colunaTotalTarefa].innerHTML = `<span class="${classeTotalTarefa}">${totalTarefa}</span>`;
                    }
                    
                    const mediaGeral = countNotasTodasTarefas > 0 ? (totalNotasTodasTarefas / countNotasTodasTarefas).toFixed(1) : '-';
                    let classeMediaGeral = 'text-gray-600';
                    if (mediaGeral !== '-') {
                        const mediaNum = parseFloat(mediaGeral);
                        if (mediaNum >= 7.5) {
                            classeMediaGeral = 'text-green-600 font-bold';
                        } else {
                            classeMediaGeral = 'text-red-600 font-semibold';
                        }
                    }
                    
                    linha.cells[2].innerHTML = `<span class="${classeMediaGeral}">${mediaGeral}</span>`;
                    linha.classList.remove('aluno-loading');
                    
                    alunosProcessados++;
                    carregamentoStatus.innerHTML = `<div class="spinner"></div> Processando aluno ${alunosProcessados} de ${alunosTurma.length}...`;
                    
                    if (i % 3 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }
                }
            }
            
            carregamentoStatus.innerHTML = 'Relat√≥rio completo!';
            carregamentoStatus.className = 'relatorio-status bg-green-50 text-green-700 border-l-green-500';
            
            const relatorioCompletoHTML = document.getElementById('relatorio-turma-container').innerHTML;
            CacheManager.set(`relatorio_${turma}`, relatorioCompletoHTML, 10 * 60 * 1000);
            
        } catch (error) {
            console.error('Erro ao carregar relat√≥rio:', error);
            document.getElementById('relatorio-turma-container').innerHTML = `
                <div class="text-center py-8">
                    <p class="text-red-500">Erro ao carregar relat√≥rio: ${Utils.escapeHTML(error.message || String(error))}</p>
                    <button onclick="carregarRelatorioTurma('${turma}')" class="btn-secundario mt-4">
                        Tentar Novamente
                    </button>
                </div>
            `;
        }
    }

    function exportarParaExcel(turma) {
        if (!turma) {
            UIManager.showModal('Aten√ß√£o', 'Selecione uma turma primeiro.');
            return;
        }
        
        try {
            const table = document.getElementById('tabela-relatorio');
            if (!table) {
                UIManager.showModal('Erro', 'Tabela n√£o encontrada para exporta√ß√£o.');
                return;
            }

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.table_to_sheet(table);
            XLSX.utils.book_append_sheet(wb, ws, `Turma ${turma}`);
            XLSX.writeFile(wb, `relatorio_turma_${turma}.xlsx`);
        } catch (error) {
            UIManager.showModal('Erro', `Erro ao exportar para Excel: ${error.message}`);
        }
    }

    function exportarParaPDF(turma) {
        if (!turma) {
            UIManager.showModal('Aten√ß√£o', 'Selecione uma turma primeiro.');
            return;
        }
        
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(16);
            doc.text(`Relat√≥rio da Turma ${turma}`, 14, 15);

            doc.setFontSize(10);
            doc.text(`Emitido em: ${new Date().toLocaleDateString()}`, 14, 22);

            const table = document.getElementById('tabela-relatorio');
            doc.autoTable({
                html: table,
                startY: 30,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [204, 0, 0] }
            });

            doc.save(`relatorio_turma_${turma}.pdf`);
        } catch (error) {
            UIManager.showModal('Erro', `Erro ao exportar para PDF: ${error.message}`);
        }
    }

    // ==================== PAINEL DE DIAGN√ìSTICO ====================
    async function mostrarPainelDiagnostico() {
        const metricas = PerformanceMonitor.getMetrics();
        const cacheStats = CacheManager.getStats();
        
        UIManager.elements.contentArea.innerHTML = `
            <div class="card p-6">
                <h3 class="text-2xl font-bold text-red-700 mb-4">Painel de Diagn√≥stico</h3>
                
                <div class="diagnostico-grid">
                    ${Components.metricasPerformance()}
                    
                    <div class="diagnostico-card">
                        <h4 class="font-semibold mb-3">Teste de Conex√£o</h4>
                        <button onclick="testarConexaoCompleta()" class="btn-primario w-full mb-3">Testar Conex√£o Completa</button>
                        <div id="resultado-conexao"></div>
                    </div>
                    
                    <div class="diagnostico-card">
                        <h4 class="font-semibold mb-3">Status do Cache</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Itens em Cache:</span>
                                <span class="font-semibold">${cacheStats.count}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Tamanho do Cache:</span>
                                <span class="font-semibold">${cacheStats.size}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Efici√™ncia do Cache:</span>
                                <span class="font-semibold ${parseFloat(cacheStats.efficiency) > 70 ? 'text-green-600' : 'text-yellow-600'}">${cacheStats.efficiency}</span>
                            </div>
                        </div>
                        <button onclick="limparCache()" class="btn-primario w-full mt-3" style="background-color: #ef4444;">Limpar Cache</button>
                    </div>
                    
                    <div class="diagnostico-card">
                        <h4 class="font-semibold mb-3">Estat√≠sticas do Sistema</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Usu√°rios Carregados:</span>
                                <span class="font-semibold">${STATE.usuarios.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Tarefas Carregadas:</span>
                                <span class="font-semibold">${STATE.tarefas.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Chamadas API:</span>
                                <span class="font-semibold">${metricas.apiCalls}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Tempo Total:</span>
                                <span class="font-semibold">${metricas.totalTime}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="diagnostico-card">
                        <h4 class="font-semibold mb-3">Verificar Problemas de Notas</h4>
                        <button onclick="verificarProblemasNotas()" class="btn-primario w-full mb-3">Verificar Notas</button>
                        <div id="resultado-verificacao-notas"></div>
                    </div>
                </div>
                
                <div class="mt-6 text-center">
                    <button onclick="mostrarPainelProfessor()" class="btn-secundario">Voltar ao Painel</button>
                </div>
            </div>
        `;
    }

    async function verificarProblemasNotas() {
        const resultado = document.getElementById('resultado-verificacao-notas');
        resultado.innerHTML = UIManager.renderLoading('Verificando problemas de notas...');
        
        try {
            const [entregasResponse, tarefasResponse] = await Promise.all([
                apiGet('getEntregas', {}, true),
                apiGet('getTarefas', {}, true)
            ]);

            const entregas = entregasResponse.data || entregasResponse;
            const tarefas = tarefasResponse.data || tarefasResponse;

            let problemas = [];
            
            // Verificar entregas sem notas
            const entregasSemNota = entregas.filter(e => !e.Nota || e.Nota === '0' || e.Nota === '');
            if (entregasSemNota.length > 0) {
                problemas.push(`- ${entregasSemNota.length} entregas sem nota registrada`);
            }
            
            // Verificar tarefas sem entregas
            const tarefasSemEntregas = tarefas.filter(t => {
                return !entregas.some(e => e.ID_Tarefa === t.ID);
            });
            
            if (tarefasSemEntregas.length > 0) {
                problemas.push(`- ${tarefasSemEntregas.length} tarefas sem nenhuma entrega`);
            }
            
            if (problemas.length === 0) {
                resultado.innerHTML = `
                    <div class="test-result test-success">
                        <strong>‚úì Nenhum problema encontrado!</strong><br>
                        - Total de entregas: ${entregas.length}<br>
                        - Total de tarefas: ${tarefas.length}<br>
                        - Status: Sistema funcionando corretamente
                    </div>
                `;
            } else {
                resultado.innerHTML = `
                    <div class="test-result test-warning">
                        <strong>‚ö† Poss√≠veis problemas encontrados:</strong><br>
                        ${problemas.join('<br>')}
                    </div>
                `;
            }
        } catch (error) {
            resultado.innerHTML = `<div class="test-result test-error">Erro: ${error.message}</div>`;
        }
    }

    async function mostrarMetricasPerformance() {
        const container = document.getElementById('metricas-performance');
        container.innerHTML = UIManager.renderLoading('Coletando m√©tricas...');
        
        const [metricas, performanceAPI] = await Promise.all([
            PerformanceMonitor.getMetrics(),
            PerformanceMonitor.testApiPerformance()
        ]);
        
        container.innerHTML = `
            <div class="space-y-3 text-sm">
                <div class="flex justify-between">
                    <span>Tempo API:</span>
                    <span class="font-semibold ${performanceAPI.status === '√ìtimo' ? 'text-green-600' : performanceAPI.status === 'Bom' ? 'text-yellow-600' : 'text-red-600'}">
                        ${performanceAPI.tempo}
                    </span>
                </div>
                <div class="flex justify-between">
                    <span>Status API:</span>
                    <span class="font-semibold">${performanceAPI.status}</span>
                </div>
                <div class="flex justify-between">
                    <span>Chamadas API:</span>
                    <span class="font-semibold">${metricas.apiCalls}</span>
                </div>
                ${metricas.memory ? `
                <div class="flex justify-between">
                    <span>Mem√≥ria Usada:</span>
                    <span class="font-semibold">${metricas.memory.used}</span>
                </div>
                <div class="flex justify-between">
                    <span>Mem√≥ria Total:</span>
                    <span class="font-semibold">${metricas.memory.total}</span>
                </div>
                ` : ''}
            </div>
            
            <div class="mt-4 p-3 bg-blue-50 rounded border border-blue-200">
                <h5 class="font-semibold text-blue-800 mb-2">Recomenda√ß√µes:</h5>
                <ul class="text-xs text-blue-700 space-y-1">
                    ${parseFloat(metricas.cache.efficiency) < 50 ? '<li>‚Ä¢ Cache com baixa efici√™ncia - considere reduzir TTL</li>' : ''}
                    ${performanceAPI.status === 'Lento' ? '<li>‚Ä¢ API lenta - verifique conex√£o ou otimize requisi√ß√µes</li>' : ''}
                    ${metricas.cache.count > 20 ? '<li>‚Ä¢ Muitos itens em cache - considere limpeza peri√≥dica</li>' : ''}
                </ul>
            </div>
        `;
    }

    async function testarConexaoCompleta() {
        const resultado = document.getElementById('resultado-conexao');
        resultado.innerHTML = UIManager.renderLoading('Testando conex√£o...');
        
        try {
            const [usersResponse, tarefasResponse] = await Promise.all([
                apiGet('getUsers', {}, true),
                apiGet('getTarefas', {}, true)
            ]);

            const users = usersResponse.data || usersResponse;
            const tarefas = tarefasResponse.data || tarefasResponse;

            resultado.innerHTML = `
                <div class="test-result test-success">
                    <strong>‚úì Conex√£o bem-sucedida!</strong><br>
                    - Usu√°rios: ${users.length} registros<br>
                    - Tarefas: ${tarefas.length} registros<br>
                    - Status: Operacional com seguran√ßa v10.0
                </div>
            `;
        } catch (error) {
            resultado.innerHTML = `
                <div class="test-result test-error">
                    <strong>‚úó Erro na conex√£o:</strong> ${Utils.escapeHTML(error.message)}
                </div>
            `;
        }
    }

    function limparCache() {
        CacheManager.clear();
        UIManager.showModal('Sucesso', 'Cache limpo com sucesso!');
        setTimeout(() => {
            mostrarPainelDiagnostico();
        }, 1000);
    }

    // ==================== INICIALIZA√á√ÉO ====================
    document.addEventListener('DOMContentLoaded', init);

    // ==================== EXPORTA√á√ÉO DE FUN√á√ïES GLOBAIS ====================
    window.logout = function() {
        AuthManager.logout();
    };

    window.closeModal = function() {
        UIManager.closeModal();
    };

    window.toggleRmVisibility = toggleRmVisibility;
    window.mostrarPainelDiagnostico = mostrarPainelDiagnostico;
    window.mostrarMetricasPerformance = mostrarMetricasPerformance;
    window.testarConexaoCompleta = testarConexaoCompleta;
    window.limparCache = limparCache;
    window.mostrarPainelProfessor = mostrarPainelProfessor;
    window.mostrarPainelAluno = mostrarPainelAluno;
    window.mostrarRelatorioProfessor = mostrarRelatorioProfessor;
    window.carregarRelatorioAluno = carregarRelatorioAluno;
    window.toggleRelatorioAluno = toggleRelatorioAluno;
    window.salvarTarefa = salvarTarefa;
    window.atualizarTarefa = atualizarTarefa;
    window.excluirTarefa = excluirTarefa;
    window.solicitarExclusaoTarefa = solicitarExclusaoTarefa;
    window.editarTarefa = editarTarefa;
    window.limparFormulario = limparFormulario;
    window.salvarLink = salvarLink;
    window.excluirLink = excluirLink;
    window.toggleFundamentoCientifico = toggleFundamentoCientifico;
    window.exportarParaExcel = exportarParaExcel;
    window.exportarParaPDF = exportarParaPDF;
    window.carregarRelatorioTurma = carregarRelatorioTurma;
    window.togglePartesTarefa = togglePartesTarefa;
    window.verificarProblemasNotas = verificarProblemasNotas;
    </script>
</body>
</html>
